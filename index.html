<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Omniverse: Mobile Chaos</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Orbitron:wght@500;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
    :root { --primary: #00f3ff; --danger: #ff0044; --warn: #ffcc00; }
    
    /* CORE RESET */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
        margin: 0; padding: 0; overflow: hidden; background: #000;
        font-family: 'Orbitron', sans-serif;
        /* PREVENT SCROLLING/ZOOMING ON MOBILE */
        touch-action: none; 
        width: 100vw; height: 100vh;
        display: flex; justify-content: center; align-items: center;
    }

    /* GAME CONTAINER - FITS SCREEN EXACTLY */
    #game-wrap {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #000;
    }
    
    canvas { display: block; width: 100%; height: 100%; }
    
    /* HUD UI */
    #ui-layer {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        pointer-events: none; padding: 15px;
        display: flex; flex-direction: column; justify-content: space-between; 
        z-index: 10;
    }
    .hud-top { display: flex; justify-content: space-between; width: 100%; }
    
    .stat-panel { 
        background: rgba(0,0,0,0.5); padding: 8px 12px; 
        border: 1px solid #444; border-radius: 6px;
        color: white; font-size: 14px;
        backdrop-filter: blur(2px);
    }
    .hearts { color: var(--danger); letter-spacing: 2px; font-size: 1.2rem; }
    
    /* BARS */
    .bar-box { margin-top: 4px; }
    .bar-label { font-size: 10px; color: #ccc; }
    .bar-bg { width: 100px; height: 6px; background: #333; border: 1px solid #666; }
    .bar-fill { height: 100%; transition: width 0.1s; }

    /* MENUS */
    #overlay {
        position: absolute; inset: 0; background: rgba(0,0,0,0.92);
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        text-align: center; pointer-events: auto; z-index: 50;
        transition: opacity 0.3s;
    }
    h1 { 
        font-family: 'Black Ops One'; font-size: 3rem; color: white; margin: 0 0 10px 0;
        text-shadow: 0 0 20px var(--primary);
    }
    
    /* LEVEL SELECTOR */
    .level-row { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center; }
    .lvl-btn {
        background: transparent; border: 1px solid #666; color: #888;
        padding: 10px 15px; font-family: 'Orbitron'; font-weight: bold; font-size: 1rem;
    }
    .lvl-btn.selected { background: var(--primary); color: black; border-color: var(--primary); box-shadow: 0 0 15px var(--primary); }

    .start-btn {
        padding: 15px 40px; font-size: 1.5rem; font-family: 'Black Ops One';
        background: var(--danger); color: white; border: none; 
        clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
        animation: pulse 1.5s infinite;
    }
    @keyframes pulse { 0%{transform:scale(1);} 50%{transform:scale(1.05);} 100%{transform:scale(1);} }

    .hidden { opacity: 0; pointer-events: none; }

    /* MOBILE CONTROLS - FIXED & VISIBLE */
    #mobile-controls {
        position: absolute; bottom: 0; left: 0; width: 100%; height: 100%;
        pointer-events: none; z-index: 20;
        display: none; /* Hidden on PC default, shown via JS */
    }
    
    .touch-zone {
        position: absolute; bottom: 20px; pointer-events: auto;
        display: flex; gap: 15px;
    }
    .zone-left { left: 20px; align-items: flex-end; }
    .zone-right { right: 20px; align-items: flex-end; }

    .t-btn {
        width: 70px; height: 70px; border-radius: 50%;
        background: rgba(255, 255, 255, 0.15); 
        border: 2px solid rgba(255,255,255,0.3);
        color: white; font-size: 28px; font-weight: bold;
        display: flex; justify-content: center; align-items: center;
        backdrop-filter: blur(4px); box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }
    .t-btn:active { background: rgba(0, 243, 255, 0.4); transform: scale(0.9); border-color: var(--primary); }
    
    .btn-fire { border-color: var(--danger); color: var(--danger); width: 65px; height: 65px; margin-bottom: 20px; margin-right: 10px; }
    .btn-jump { border-color: var(--primary); color: var(--primary); width: 85px; height: 85px; }

</style>
</head>
<body>

<div id="game-wrap">
    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div class="hud-top">
            <div class="stat-panel">
                <div class="hearts" id="hp-disp">‚ù§‚ù§‚ù§</div>
                <div>SCORE: <span id="sc-disp" style="color:var(--primary)">0</span></div>
            </div>
            <div class="stat-panel" style="text-align: right;">
                <div class="bar-box">
                    <div class="bar-label">PLASMA</div>
                    <div class="bar-bg"><div id="ammo-fill" class="bar-fill" style="background:var(--warn)"></div></div>
                </div>
                <div class="bar-box">
                    <div class="bar-label">FUEL</div>
                    <div class="bar-bg"><div id="fuel-fill" class="bar-fill" style="background:var(--primary)"></div></div>
                </div>
            </div>
        </div>
    </div>

    <div id="mobile-controls">
        <div class="touch-zone zone-left">
            <div class="t-btn" id="btn-left">‚Üê</div>
            <div class="t-btn" id="btn-right">‚Üí</div>
        </div>
        <div class="touch-zone zone-right">
            <div class="t-btn btn-fire" id="btn-fire">üî•</div>
            <div class="t-btn btn-jump" id="btn-jump">üöÄ</div>
        </div>
    </div>

    <div id="overlay">
        <h1>OMNIVERSE</h1>
        <p style="color:#aaa; font-size:0.9rem; margin-bottom:15px;">CHAOS EDITION</p>
        
        <div class="level-row">
            <button class="lvl-btn" onclick="setLevel(1)">LVL 1</button>
            <button class="lvl-btn" onclick="setLevel(2)">LVL 2</button>
            <button class="lvl-btn selected" onclick="setLevel(3)">LVL 3</button>
            <button class="lvl-btn" onclick="setLevel(4)">LVL 4</button>
            <button class="lvl-btn" onclick="setLevel(5)">LVL 5</button>
        </div>

        <div style="display:flex; gap:15px;">
            <button class="start-btn" onclick="startGame(false)">PC PLAY</button>
            <button class="start-btn" style="background:var(--warn); color:black;" onclick="startGame(true)">MOBILE</button>
        </div>
        
        <p style="margin-top:20px; color:#666; font-size:0.7rem;">LANDSCAPE MODE RECOMMENDED</p>
    </div>
</div>

<script>
/** * AUDIO ENGINE 
 */
class AudioSys {
    constructor() { this.ctx = new (window.AudioContext||window.webkitAudioContext)(); this.on = false; }
    init() { if(this.ctx.state==='suspended') this.ctx.resume(); this.on=true; }
    play(t) {
        if(!this.on) return;
        const o=this.ctx.createOscillator(), g=this.ctx.createGain();
        o.connect(g); g.connect(this.ctx.destination);
        const n=this.ctx.currentTime;
        if(t==='jump'){
            o.frequency.setValueAtTime(150,n); o.frequency.linearRampToValueAtTime(300,n+0.1);
            g.gain.setValueAtTime(0.1,n); g.gain.linearRampToValueAtTime(0,n+0.1);
            o.start(n); o.stop(n+0.1);
        } else if(t==='shoot'){
            o.type='square'; o.frequency.setValueAtTime(800,n); o.frequency.exponentialRampToValueAtTime(100,n+0.1);
            g.gain.setValueAtTime(0.05,n); g.gain.linearRampToValueAtTime(0,n+0.1);
            o.start(n); o.stop(n+0.1);
        } else if(t==='boom'){
            o.type='sawtooth'; o.frequency.setValueAtTime(100,n); o.frequency.exponentialRampToValueAtTime(10,n+0.3);
            g.gain.setValueAtTime(0.2,n); g.gain.linearRampToValueAtTime(0,n+0.3);
            o.start(n); o.stop(n+0.3);
        }
    }
}
const sfx = new AudioSys();

/** * ENGINE & CONFIG
 */
const c = document.getElementById('gameCanvas');
const ctx = c.getContext('2d');

// DYNAMIC RESIZING for Mobile
function resize() {
    c.width = window.innerWidth;
    c.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

// CONSTANTS
const GRAVITY = 0.6;
let GROUND_Y = c.height - 80; // Calculated dynamically in loop if needed, but fixed mostly

const THEMES = [
    { id: "earth", sky: ["#87CEEB", "#E0F7FA"], ground: "#228B22", color: "#333", hazard: 0, banner: "hollywood" },
    { id: "mars", sky: ["#5D0000", "#200000"], ground: "#8B4513", color: "#00ffcc", hazard: 0, banner: "rocket_banner" },
    { id: "matrix", sky: ["#000000", "#002200"], ground: "#004400", color: "#fff", hazard: 0.03, banner: "glitch" },
    { id: "neon", sky: ["#2c003e", "#000"], ground: "#ff00ff", color: "#ffff00", hazard: 0, banner: "billboard" }
];

let game = {
    run: false, paused: false, frame: 0, score: 0, level: 3, speed: 6,
    themeIdx: 0, themeTime: 0, bannerDone: false,
    ents: [], bullets: [], parts: [], bg: [],
    mobile: false
};

let startLvl = 3;
let animId;
let input = {l:false, r:false, u:false};

function setLevel(n) {
    startLevel = n;
    document.querySelectorAll('.lvl-btn').forEach((b,i) => b.classList.toggle('selected', i+1===n));
}

/** * PARALLAX & DECOR 
 */
class BgObj {
    constructor(layer, type, x, y) {
        this.layer=layer; this.type=type; this.x=x; this.y=y; this.dead=false;
        this.scale = 0.5 + Math.random();
        // 0=Far, 1=Mid, 2=Near
        this.spd = layer===0 ? 0.05 : (layer===1 ? 0.2 : 0.8);
    }
    update() { this.x -= game.speed * this.spd; if(this.x < -600) this.dead=true; }
    draw(t) {
        if(this.type==="banner") { this.drawBanner(t); return; }
        
        if(t.id==="earth") {
            if(this.type==="cloud") {
                ctx.fillStyle="rgba(255,255,255,0.5)"; 
                ctx.beginPath(); ctx.arc(this.x,this.y,30*this.scale,0,7); ctx.fill();
                ctx.beginPath(); ctx.arc(this.x+30,this.y-10,40*this.scale,0,7); ctx.fill();
            } else if(this.type==="mnt") {
                // GROUNDED MOUNTAIN FIX
                let h = 150*this.scale; let w = 300*this.scale;
                let bottom = c.height; // Screen bottom
                ctx.fillStyle="#2d3e2d";
                ctx.beginPath(); 
                ctx.moveTo(this.x, bottom); 
                ctx.lineTo(this.x, GROUND_Y); 
                ctx.lineTo(this.x+w/2, GROUND_Y-h); 
                ctx.lineTo(this.x+w, GROUND_Y); 
                ctx.lineTo(this.x+w, bottom); 
                ctx.fill();
                // Snow
                ctx.fillStyle="#fff"; ctx.beginPath(); ctx.moveTo(this.x+w/2-20*this.scale, GROUND_Y-h+30*this.scale); ctx.lineTo(this.x+w/2, GROUND_Y-h); ctx.lineTo(this.x+w/2+20*this.scale, GROUND_Y-h+30*this.scale); ctx.fill();
            }
        } 
        else if(t.id==="mars") {
            // MOONS ONLY - NO CLOUDS
            if(this.type==="moon") {
                ctx.fillStyle="#8a7b7b"; ctx.beginPath();
                let r=(Math.random()>.5)?15:8; r*=this.scale;
                ctx.arc(this.x,this.y,r,0,7); ctx.fill(); // Simple asteroid shape
            }
        }
        else if(t.id==="neon") {
            if(this.type==="car") { ctx.fillStyle="#0ff"; ctx.fillRect(this.x,this.y,40,10); }
        }
    }
    
    drawBanner(t) {
        ctx.save(); ctx.translate(this.x, this.y);
        if(t.banner==="hollywood") {
            // Grounded Hill
            ctx.fillStyle="#2e3b2e"; ctx.beginPath(); ctx.moveTo(-100, c.height); ctx.lineTo(-50,100); ctx.lineTo(150,-50); ctx.lineTo(350,100); ctx.lineTo(450,c.height); ctx.fill();
            ctx.fillStyle="#fff"; ctx.font="900 40px Arial"; let s="ABHIK DUTTA";
            for(let i=0;i<s.length;i++) ctx.fillText(s[i],i*25,Math.sin(i)*5);
        } 
        else if(t.banner==="rocket_banner") {
            // ROCKET AT FRONT (Leading)
            ctx.fillStyle="#f00"; ctx.beginPath(); ctx.moveTo(-60,-10); ctx.lineTo(-90,0); ctx.lineTo(-60,10); ctx.fill(); // Nose left
            ctx.fillStyle="#ccc"; ctx.beginPath(); ctx.ellipse(-40,0,30,10,0,0,7); ctx.fill();
            ctx.strokeStyle="#fff"; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(-10,0); ctx.lineTo(10,0); ctx.stroke();
            ctx.fillStyle="#fff"; ctx.fillRect(10,-20,250,40);
            ctx.fillStyle="#000"; ctx.font="bold 24px Arial"; ctx.fillText("ABHIK DUTTA",20,10);
        }
        else if(t.banner==="glitch") {
            ctx.fillStyle="#0f0"; ctx.font="bold 40px monospace"; ctx.fillText("ADMIN: ABHIK", (Math.random()-.5)*5, 0);
        }
        else if(t.banner==="billboard") {
            ctx.strokeStyle="#0ff"; ctx.lineWidth=3; ctx.strokeRect(0,0,300,60);
            ctx.fillStyle="#f0f"; ctx.font="italic bold 30px Arial"; ctx.fillText("ABHIK DUTTA", 20, 40);
        }
        ctx.restore();
    }
}

/** * GAMEPLAY CLASSES 
 */
class Player {
    constructor() {
        this.w=40; this.h=40; this.x=80; this.y=GROUND_Y-40; this.dy=0;
        this.hp=3; this.fuel=100; this.ammo=10; this.ground=true; this.jumps=0; this.inv=0; this.leg=0;
    }
    upd() {
        if(input.l && this.x>10) this.x-=5;
        if(input.r && this.x<c.width/2) this.x+=5;
        
        // Jetpack
        if(input.u && this.dy>-5 && this.fuel>0 && !this.ground) {
            this.dy-=0.8; this.fuel-=1.0; 
            spawnPart(this.x+10,this.y+40,2,'#0ff',0,4);
        }

        this.dy+=GRAVITY; this.y+=this.dy;
        
        // Ground Collision
        GROUND_Y = c.height - 80; // Re-calc for resize safety
        if(this.y+this.h > GROUND_Y) {
            this.y=GROUND_Y-this.h; this.dy=0; this.ground=true; this.jumps=0;
            if(this.fuel<100) this.fuel+=2;
        } else this.ground=false;

        if(this.ammo<10 && game.frame%60===0) this.ammo++;
        if(this.inv>0) this.inv--;
        
        // UI
        document.getElementById('fuel-fill').style.width=this.fuel+"%";
        document.getElementById('ammo-fill').style.width=(this.ammo*10)+"%";
    }
    jump() {
        if(this.ground) { this.dy=JUMP_FORCE; this.ground=false; this.jumps=1; sfx.play('jump'); }
        else if(this.jumps<2) { this.dy=JUMP_FORCE; this.jumps++; spawnPart(this.x+20,this.y+40,10,'#0ff',0,2); sfx.play('jump'); }
    }
    drw() {
        if(this.inv>0 && Math.floor(game.frame/5)%2) return;
        ctx.save(); ctx.translate(this.x,this.y);
        this.leg = this.ground ? this.leg+0.3 : 0.5;
        ctx.fillStyle="#777"; 
        ctx.fillRect(10,40,8,15+Math.sin(this.leg)*10); 
        ctx.fillRect(24,40,8,15+Math.sin(this.leg+Math.PI)*10);
        ctx.fillStyle="#fff"; ctx.fillRect(0,0,40,40); // Body
        ctx.fillStyle="#000"; ctx.fillRect(20,10,15,8); // Eye
        ctx.fillStyle="#333"; ctx.fillRect(35,25,12,6); // Gun
        ctx.restore();
    }
    hit(d) {
        if(this.inv>0)return; this.hp-=d; this.inv=60; 
        document.getElementById('hp-disp').innerText="‚ù§".repeat(this.hp);
        sfx.play('boom');
        if(this.hp<=0) gameOver();
    }
}

class Enemy {
    constructor(t,x,y) {
        this.t=t; this.x=x; this.y=y; this.w=40; this.h=40; this.hp=1; this.dead=false; 
        this.ty = y; this.anim=0;
        
        if(t==='dragon') { this.w=70; this.h=40; this.hp=2; this.ty=100; }
        if(t==='traitor') { this.fired=false; }
        if(t==='drone') { this.h=60; this.w=20; }
    }
    upd() {
        let spd = game.speed * 0.6; // Slower enemies
        
        // MOVEMENT LOGIC
        if(this.t === 'dragon') {
            if(this.hp===1) { spd*=0.5; this.y+=2; spawnPart(this.x+30,this.y,1,'#555',-1,-1); } // Injured
            else {
                // Swoop Logic
                if(Math.abs(this.y - this.ty) < 10) {
                    if(Math.random()<0.5) this.ty = GROUND_Y - this.h; // Swoop Ground
                    else this.ty = 50 + Math.random()*150; // Fly High
                }
                if(this.y < this.ty) this.y+=2; else this.y-=2;
            }
        } 
        else if(this.t === 'alien' || this.t === 'drone') {
            if(Math.abs(this.y - this.ty) < 10) this.ty = 50 + Math.random()*(GROUND_Y-80);
            if(this.y < this.ty) this.y+=1.5; else this.y-=1.5;
        }

        this.x -= spd; this.anim+=0.1;
        if(this.y+this.h > GROUND_Y) this.y=GROUND_Y-this.h;
        if(this.y < 20) this.y=20;

        // TRAITOR BACKFIRE (Slow Rocket)
        if(this.t==='traitor' && !this.fired && this.x < player.x - 50) {
            this.fired=true;
            // Spawn Rocket chasing player (Low speed = lingers on screen)
            game.bullets.push({x:this.x+this.w, y:this.y+10, vx:4, t:'rocket', dead:false});
            sfx.play('shoot');
        }

        if(this.x < -100) this.dead=true;
    }
    drw() {
        let th = THEMES[game.themeIdx];
        if(this.t==='dragon') {
            ctx.fillStyle = (this.hp===1)?"#500":"#900"; 
            ctx.beginPath(); ctx.ellipse(this.x+35,this.y+20,35,15,0,0,7); ctx.fill();
            ctx.fillStyle = (this.hp===1)?"#722":"#f44"; 
            let wy = Math.sin(this.anim)*25;
            ctx.beginPath(); ctx.moveTo(this.x+40,this.y+10); ctx.lineTo(this.x+20,this.y-20+wy); ctx.lineTo(this.x+60,this.y-20+wy); ctx.fill();
        } else if(this.t==='alien') {
            ctx.fillStyle="rgba(0,255,255,0.6)"; ctx.beginPath(); ctx.arc(this.x+20,this.y+10,15,Math.PI,0); ctx.fill();
            ctx.fillStyle="#888"; ctx.beginPath(); ctx.ellipse(this.x+20,this.y+25,25,10,0,0,7); ctx.fill();
        } else if(this.t==='traitor') {
            ctx.fillStyle="#333"; ctx.fillRect(this.x,this.y,40,40);
            ctx.fillStyle="#f00"; ctx.font="10px Arial"; ctx.fillText("TNT",this.x+10,this.y+20);
        } else if(this.t==='drone') {
            ctx.fillStyle="#f0f"; ctx.fillRect(this.x,this.y,20,60);
        } else {
            ctx.fillStyle=th.color; ctx.fillRect(this.x,this.y,40,40); // Goon
        }
    }
}

let player = new Player();

function spawnPart(x,y,n,c,vx,vy) { 
    for(let i=0;i<n;i++) game.parts.push({x:x,y:y,c:c,vx:vx||(Math.random()-.5)*5,vy:vy||(Math.random()-.5)*5,life:1}); 
}

/** LOOP */
function loop() {
    if(!game.run || game.paused) return;
    animId = requestAnimationFrame(loop);
    game.frame++; game.score++;
    document.getElementById('sc-disp').innerText = game.score;

    // THEME & BG
    if(++game.themeTime > 1200) { 
        game.themeTime=0; game.themeIdx=(game.themeIdx+1)%THEMES.length; game.bannerDone=false; 
    }
    if(!game.bannerDone && game.themeTime===100) {
        game.bg.push(new BgObj(1, "banner", c.width+100, 150)); game.bannerDone=true;
    }
    
    // BG Spawner
    let r = Math.random(); let tid = THEMES[game.themeIdx].id;
    if(tid==='earth') {
        if(r<0.015) game.bg.push(new BgObj(1, "mnt", c.width, 200));
        if(r<0.01) game.bg.push(new BgObj(0, "cloud", c.width, 80));
    }
    if(tid==='mars' && r<0.01) game.bg.push(new BgObj(0, "moon", c.width, 50));
    if(tid==='neon' && r<0.02) game.bg.push(new BgObj(0, "car", c.width, 100));

    // Enemy Spawner
    let rate = Math.max(30, 90 - (game.level*10));
    if(game.frame > 100 && game.frame % rate === 0) {
        let rnd = Math.random();
        if(Math.random() < THEMES[game.themeIdx].hazard) game.ents.push(new Enemy('buggy', c.width, GROUND_Y-40));
        else if(game.level===1) game.ents.push(new Enemy('goon', c.width, GROUND_Y-40));
        else {
            if(rnd<0.25) game.ents.push(new Enemy('dragon', c.width, 100));
            else if(rnd<0.4) game.ents.push(new Enemy('alien', c.width, 200));
            else if(rnd<0.6) game.ents.push(new Enemy('drone', c.width, 150));
            else if(rnd<0.8) game.ents.push(new Enemy('traitor', c.width, GROUND_Y-40));
            else game.ents.push(new Enemy('goon', c.width, GROUND_Y-40));
        }
    }

    // DRAW BG
    let t = THEMES[game.themeIdx];
    let gr = ctx.createLinearGradient(0,0,0,c.height); gr.addColorStop(0,t.sky[0]); gr.addColorStop(1,t.sky[1]);
    ctx.fillStyle=gr; ctx.fillRect(0,0,c.width,c.height);
    
    game.bg.forEach((b,i) => { b.update(); b.draw(t); if(b.dead) game.bg.splice(i,1); });
    
    ctx.fillStyle=t.ground; ctx.fillRect(0,GROUND_Y,c.width,c.height-GROUND_Y);
    ctx.strokeStyle="rgba(255,255,255,0.3)"; ctx.beginPath(); ctx.moveTo(0,GROUND_Y); ctx.lineTo(c.width,GROUND_Y); ctx.stroke();

    player.upd(); player.drw();

    // BULLETS
    game.bullets.forEach((b,i) => {
        b.x+=b.vx; 
        if(b.t==='rocket') {
            // Rocket Visuals
            ctx.fillStyle="#f40"; ctx.beginPath(); ctx.arc(b.x,b.y,8,0,7); ctx.fill();
            if(game.frame%3===0) spawnPart(b.x-10,b.y,1,"#ccc",-1,0); // Smoke trail
            // Hit Player (From behind or front)
            if(b.x > player.x && b.x < player.x+player.w && b.y > player.y && b.y < player.y+player.h) {
                player.hit(1); b.dead=true; spawnPart(b.x,b.y,10,'#f00',0,0);
            }
        } else {
            // Player Plasma
            ctx.fillStyle="#0ff"; ctx.fillRect(b.x,b.y,10,5);
            game.ents.forEach(e => {
                if(!e.dead && b.x>e.x && b.x<e.x+e.w && b.y>e.y && b.y<e.y+e.h) {
                    b.dead=true; 
                    if(e.t==='dragon' && e.hp>1) { 
                        e.hp--; sfx.play('boom'); spawnPart(e.x,e.y,5,'#500',0,0); 
                    } else {
                        e.hp--; sfx.play('boom'); 
                        if(e.hp<=0) { e.dead=true; game.score+=50; spawnPart(e.x,e.y,20,'#f00',0,0); }
                    }
                }
            });
        }
        if(b.x>c.width+100 || b.x<-100) b.dead=true; 
        if(b.dead) game.bullets.splice(i,1);
    });

    // ENTS
    game.ents.forEach((e,i) => {
        e.upd(); e.drw();
        if(!e.dead && player.x < e.x+e.w-10 && player.x+player.w > e.x+10 && player.y < e.y+e.h-10 && player.y+player.h > e.y+10) {
            player.hit(1); e.dead=true; spawnPart(e.x,e.y,20,'#f00',0,0);
        }
        if(e.dead) game.ents.splice(i,1);
    });

    // PARTS
    game.parts.forEach((p,i) => {
        p.x+=p.vx; p.y+=p.vy; p.life-=0.05; 
        ctx.globalAlpha=p.life; ctx.fillStyle=p.c; ctx.fillRect(p.x,p.y,4,4); ctx.globalAlpha=1;
        if(p.life<=0) game.parts.splice(i,1);
    });
}

/** SETUP */
function startGame(mob) {
    sfx.init();
    if(animId) cancelAnimationFrame(animId);
    game.mobile = mob;
    game.level = startLvl; game.speed = 3 + (game.level*0.8);
    player = new Player();
    game.run=true; game.paused=false; game.score=0; game.frame=1; game.themeIdx=0; 
    game.ents=[]; game.bullets=[]; game.parts=[]; game.bg=[];
    
    document.getElementById('overlay').classList.add('hidden');
    if(mob) document.getElementById('mobile-controls').style.display='block';
    
    document.getElementById('hp-disp').innerText="‚ù§‚ù§‚ù§";
    loop();
}

function gameOver() {
    game.run=false; 
    document.querySelector('#overlay h1').innerHTML="GAME OVER"; 
    document.getElementById('overlay').classList.remove('hidden');
    document.getElementById('mobile-controls').style.display='none';
    sfx.play('boom');
}

// INPUTS
const fire = () => { if(game.run && !game.paused && player.ammo>0) { player.ammo--; game.bullets.push({x:player.x+50,y:player.y+26,vx:12,t:'plasma',dead:false}); sfx.play('shoot'); } };
const jump = () => { if(game.run && !game.paused) { input.u=true; player.jump(); } };

// Key Listeners
window.onkeydown = e => {
    if(e.code==='KeyP' && game.run) { game.paused=!game.paused; if(!game.paused) loop(); }
    if(e.code==='KeyF') fire();
    if(e.code==='ArrowLeft') input.l=true; if(e.code==='ArrowRight') input.r=true;
    if(e.code==='Space'||e.code==='ArrowUp') { e.preventDefault(); jump(); }
};
window.onkeyup = e => { 
    if(e.code==='ArrowLeft') input.l=false; 
    if(e.code==='ArrowRight') input.r=false; 
    if(e.code==='Space'||e.code==='ArrowUp') input.u=false; 
};

// Touch Listeners
const btns = { 'btn-left':'l', 'btn-right':'r', 'btn-jump':'u', 'btn-fire':'f' };
for(let id in btns) {
    let el = document.getElementById(id);
    el.addEventListener('touchstart', (e) => { 
        e.preventDefault(); 
        if(btns[id]==='f') fire(); 
        else if(btns[id]==='u') jump(); 
        else input[btns[id]]=true; 
    }, {passive:false});
    el.addEventListener('touchend', (e) => { 
        e.preventDefault(); 
        if(btns[id]!=='f') input[btns[id]]=false; 
    }, {passive:false});
}

</script>
</body>
</html>
