<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Omniverse: Abhik's Final Cut</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Orbitron:wght@500;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
    :root { --primary: #00f3ff; --danger: #ff0044; --warn: #ffcc00; }
    body {
        margin: 0; overflow: hidden; background: #000;
        font-family: 'Orbitron', sans-serif;
        display: flex; justify-content: center; align-items: center; height: 100vh;
        user-select: none; -webkit-user-select: none; touch-action: none;
    }
    #game-wrap {
        position: relative; width: 100%; height: 100%; max-width: 1024px; max-height: 576px;
        box-shadow: 0 0 50px rgba(0, 243, 255, 0.15); border: 2px solid #333;
        background: #000; overflow: hidden;
    }
    canvas { display: block; width: 100%; height: 100%; }
    
    /* HUD */
    #ui-layer {
        position: absolute; inset: 0; pointer-events: none; padding: 20px;
        color: white; display: flex; flex-direction: column; justify-content: space-between; z-index: 5;
    }
    .hud-top { display: flex; justify-content: space-between; align-items: flex-start; }
    .stat-panel { 
        background: rgba(0,0,0,0.6); padding: 8px 15px; 
        border-radius: 8px; border: 1px solid #444; backdrop-filter: blur(4px);
    }
    .hearts { color: var(--danger); letter-spacing: 3px; font-size: 1.2rem; text-shadow: 0 0 10px var(--danger); }
    .bar-container { width: 120px; height: 6px; background: #222; border: 1px solid #555; position: relative; overflow: hidden; margin-top: 5px; }
    .bar-fill { height: 100%; transition: width 0.1s linear; }

    /* MENUS */
    #overlay {
        position: absolute; inset: 0; background: rgba(0,0,0,0.95);
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        text-align: center; pointer-events: auto; z-index: 20; transition: opacity 0.3s;
    }
    h1 { 
        font-family: 'Black Ops One'; font-size: 3.5rem; 
        background: linear-gradient(to bottom, #fff, #999); 
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        margin: 0; text-shadow: 0 0 30px rgba(255,255,255,0.2);
    }
    .level-selector { display: flex; gap: 10px; margin: 15px 0; }
    .lvl-btn {
        background: transparent; border: 1px solid #555; color: #888;
        padding: 8px 16px; font-family: 'Orbitron'; font-weight: bold; cursor: pointer;
    }
    .lvl-btn.selected { background: var(--primary); color: #000; box-shadow: 0 0 15px var(--primary); }

    .btn-group { display: flex; gap: 20px; margin-top: 20px; }
    .start-btn {
        padding: 15px 30px; font-size: 1.2rem;
        background: var(--danger); border: none; color: white; font-family: 'Black Ops One';
        cursor: pointer; clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
    }
    .mobile-btn { background: var(--warn); color: black; }

    /* MOBILE CONTROLS (Landscape Optimized) */
    #mobile-controls {
        position: absolute; bottom: 0; left: 0; width: 100%; height: 100%;
        pointer-events: none; z-index: 15; display: none;
    }
    .touch-area {
        position: absolute; bottom: 20px; pointer-events: auto;
        display: flex; gap: 20px;
    }
    .left-controls { left: 30px; bottom: 30px; }
    .right-controls { right: 30px; bottom: 30px; align-items: flex-end; }
    
    .t-btn {
        width: 80px; height: 80px; border-radius: 50%;
        background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255,255,255,0.3);
        color: white; font-size: 30px; display: flex; justify-content: center; align-items: center;
        backdrop-filter: blur(5px); box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }
    .t-btn:active { background: rgba(0, 243, 255, 0.3); border-color: var(--primary); transform: scale(0.95); }
    
    .fire-btn { border-color: var(--danger); color: var(--danger); width: 70px; height: 70px; margin-right: 10px; margin-bottom: 20px;}
    .jump-btn { border-color: var(--primary); color: var(--primary); width: 90px; height: 90px; }

    .hidden { opacity: 0; pointer-events: none; }
    
    @media (orientation: portrait) {
        #mobile-controls::before {
            content: "ROTATE DEVICE ‚ü≥";
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8); padding: 20px; border: 1px solid var(--primary);
            color: var(--primary); font-size: 1.5rem; pointer-events: none;
        }
    }
</style>
</head>
<body>

<div id="game-wrap">
    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div class="hud-top">
            <div class="stat-panel">
                <div class="hearts" id="hp-disp">‚ù§‚ù§‚ù§</div>
                <div>SCORE: <span id="sc-disp" style="color:var(--primary)">0</span></div>
            </div>
            <div class="stat-panel" style="text-align: right;">
                <div style="font-size:0.7rem; color:#aaa">PLASMA</div>
                <div class="bar-container"><div id="ammo-fill" class="bar-fill" style="background:var(--warn)"></div></div>
                <div style="font-size:0.7rem; color:#aaa">FUEL</div>
                <div class="bar-container"><div id="fuel-fill" class="bar-fill" style="background:var(--primary)"></div></div>
            </div>
        </div>
    </div>

    <div id="mobile-controls">
        <div class="touch-area left-controls">
            <div class="t-btn" id="btn-left">‚Üê</div>
            <div class="t-btn" id="btn-right">‚Üí</div>
        </div>
        <div class="touch-area right-controls">
            <div class="t-btn fire-btn" id="btn-fire">üî•</div>
            <div class="t-btn jump-btn" id="btn-jump">üöÄ</div>
        </div>
    </div>

    <div id="overlay">
        <h1>OMNIVERSE</h1>
        <p style="color:var(--primary); letter-spacing:4px; font-weight:bold;">ABHIK'S FINAL CUT</p>
        
        <div class="level-selector">
            <button class="lvl-btn" onclick="selectLevel(1)">LVL 1</button>
            <button class="lvl-btn" onclick="selectLevel(2)">LVL 2</button>
            <button class="lvl-btn selected" onclick="selectLevel(3)">LVL 3</button>
            <button class="lvl-btn" onclick="selectLevel(4)">LVL 4</button>
            <button class="lvl-btn" onclick="selectLevel(5)">LVL 5</button>
        </div>

        <div class="btn-group">
            <button class="start-btn" onclick="initGame(false)">PLAY PC</button>
            <button class="start-btn mobile-btn" onclick="initGame(true)">PLAY MOBILE</button>
        </div>

        <div style="margin-top:20px; font-size:0.8rem; color:#666; display:grid; grid-template-columns:1fr 1fr; gap:20px;">
            <div>PC: Arrows + Space + F</div>
            <div>Mobile: Touch Controls</div>
        </div>
    </div>
</div>

<script>
/** AUDIO SYSTEM */
class SoundFX {
    constructor() { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); this.enabled = false; }
    resume() { if(this.ctx.state === 'suspended') this.ctx.resume(); this.enabled = true; }
    play(type) {
        if(!this.enabled) return;
        const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
        osc.connect(gain); gain.connect(this.ctx.destination);
        const now = this.ctx.currentTime;
        if (type === 'jump') {
            osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(300, now + 0.1);
            gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            osc.start(now); osc.stop(now + 0.1);
        } else if (type === 'shoot') {
            osc.type = 'square'; osc.frequency.setValueAtTime(800, now); osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
            gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            osc.start(now); osc.stop(now + 0.1);
        } else if (type === 'hit_armor') {
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(200, now); osc.frequency.linearRampToValueAtTime(50, now + 0.1);
            gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.1);
            osc.start(now); osc.stop(now + 0.1);
        } else if (type === 'explosion') {
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now); osc.frequency.exponentialRampToValueAtTime(10, now + 0.3);
            gain.gain.setValueAtTime(0.2, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
            osc.start(now); osc.stop(now + 0.3);
        }
    }
}
const sfx = new SoundFX();

/** ENGINE CONSTANTS */
const cvs = document.getElementById('gameCanvas');
const ctx = cvs.getContext('2d');
const W = 1024, H = 576;
cvs.width = W; cvs.height = H;

const GRAVITY = 0.6;
const GROUND_Y = H - 80;
const JUMP_FORCE = -12;
const THEMES = [
    { id: "earth", sky: ["#87CEEB", "#E0F7FA"], ground: "#228B22", color: "#333", hazardChance: 0, bannerType: "hollywood" },
    { id: "mars", sky: ["#5D0000", "#200000"], ground: "#8B4513", color: "#00ffcc", hazardChance: 0, bannerType: "rocket_banner" },
    { id: "matrix", sky: ["#000000", "#002200"], ground: "#004400", color: "#fff", hazardChance: 0.03, bannerType: "glitch" },
    { id: "neon", sky: ["#2c003e", "#000"], ground: "#ff00ff", color: "#ffff00", hazardChance: 0, bannerType: "billboard" }
];

let game = {
    active: false, paused: false, frame: 0, score: 0, level: 3, speed: 6, 
    themeIdx: 0, themeTimer: 0, bannerSpawned: false,
    entities: [], bullets: [], particles: [], bgLayers: [],
    isMobile: false
};

let startLevel = 3;
let animId = null;
let keys = {left:false, right:false, space:false};

function selectLevel(n) {
    startLevel = n;
    document.querySelectorAll('.lvl-btn').forEach((b, i) => b.classList.toggle('selected', i+1 === n));
    document.activeElement.blur();
}

/** PARALLAX OBJECT (Decor + Banners) */
class ParallaxObject {
    constructor(layerId, type, x, y) {
        this.layerId = layerId; this.type = type; this.x = x; this.y = y; this.dead = false;
        this.scale = 0.5 + Math.random();
        // Layer Speeds: 0=Far, 1=Mid, 2=Near
        if(layerId === 0) this.speedMod = 0.05; else if(layerId === 1) this.speedMod = 0.2; else this.speedMod = 0.8; 
    }
    update() { this.x -= game.speed * this.speedMod; if(this.x < -600) this.dead = true; }
    draw(ctx, theme) {
        if(this.type === "banner_abhik") { this.drawBanner(theme); return; }
        
        if(theme.id === "earth") {
            if(this.type === "cloud") {
                ctx.fillStyle = "rgba(255,255,255,0.5)";
                ctx.beginPath(); ctx.arc(this.x, this.y, 30*this.scale, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(this.x+25, this.y-10, 40*this.scale, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(this.x+50, this.y, 30*this.scale, 0, Math.PI*2); ctx.fill();
            } else if(this.type === "mountain") {
                let h = 150 * this.scale; let w = 300 * this.scale;
                
                // Draw Big Triangle
                ctx.fillStyle = "#2d3e2d"; 
                ctx.beginPath(); 
                ctx.moveTo(this.x, H); // Start way below ground to anchor it
                ctx.lineTo(this.x, GROUND_Y); 
                ctx.lineTo(this.x + w/2, GROUND_Y - h); 
                ctx.lineTo(this.x + w, GROUND_Y); 
                ctx.lineTo(this.x + w, H);
                ctx.fill();

                // Snow Cap
                ctx.fillStyle = "#fff"; ctx.beginPath(); 
                ctx.moveTo(this.x+w/2-20*this.scale, GROUND_Y-h+30*this.scale); ctx.lineTo(this.x+w/2, GROUND_Y-h);
                ctx.lineTo(this.x+w/2+20*this.scale, GROUND_Y-h+30*this.scale); ctx.fill();
            }
        } else if (theme.id === "mars") {
             if(this.type === "planet") {
                ctx.fillStyle = "rgba(255, 100, 100, 0.4)"; ctx.beginPath(); ctx.arc(this.x, this.y, 40*this.scale, 0, Math.PI*2); ctx.fill();
             } else if(this.type === "phobos" || this.type === "deimos") {
                 // Lumpy Asteroid Moon
                 ctx.fillStyle = "#8a7b7b"; 
                 ctx.beginPath();
                 let size = (this.type === "phobos") ? 15 : 8;
                 size *= this.scale;
                 ctx.arc(this.x, this.y, size, 0, Math.PI*2);
                 ctx.arc(this.x+size/2, this.y+size/2, size/2, 0, Math.PI*2);
                 ctx.fill();
             }
        } else if (theme.id === "matrix") {
             ctx.fillStyle = "rgba(0, 255, 0, 0.15)"; ctx.font = (24*this.scale)+"px monospace";
             ctx.fillText(Math.random()>.5?"1":"0", this.x, this.y);
        } else if (theme.id === "neon") {
             if(this.type === "building") {
                 ctx.fillStyle = "#110022"; ctx.fillRect(this.x, this.y, 50*this.scale, GROUND_Y - this.y);
                 ctx.fillStyle = Math.random()>.8 ? "#ff00de" : "#1a0033"; ctx.fillRect(this.x+10, this.y+10, 5, 5);
             } else if (this.type === "flying_car") {
                 ctx.fillStyle = "#00f3ff"; ctx.fillRect(this.x, this.y, 30, 10);
             }
        }
    }
    
    drawBanner(theme) {
        ctx.save(); ctx.translate(this.x, this.y);
        if(theme.bannerType === "hollywood") {
            ctx.fillStyle = "#2e3b2e"; ctx.beginPath(); ctx.moveTo(-50, 100); ctx.lineTo(150, -50); ctx.lineTo(350, 100); ctx.fill();
            ctx.fillStyle = "#fff"; ctx.shadowColor = "#000"; ctx.shadowBlur = 4; ctx.font = "900 40px Arial"; 
            let txt = "ABHIK DUTTA"; for(let i=0; i<txt.length; i++) ctx.fillText(txt[i], i*25, Math.sin(i)*5);
            ctx.globalAlpha=0.5; ctx.fillStyle="#000"; ctx.fillRect(10,0,5,50); ctx.fillRect(250,0,5,50);
        } 
        else if (theme.bannerType === "rocket_banner") {
            // Rocket FRONT
            ctx.fillStyle="#f00"; ctx.beginPath(); ctx.moveTo(-60,-10); ctx.lineTo(-90,0); ctx.lineTo(-60,10); ctx.fill(); 
            ctx.fillStyle="#ccc"; ctx.beginPath(); ctx.ellipse(-40, 0, 30, 10, 0, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle="#fff"; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(-10,0); ctx.lineTo(10,0); ctx.stroke();
            ctx.fillStyle="#fff"; ctx.fillRect(10, -20, 250, 40);
            ctx.fillStyle="#000"; ctx.font="bold 24px Arial"; ctx.fillText("ABHIK DUTTA", 20, 10);
        } 
        else if (theme.bannerType === "glitch") {
            ctx.font = "bold 50px 'Share Tech Mono'"; ctx.fillStyle = game.frame%10===0?"#fff":"#0f0";
            ctx.fillText("ADMIN: ABHIK_DUTTA", (Math.random()-0.5)*5, 0);
            ctx.fillStyle = "rgba(0,0,0,0.5)"; ctx.fillRect(0, Math.random()*40-20, 400, 2);
        } 
        else if (theme.bannerType === "billboard") {
            ctx.fillStyle = "#000"; ctx.fillRect(-10,-50,320,80); ctx.strokeStyle = "#00f3ff"; ctx.lineWidth=3; ctx.strokeRect(-10,-50,320,80);
            ctx.shadowColor = "#ff00ff"; ctx.shadowBlur=20; ctx.fillStyle = "#ff00ff"; ctx.font="italic bold 40px 'Orbitron'"; 
            ctx.fillText("ABHIK DUTTA", 10, 5);
        }
        ctx.restore();
    }
}

/** PLAYER */
class Player {
    constructor() {
        this.w=40; this.h=40; this.x=100; this.y=GROUND_Y-40; this.dy=0; this.hp=3; this.fuel=100; this.ammo=10;
        this.grounded=true; this.jumpCount=0; this.invuln=0; this.legAngle=0; this.ammoTimer=0;
    }
    update() {
        if(keys.left && this.x>10) this.x-=6;
        if(keys.right && this.x<W/2) this.x+=6;
        if(keys.space && this.dy>-5 && this.fuel>0 && !this.grounded) {
            this.dy-=0.8; this.fuel-=1.0; spawnPart(this.x+10,this.y+40,2,'#00f3ff',0,4);
        }
        this.dy+=GRAVITY; this.y+=this.dy;
        if(this.y+this.h>GROUND_Y) { this.y=GROUND_Y-this.h; this.dy=0; this.grounded=true; this.jumpCount=0; if(this.fuel<100)this.fuel+=2; } else this.grounded=false;
        if(this.ammo<10 && ++this.ammoTimer>60) { this.ammo++; this.ammoTimer=0; }
        if(this.invuln>0) this.invuln--;
        this.legAngle = this.grounded ? this.legAngle+0.3 : 0.5;
        document.getElementById('fuel-fill').style.width=this.fuel+"%"; document.getElementById('ammo-fill').style.width=(this.ammo*10)+"%";
    }
    jump() {
        if(this.grounded) { this.dy=JUMP_FORCE; this.grounded=false; this.jumpCount=1; spawnPart(this.x+20,this.y+40,10,"#fff",0,0); sfx.play('jump'); }
        else if(this.jumpCount<2) { this.dy=JUMP_FORCE; this.jumpCount++; spawnPart(this.x+20,this.y+40,15,"#00f3ff",0,2); sfx.play('jump'); }
    }
    draw() {
        if(this.invuln>0 && Math.floor(game.frame/5)%2) return;
        ctx.save(); ctx.translate(this.x, this.y);
        ctx.shadowBlur=10; ctx.shadowColor="#00f3ff";
        ctx.fillStyle="#555"; ctx.fillRect(10,40,8,15+Math.sin(this.legAngle)*10); ctx.fillRect(26,40,8,15+Math.sin(this.legAngle+Math.PI)*10);
        ctx.fillStyle="#fff"; ctx.fillRect(0,0,40,40);
        ctx.fillStyle="#000"; ctx.fillRect(20,10,15,8); ctx.fillStyle="#333"; ctx.fillRect(35,25,12,6);
        ctx.restore();
    }
    hit(d) { if(this.invuln>0)return; this.hp-=d; this.invuln=60; updateHearts(); sfx.play('explosion'); ctx.translate(5,5); setTimeout(()=>ctx.setTransform(1,0,0,1,0,0),50); if(this.hp<=0) gameOver(); }
}

/** ENEMIES */
class Enemy {
    constructor(type, x, y) {
        this.type=type; this.x=x; this.y=y; this.w=40; this.h=40; this.hp=1; this.dead=false; this.anim=0;
        this.targetY = y; this.moveSpeedY = 1 + Math.random();
        if(type==='dragon') { this.w=70; this.h=40; this.hp=2; this.targetY = 100; } 
        if(type==='traitor') { this.fired=false; }
        if(type==='drone') { this.h=60; this.w=20; }
    }
    update() {
        let currentSpeed = game.speed * 0.6;
        
        if(this.type === 'dragon') {
            if(this.hp === 1) { // Damaged
                currentSpeed = game.speed * 0.3; this.y += 2; 
                if(game.frame % 10 === 0) spawnPart(this.x+30, this.y+20, 1, '#555', -1, -1);
            } else { // Normal
                if(Math.abs(this.y - this.targetY) < 10) {
                    if(Math.random() < 0.6) this.targetY = GROUND_Y - this.h;
                    else this.targetY = 50 + Math.random() * 100;
                }
                if(this.y < this.targetY) this.y += 2; else this.y -= 2;
            }
        } 
        else if (this.type === 'alien' || this.type === 'drone') {
            if(Math.abs(this.y - this.targetY) < 10) this.targetY = 50 + Math.random() * (GROUND_Y - 50 - this.h);
            if(this.y < this.targetY) this.y += 1.5; else this.y -= 1.5;
        }

        this.x -= currentSpeed; this.anim += 0.1;
        if(this.y + this.h > GROUND_Y) this.y = GROUND_Y - this.h;
        if(this.y < 20) this.y = 20;

        if(this.type==='traitor' && !this.fired && this.x < player.x-100) { 
             this.fired=true; game.bullets.push({x:this.x+this.w, y:this.y+10, vx:12, type:'rocket', dead:false});
             spawnPart(this.x, this.y, 10, '#fff', 2, 0); sfx.play('shoot');
        }
        if(this.x<-100) this.dead=true;
    }
    draw() {
        let t = THEMES[game.themeIdx];
        if(this.type==='dragon') {
            ctx.fillStyle = (this.hp === 1) ? "#550000" : "#8B0000"; ctx.beginPath(); ctx.ellipse(this.x+35, this.y+20, 35, 15, 0, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = (this.hp === 1) ? "#882222" : "#ff4444"; let wy = (this.hp === 1) ? Math.sin(this.anim * 0.5)*10 : Math.sin(this.anim)*25;
            ctx.beginPath(); ctx.moveTo(this.x+40, this.y+10); ctx.lineTo(this.x+20, this.y-20+wy); ctx.lineTo(this.x+60, this.y-20+wy); ctx.fill();
            ctx.fillStyle = "#ffaa00"; ctx.beginPath(); ctx.arc(this.x+5, this.y+15, 3, 0, Math.PI*2); ctx.fill(); 
        } 
        else if (this.type==='alien') {
            ctx.fillStyle = "rgba(0,255,255,0.6)"; ctx.beginPath(); ctx.arc(this.x+20, this.y+10, 15, Math.PI, 0); ctx.fill();
            ctx.fillStyle = "#888"; ctx.beginPath(); ctx.ellipse(this.x+20, this.y+25, 25, 10, 0, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = Math.sin(this.anim*10)>0 ? "#f00" : "#0f0"; ctx.beginPath(); ctx.arc(this.x+5, this.y+25, 3, 0, Math.PI*2); ctx.fill();
        }
        else if (this.type==='traitor') {
            ctx.fillStyle = "#333"; ctx.fillRect(this.x, this.y, this.w, this.h);
            ctx.fillStyle = "#f00"; ctx.font="10px Arial"; ctx.fillText("TNT", this.x+5, this.y+15);
            ctx.beginPath(); ctx.arc(this.x+20, this.y+30, 5, 0, Math.PI*2); ctx.fill();
        }
        else if (this.type==='drone') {
            ctx.fillStyle = "#ff00ff"; ctx.fillRect(this.x, this.y, this.w, this.h);
            ctx.fillStyle = "#fff"; ctx.fillRect(this.x+5, this.y+10, 10, 40);
        }
        else { // Goon
             ctx.fillStyle = t.color; ctx.fillRect(this.x, this.y, this.w, this.h);
             ctx.fillStyle = "#fff"; ctx.fillRect(this.x+5, this.y+10, 5, 5);
        }
    }
}

let player = new Player();
function spawnPart(x, y, n, c, vx, vy) { for(let i=0;i<n;i++) game.particles.push({x:x, y:y, c:c, vx:vx||(Math.random()-.5)*5, vy:vy||(Math.random()-.5)*5, life:1}); }
function updateHearts() { let s=""; for(let i=0;i<player.hp;i++) s+="‚ù§"; document.getElementById('hp-disp').innerText=s; }

function updateGame() {
    if(++game.themeTimer > 1200) { game.themeTimer=0; game.themeIdx=(game.themeIdx+1)%THEMES.length; game.bannerSpawned=false; }
    if(!game.bannerSpawned && game.themeTimer===100) { game.bgLayers.push(new ParallaxObject(1, "banner_abhik", W+100, 150)); game.bannerSpawned=true; }
    
    let r = Math.random(); let tId = THEMES[game.themeIdx].id;
    if(r<0.015 && tId==='earth') game.bgLayers.push(new ParallaxObject(1, "mountain", W, 200));
    if(r<0.01 && tId==='earth') game.bgLayers.push(new ParallaxObject(0, "cloud", W, 80));
    
    // MARS MOONS (Phobos & Deimos)
    if(r<0.01 && tId==='mars') {
        game.bgLayers.push(new ParallaxObject(0, Math.random()>0.5?"phobos":"deimos", W, 50 + Math.random()*100));
    }

    if(r<0.02 && tId==='neon') game.bgLayers.push(new ParallaxObject(0, "flying_car", W, 100));
    
    if(game.frame > 100 && game.frame % Math.max(30, 90 - (game.level * 10)) === 0) {
        let rand = Math.random();
        if(Math.random() < THEMES[game.themeIdx].hazardChance) game.entities.push(new Enemy('buggy_code', W, GROUND_Y-40));
        else if(game.level === 1) game.entities.push(new Enemy('goon', W, GROUND_Y-40));
        else {
            if(rand < 0.2) game.entities.push(new Enemy('dragon', W, 100));
            else if(rand < 0.4) game.entities.push(new Enemy('alien', W, 200));
            else if(rand < 0.6) game.entities.push(new Enemy('drone', W, 150));
            else if(rand < 0.8) game.entities.push(new Enemy('traitor', W, GROUND_Y-40));
            else game.entities.push(new Enemy('goon', W, GROUND_Y-40));
        }
    }
}

function draw() {
    let t = THEMES[game.themeIdx];
    let g = ctx.createLinearGradient(0,0,0,H); g.addColorStop(0, t.sky[0]); g.addColorStop(1, t.sky[1]); ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
    game.bgLayers.forEach((o,i) => { o.update(); o.draw(ctx,t); if(o.dead)game.bgLayers.splice(i,1); });
    ctx.fillStyle=t.ground; ctx.fillRect(0,GROUND_Y,W,H-GROUND_Y); ctx.strokeStyle="rgba(255,255,255,0.3)"; ctx.beginPath(); ctx.moveTo(0,GROUND_Y); ctx.lineTo(W,GROUND_Y); ctx.stroke();

    player.update(); player.draw();

    game.bullets.forEach((b,i) => {
        b.x+=b.vx; 
        if(b.type==='rocket') {
            ctx.fillStyle="#ff4400"; ctx.beginPath(); ctx.arc(b.x,b.y,8,0,Math.PI*2); ctx.fill();
            if(game.frame%3===0) spawnPart(b.x-10,b.y,1,"#aaa",-2,0);
            if(b.x>player.x && b.x<player.x+player.w && b.y>player.y && b.y<player.y+player.h) { player.hit(1); b.dead=true; }
        } else {
            ctx.fillStyle="#00f3ff"; ctx.fillRect(b.x,b.y,10,5);
            game.entities.forEach(e => { 
                if(!e.dead && b.x>e.x && b.x<e.x+e.w && b.y>e.y && b.y<e.y+e.h) { 
                    b.dead=true; 
                    if(e.type === 'dragon' && e.hp > 1) {
                        e.hp--; sfx.play('hit_armor'); spawnPart(e.x,e.y, 10, '#880000', 0, 0); 
                    } else {
                        e.hp--; sfx.play('explosion'); if(e.hp<=0) { e.dead=true; game.score+=50; spawnPart(e.x,e.y,20,'#f00',0,0); }
                    }
                } 
            });
        }
        if(b.x>W+100||b.x<-100) b.dead=true; if(b.dead) game.bullets.splice(i,1);
    });

    game.entities.forEach((e,i) => {
        e.update(); e.draw();
        if(!e.dead && player.x<e.x+e.w-10 && player.x+player.w>e.x+10 && player.y<e.y+e.h-10 && player.y+player.h>e.y+10) { player.hit(1); e.dead=true; spawnPart(e.x,e.y,20,'#f00',0,0); }
        if(e.dead) game.entities.splice(i,1);
    });

    game.particles.forEach((p,i)=>{ p.x+=p.vx; p.y+=p.vy; p.life-=0.05; ctx.globalAlpha=p.life; ctx.fillStyle=p.c; ctx.fillRect(p.x,p.y,4,4); ctx.globalAlpha=1; if(p.life<=0)game.particles.splice(i,1); });
}

function loop() { if(!game.active||game.paused)return; animId=requestAnimationFrame(loop); game.frame++; game.score++; document.getElementById('sc-disp').innerText=game.score; updateGame(); draw(); }

function initGame(isMobile) {
    sfx.resume(); if(animId) cancelAnimationFrame(animId);
    game.isMobile = isMobile; game.level = startLevel; game.speed = 4 + (game.level*0.8);
    player = new Player(); game.active=true; game.paused=false; game.score=0; game.frame=1; game.themeIdx=0; game.entities=[]; game.bullets=[]; game.particles=[]; game.bgLayers=[];
    document.getElementById('overlay').classList.add('hidden');
    if(isMobile) document.getElementById('mobile-controls').style.display='block';
    updateHearts(); document.querySelectorAll('button').forEach(b => b.blur());
    loop();
}

function gameOver() {
    game.active=false; document.querySelector('#overlay h1').innerHTML="GAME OVER"; document.getElementById('overlay').classList.remove('hidden'); document.getElementById('mobile-controls').style.display='none'; sfx.play('explosion');
}

// CONTROLS
const fire = () => { if(game.active && !game.paused && player.ammo>0) { player.ammo--; game.bullets.push({x:player.x+50,y:player.y+26,vx:12,type:'plasma',dead:false}); sfx.play('shoot'); } };
const jump = () => { if(game.active && !game.paused) { keys.space=true; player.jump(); } };

window.onkeydown = e => {
    if(e.code==='KeyP' && game.active) { game.paused=!game.paused; if(!game.paused) loop(); }
    if(e.code==='KeyF') fire();
    if(e.code==='ArrowLeft') keys.left=true; if(e.code==='ArrowRight') keys.right=true;
    if((e.code==='Space'||e.code==='ArrowUp')) { e.preventDefault(); jump(); }
};
window.onkeyup = e => { if(e.code==='ArrowLeft') keys.left=false; if(e.code==='ArrowRight') keys.right=false; if(e.code==='Space'||e.code==='ArrowUp') keys.space=false; };

const bindTouch = (id, key) => {
    let el = document.getElementById(id);
    el.addEventListener('touchstart', (e) => { e.preventDefault(); if(key==='fire') fire(); else if(key==='space') jump(); else keys[key]=true; }, {passive:false});
    el.addEventListener('touchend', (e) => { e.preventDefault(); if(key!=='fire' && key!=='space') keys[key]=false; if(key==='space') keys.space=false; }, {passive:false});
};
bindTouch('btn-left','left'); bindTouch('btn-right','right'); bindTouch('btn-jump','space'); bindTouch('btn-fire','fire');

</script>
</body>
</html>