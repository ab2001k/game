<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Omniverse: Final Cut</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéÆ</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Orbitron:wght@500;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
    :root { 
        --primary: #00f3ff; 
        --danger: #ff0044; 
        --warn: #ffcc00; 
        --hud-bg: rgba(0, 10, 20, 0.95);
    }
    * { box-sizing: border-box; }
    
    body {
        margin: 0; padding: 0;
        overflow: hidden; background: #050505;
        font-family: 'Orbitron', sans-serif;
        display: flex; justify-content: center; align-items: center; 
        min-height: 100vh; width: 100vw;
        user-select: none;
    }

    #game-container {
        position: relative; 
        width: 100%; 
        max-width: min(100vw, calc(100vh * 16/9));
        aspect-ratio: 16/9;
        background: #000; 
        box-shadow: 0 0 80px rgba(0, 243, 255, 0.15);
        border: 2px solid #333;
    }
    
    canvas { 
        display: block; width: 100%; height: 100%; 
        image-rendering: auto; 
    }

    #ui-layer {
        position: absolute; inset: 0; pointer-events: none; padding: clamp(10px, 2vw, 25px);
        display: flex; flex-direction: column; justify-content: space-between; z-index: 10;
    }
    .hud-top { display: flex; justify-content: space-between; width: 100%; align-items: flex-start; flex-wrap: wrap; gap: 10px; }
    
    .stat-panel {
        background: var(--hud-bg); 
        border: 1px solid rgba(255,255,255,0.15);
        padding: clamp(8px, 1.5vw, 10px) clamp(12px, 2vw, 20px); 
        border-radius: 4px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        min-width: clamp(150px, 20vw, 220px);
        pointer-events: auto;
    }
    
    .hp-text { font-size: clamp(1.2rem, 3vw, 2rem); letter-spacing: clamp(2px, 0.5vw, 5px); color: var(--danger); text-shadow: 0 0 15px var(--danger); }
    .score-box { font-family: 'Share Tech Mono'; font-size: clamp(0.9rem, 1.5vw, 1.2rem); color: #fff; margin-top: 5px; }
    .score-val { color: var(--primary); font-weight: 900; }

    .bar-group { margin-bottom: 8px; }
    .bar-label { font-size: clamp(0.65rem, 1.2vw, 0.8rem); color: #888; display: flex; justify-content: space-between; margin-bottom: 2px;}
    .bar-track { width: 100%; height: 8px; background: #222; border: 1px solid #444; border-radius: 2px; overflow: hidden; }
    .bar-fill { height: 100%; transition: width 0.1s linear; }

    #sound-btn {
        background: transparent; border: 1px solid #555; color: #fff;
        cursor: pointer; padding: 5px 10px; font-size: clamp(1rem, 2vw, 1.2rem);
        margin-left: 10px; border-radius: 4px; transition: 0.2s;
    }
    #sound-btn:hover { background: #333; border-color: var(--primary); color: var(--primary); }
    .off-sound { opacity: 0.5; text-decoration: line-through; }

    /* Mobile Controls */
    #mobile-controls {
        position: absolute;
        bottom: clamp(15px, 3vw, 30px);
        left: 0;
        right: 0;
        display: none;
        justify-content: space-between;
        padding: 0 clamp(10px, 2vw, 20px);
        pointer-events: none;
        z-index: 20;
    }
    #mobile-controls.active { display: flex; }
    
    .mobile-btn-group { display: flex; gap: clamp(8px, 1.5vw, 12px); pointer-events: auto; }
    .mobile-btn {
        width: clamp(50px, 10vw, 70px);
        height: clamp(50px, 10vw, 70px);
        background: rgba(0, 243, 255, 0.2);
        border: 2px solid var(--primary);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: clamp(1.2rem, 3vw, 1.8rem);
        color: var(--primary);
        cursor: pointer;
        user-select: none;
        transition: all 0.1s;
        box-shadow: 0 4px 15px rgba(0, 243, 255, 0.3);
    }
    .mobile-btn:active {
        background: rgba(0, 243, 255, 0.4);
        transform: scale(0.95);
        box-shadow: 0 2px 8px rgba(0, 243, 255, 0.5);
    }
    .mobile-btn.pressed {
        background: rgba(0, 243, 255, 0.5);
        box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.5);
    }

    #menu-overlay {
        position: absolute; inset: 0; background: rgba(0,0,0,0.95);
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        z-index: 100; text-align: center; backdrop-filter: blur(10px);
        padding: clamp(10px, 2vw, 20px);
        overflow-y: auto;
    }
    h1 {
        font-family: 'Black Ops One'; 
        font-size: clamp(2rem, 6vw, 6rem); 
        margin: 0;
        background: linear-gradient(180deg, #fff, #555);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        filter: drop-shadow(0 0 30px var(--primary)); 
        letter-spacing: -2px;
    }
    .menu-panel {
        border-top: 2px solid var(--primary); border-bottom: 2px solid var(--primary); 
        padding: clamp(20px, 4vw, 40px); 
        background: rgba(0, 20, 20, 0.8);
        width: 100%; 
        max-width: 700px;
    }
    
    .name-input-section {
        margin: 20px 0;
    }
    .name-input-section input {
        background: rgba(0, 50, 50, 0.5);
        border: 1px solid var(--primary);
        color: #fff;
        padding: 12px 20px;
        font-family: 'Orbitron';
        font-size: clamp(0.9rem, 2vw, 1.1rem);
        width: 100%;
        max-width: 300px;
        border-radius: 4px;
        text-align: center;
    }
    .name-input-section input::placeholder {
        color: #666;
    }
    
    .lvl-select { display: flex; gap: clamp(6px, 1.5vw, 10px); justify-content: center; margin: 20px 0; flex-wrap: wrap; }
    .lvl-btn {
        background: rgba(0,0,0,0.5); border: 1px solid #555; color: #888;
        padding: clamp(8px, 1.5vw, 10px) clamp(12px, 2.5vw, 20px); 
        cursor: pointer; 
        font-family: 'Orbitron'; 
        font-size: clamp(0.8rem, 1.5vw, 1rem);
        transition: 0.2s;
    }
    .lvl-btn.active { background: var(--primary); color: #000; box-shadow: 0 0 15px var(--primary); transform: scale(1.1); border-color: #fff;}

    .start-btn {
        display: inline-block; 
        padding: clamp(12px, 2.5vw, 20px) clamp(30px, 6vw, 60px); 
        font-family: 'Orbitron'; 
        font-size: clamp(1rem, 2.5vw, 1.5rem); 
        font-weight: 900;
        background: var(--danger); border: none; color: white; cursor: pointer; 
        clip-path: polygon(15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%, 0 15px);
        transition: transform 0.1s, filter 0.1s; margin-top: 10px;
    }
    .start-btn:hover { transform: scale(1.05); filter: brightness(1.2); box-shadow: 0 0 30px var(--danger); }
    
    .settings-btn {
        background: transparent;
        border: 1px solid #555;
        color: #888;
        padding: clamp(8px, 1.5vw, 10px) clamp(16px, 3vw, 25px);
        cursor: pointer;
        font-family: 'Orbitron';
        font-size: clamp(0.8rem, 1.5vw, 1rem);
        margin-top: 15px;
        transition: 0.2s;
    }
    .settings-btn:hover {
        border-color: var(--primary);
        color: var(--primary);
    }
    
    .hidden { display: none !important; }

    #controls-hint {
        margin-top: 30px; 
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
        gap: clamp(10px, 2vw, 20px);
        text-align: left; 
        font-size: clamp(0.8rem, 1.5vw, 1rem); 
        color: #aaa;
    }
    .key { 
        color: #fff; 
        border: 1px solid #666; 
        padding: 2px 8px; 
        border-radius: 4px; 
        background: #222; 
        font-family: monospace; 
    }
    
    /* Scoreboard */
    #scoreboard {
        margin-top: 20px;
        background: rgba(0, 30, 30, 0.6);
        padding: 15px;
        border-radius: 8px;
        max-height: 300px;
        overflow-y: auto;
    }
    #scoreboard h3 {
        color: var(--primary);
        font-size: clamp(1rem, 2vw, 1.3rem);
        margin: 0 0 10px 0;
    }
    .score-entry {
        display: flex;
        justify-content: space-between;
        padding: 8px 12px;
        margin: 5px 0;
        background: rgba(0, 0, 0, 0.3);
        border-left: 3px solid var(--primary);
        font-size: clamp(0.8rem, 1.5vw, 0.95rem);
    }
    .score-entry.highlight {
        background: rgba(0, 243, 255, 0.2);
        border-left-color: var(--danger);
        animation: pulse 2s ease-in-out;
    }
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    .score-name { color: #fff; flex: 1; }
    .score-value { color: var(--warn); font-weight: bold; }
    .score-rank { color: #666; margin-right: 10px; min-width: 30px; }
    
    /* Settings Panel */
    #settings-panel {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 20, 30, 0.95);
        border: 2px solid var(--primary);
        padding: clamp(20px, 4vw, 30px);
        border-radius: 8px;
        min-width: min(90vw, 400px);
        z-index: 150;
    }
    .settings-option {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #333;
        font-size: clamp(0.9rem, 1.8vw, 1.1rem);
    }
    .toggle-switch {
        width: 50px;
        height: 26px;
        background: #555;
        border-radius: 13px;
        position: relative;
        cursor: pointer;
        transition: 0.3s;
    }
    .toggle-switch.active {
        background: var(--primary);
    }
    .toggle-switch::after {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        background: #fff;
        border-radius: 50%;
        top: 3px;
        left: 3px;
        transition: 0.3s;
    }
    .toggle-switch.active::after {
        left: 27px;
    }
    .close-settings {
        margin-top: 20px;
        width: 100%;
        padding: 12px;
        background: var(--danger);
        border: none;
        color: #fff;
        font-family: 'Orbitron';
        font-size: clamp(0.9rem, 1.8vw, 1.1rem);
        cursor: pointer;
        transition: 0.2s;
    }
    .close-settings:hover {
        filter: brightness(1.2);
    }
    
    /* Footer branding */
    .footer-brand {
        position: absolute;
        bottom: 5px;
        right: 10px;
        font-size: clamp(0.6rem, 1.2vw, 0.75rem);
        color: rgba(255, 255, 255, 0.3);
        font-family: 'Share Tech Mono', monospace;
        letter-spacing: 1px;
    }
    
    @media (max-width: 768px) {
        #controls-hint { font-size: 0.75rem; }
    }
</style>
</head>
<body>

<div id="game-container">
    <canvas id="cvs" width="1280" height="720"></canvas>

    <div id="ui-layer">
        <div class="hud-top">
            <div class="stat-panel">
                <div class="hp-text" id="hud-hp">‚ù§‚ù§‚ù§</div>
                <div class="score-box">SCORE <span class="score-val" id="hud-score">00000</span></div>
            </div>
            <div class="stat-panel" style="display:flex; gap:15px; align-items:center;">
                <div style="flex-grow:1;">
                    <div class="bar-group">
                        <div class="bar-label"><span>PLASMA</span> <span id="hud-ammo-txt">12</span></div>
                        <div class="bar-track"><div class="bar-fill" id="hud-ammo-bar" style="background:var(--warn)"></div></div>
                    </div>
                    <div class="bar-group">
                        <div class="bar-label"><span>FUEL</span> <span id="hud-fuel-txt">100%</span></div>
                        <div class="bar-track"><div class="bar-fill" id="hud-fuel-bar" style="background:var(--primary)"></div></div>
                    </div>
                </div>
                <button id="sound-btn" onclick="AudioSys.toggle()">üîä</button>
            </div>
        </div>
    </div>

    <!-- Mobile Controls -->
    <div id="mobile-controls">
        <div class="mobile-btn-group">
            <div class="mobile-btn" data-key="Left">‚Üê</div>
            <div class="mobile-btn" data-key="Right">‚Üí</div>
        </div>
        <div class="mobile-btn-group">
            <div class="mobile-btn" data-key="Down">‚Üì</div>
            <div class="mobile-btn" data-key="Fire">üî•</div>
            <div class="mobile-btn" data-key="Up">‚Üë</div>
        </div>
    </div>

    <div id="menu-overlay">
        <div class="menu-panel">
            <h1>OMNIVERSE</h1>
            <p style="color:var(--primary); font-size: clamp(0.9rem, 2vw, 1.2rem); letter-spacing: clamp(3px, 1vw, 6px); font-weight:bold;">ULTIMATE EDITION</p>
            
            <div class="name-input-section">
                <input type="text" id="player-name" placeholder="ENTER YOUR NAME" maxlength="20" />
            </div>
            
            <div class="lvl-select" id="lvl-container"></div>
            <button class="start-btn" onclick="GAME.start()">INITIALIZE SYSTEM</button>
            <div style="font-size:clamp(0.7rem, 1.2vw, 0.8rem); margin-top:10px; color:#666;">PRESS [SPACE] TO START</div>
            
            <button class="settings-btn" onclick="GAME.toggleSettings()">‚öô SETTINGS</button>
            
            <div id="controls-hint">
                <div>MOVE: <span class="key">‚Üê</span> <span class="key">‚Üí</span></div>
                <div>CROUCH: <span class="key">‚Üì</span></div>
                <div>JUMP: <span class="key">SPACE</span></div>
                <div>SHOOT: <span class="key">F</span></div>
            </div>
            
            <div id="scoreboard">
                <h3>üèÜ HALL OF FAME</h3>
                <div id="score-list"></div>
            </div>
        </div>
        <div class="footer-brand">v2.0 | A.D.</div>
    </div>
    
    <!-- Settings Panel -->
    <div id="settings-panel" class="hidden">
        <h3 style="color: var(--primary); margin-top: 0;">SETTINGS</h3>
        <div class="settings-option">
            <span>Mobile Controls</span>
            <div class="toggle-switch" id="mobile-toggle" onclick="GAME.toggleMobileControls()"></div>
        </div>
        <div class="settings-option">
            <span>Sound Effects</span>
            <div class="toggle-switch active" id="sound-toggle" onclick="AudioSys.toggle(); GAME.updateSoundToggle()"></div>
        </div>
        <button class="close-settings" onclick="GAME.toggleSettings()">CLOSE</button>
    </div>
</div>

<script>
/* ================= SYSTEM ================= */
const AudioSys = {
    ctx: null,
    muted: false,
    init: function() {
        if(!this.ctx) {
            try { this.ctx = new (window.AudioContext||window.webkitAudioContext)(); } catch(e){}
        }
        const saved = localStorage.getItem('omni_mute');
        if(saved !== null) this.muted = (saved === 'true');
        this.updateBtn();
        if(this.ctx && this.ctx.state==='suspended') this.ctx.resume();
    },
    toggle: function() {
        this.muted = !this.muted;
        localStorage.setItem('omni_mute', this.muted);
        this.updateBtn();
    },
    updateBtn: function() {
        const btn = document.getElementById('sound-btn');
        if(btn) {
            btn.innerHTML = this.muted ? 'üîá' : 'üîä';
            btn.classList.toggle('off-sound', this.muted);
        }
    },
    play: function(t) {
        if(this.muted || !this.ctx) return;
        const o=this.ctx.createOscillator(), g=this.ctx.createGain(), now=this.ctx.currentTime;
        o.connect(g); g.connect(this.ctx.destination);
        
        if(t==='shoot'){ o.type='square'; o.frequency.setValueAtTime(800,now); o.frequency.exponentialRampToValueAtTime(100,now+0.1); g.gain.setValueAtTime(0.05,now); g.gain.linearRampToValueAtTime(0,now+0.1); o.start(now); o.stop(now+0.1); }
        if(t==='jump'){ o.type='sine'; o.frequency.setValueAtTime(200,now); o.frequency.linearRampToValueAtTime(400,now+0.2); g.gain.setValueAtTime(0.1,now); g.gain.linearRampToValueAtTime(0,now+0.2); o.start(now); o.stop(now+0.2); }
        if(t==='jet'){ o.type='sawtooth'; o.frequency.setValueAtTime(50,now); g.gain.setValueAtTime(0.05,now); g.gain.linearRampToValueAtTime(0,now+0.1); o.start(now); o.stop(now+0.1); }
        if(t==='boom'){ o.type='sawtooth'; o.frequency.setValueAtTime(100,now); o.frequency.exponentialRampToValueAtTime(10,now+0.4); g.gain.setValueAtTime(0.2,now); g.gain.linearRampToValueAtTime(0,now+0.4); o.start(now); o.stop(now+0.4); }
        if(t==='beep'){ o.type='sine'; o.frequency.setValueAtTime(800,now); g.gain.setValueAtTime(0.1,now); g.gain.linearRampToValueAtTime(0,now+0.1); o.start(now); o.stop(now+0.1); }
        if(t==='charge'){ o.type='triangle'; o.frequency.setValueAtTime(400,now); o.frequency.linearRampToValueAtTime(800,now+0.5); g.gain.setValueAtTime(0.05,now); g.gain.linearRampToValueAtTime(0,now+0.5); o.start(now); o.stop(now+0.5); }
        if(t==='heal'){ o.type='sine'; o.frequency.setValueAtTime(400,now); o.frequency.linearRampToValueAtTime(800,now+0.1); o.frequency.linearRampToValueAtTime(1200,now+0.3); g.gain.setValueAtTime(0.1,now); g.gain.linearRampToValueAtTime(0,now+0.3); o.start(now); o.stop(now+0.3); }
    }
};

const Input = {
    keys: {Left:false, Right:false, Up:false, Down: false, Fire:false},
    init: function() {
        window.addEventListener('keydown', e => this.handler(e.code, true));
        window.addEventListener('keyup', e => this.handler(e.code, false));
        
        // Mobile controls
        document.querySelectorAll('.mobile-btn').forEach(btn => {
            const key = btn.getAttribute('data-key');
            
            btn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                btn.classList.add('pressed');
                this.mobileHandler(key, true);
            });
            
            btn.addEventListener('touchend', (e) => {
                e.preventDefault();
                btn.classList.remove('pressed');
                this.mobileHandler(key, false);
            });
            
            btn.addEventListener('mousedown', (e) => {
                e.preventDefault();
                btn.classList.add('pressed');
                this.mobileHandler(key, true);
            });
            
            btn.addEventListener('mouseup', (e) => {
                e.preventDefault();
                btn.classList.remove('pressed');
                this.mobileHandler(key, false);
            });
            
            btn.addEventListener('mouseleave', (e) => {
                btn.classList.remove('pressed');
                this.mobileHandler(key, false);
            });
        });
    },
    mobileHandler: function(key, state) {
        if(key === 'Left') this.keys.Left = state;
        if(key === 'Right') this.keys.Right = state;
        if(key === 'Down') this.keys.Down = state;
        if(key === 'Up') {
            this.keys.Up = state;
            if(state && !this.prevUp) {
                if(!GAME.active) GAME.start();
                else GAME.player.tapJump();
            }
            this.prevUp = state;
        }
        if(key === 'Fire') {
            if(state && !this.keys.Fire && GAME.active) GAME.player.shoot();
            this.keys.Fire = state;
        }
    },
    handler: function(c, s) {
        if(c==='ArrowLeft') this.keys.Left = s;
        if(c==='ArrowRight') this.keys.Right = s;
        if(c==='ArrowDown') this.keys.Down = s;
        if(c==='Space' || c==='ArrowUp') {
            this.keys.Up = s;
            if(s && !this.prevUp) {
                if(!GAME.active) GAME.start();
                else GAME.player.tapJump();
            }
            this.prevUp = s;
        }
        if(c==='KeyF') { if(s && !this.keys.Fire && GAME.active) GAME.player.shoot(); this.keys.Fire = s; }
    },
    prevUp: false
};

/* ================= ENTITIES ================= */
class Particle {
    constructor(x,y,c,s,l,g,type) { 
        this.x=x;this.y=y;this.c=c;
        this.vx=(Math.random()-.5)*s; this.vy=(Math.random()-.5)*s;
        this.l=l;this.ml=l;this.g=g||0; this.type=type||'rect';
        this.size = Math.random()*3+2;
    }
    update() { 
        this.x+=this.vx; this.y+=this.vy; this.vy+=this.g; this.l--; 
        if(this.type==='shock') this.size += 3; 
    }
    draw(ctx) { 
        ctx.globalAlpha=this.l/this.ml; 
        if(this.type==='shock') {
            ctx.strokeStyle = this.c; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.stroke();
        } else {
            ctx.fillStyle=this.c; ctx.fillRect(this.x,this.y,this.size,this.size); 
        }
        ctx.globalAlpha=1; 
    }
}

class HeartItem {
    constructor() {
        this.x = GAME.W + 50;
        this.y = 100 + Math.random() * (GAME.GroundY - 200);
        this.w = 30; this.h = 30;
        this.vx = 2.5;
        this.tm = 0; this.dead = false;
    }
    update() {
        this.x -= this.vx;
        this.tm += 0.05;
        this.y += Math.sin(this.tm) * 1.5;
        if(this.x < -50) this.dead = true;

        if(checkRect(this, GAME.player)) {
            if(GAME.player.hp < 5) {
                GAME.player.hp++;
                GAME.score += 50;
                AudioSys.play('heal');
                GAME.spawnPart(this.x+15, this.y+15, '#f06', 10, 20, 0);
                GAME.txts.push(new FloatingText(this.x, this.y-20, "HP UP!", "#f06"));
            }
            this.dead = true;
        }
    }
    draw(ctx) {
        ctx.save();
        ctx.translate(this.x+15, this.y+15);
        let s = 1 + Math.sin(this.tm*2)*0.2;
        ctx.scale(s, s);
        ctx.shadowBlur = 15; ctx.shadowColor = "#f06";
        ctx.fillStyle = "#ff0066";
        ctx.beginPath();
        ctx.moveTo(0, 5);
        ctx.bezierCurveTo(0, 5, -10, -10, -15, -10);
        ctx.bezierCurveTo(-25, -10, -25, 5, -25, 5);
        ctx.bezierCurveTo(-25, 15, 0, 30, 0, 30);
        ctx.bezierCurveTo(0, 30, 25, 15, 25, 5);
        ctx.bezierCurveTo(25, 5, 25, -10, 15, -10);
        ctx.bezierCurveTo(10, -10, 0, 5, 0, 5);
        ctx.fill();
        ctx.restore();
    }
}

class BackMissile {
    constructor(yPos) {
        this.x = -80; this.y = yPos; 
        this.w = 40; this.h = 12;
        this.vx = 10; this.dead = false;
        GAME.txts.push(new FloatingText(150, this.y, "‚ö† INCOMING!", "#f00"));
        AudioSys.play('shoot'); 
    }
    update() {
        this.x += this.vx;
        if(this.x < GAME.player.x) { 
            if(this.y < GAME.player.y) this.y += 1.5;
            if(this.y > GAME.player.y) this.y -= 1.5;
        }
        GAME.spawnPart(this.x, this.y+5, '#f00', 3, 5, 0); 
        if(this.x > GAME.W + 50) this.dead = true;
        if(checkRect(this, GAME.player)) {
            GAME.player.hit(1); this.dead = true;
            GAME.spawnPart(this.x, this.y, '#f00', 20, 20, 0);
        }
    }
    draw(ctx) {
        let grad = ctx.createLinearGradient(this.x, 0, this.x+this.w, 0);
        grad.addColorStop(0, '#555'); grad.addColorStop(1, '#f00');
        ctx.fillStyle = grad;
        ctx.beginPath();
        ctx.moveTo(this.x, this.y); ctx.lineTo(this.x+this.w, this.y+this.h/2); ctx.lineTo(this.x, this.y+this.h);
        ctx.fill();
    }
    hit() { this.dead=true; GAME.score+=200; GAME.spawnPart(this.x,this.y,'#f00',20,30,0.5); AudioSys.play('boom'); }
}

class Bullet {
    constructor(x,y,vx,owner, themeId) { 
        this.x=x;this.y=y;this.vx=vx;this.o=owner;this.dead=false;this.w=20;this.h=6; 
        this.theme = themeId || 'Earth';
    }
    update() { 
        this.x+=this.vx; if(this.x<-50||this.x>GAME.W+50) this.dead=true;
        if(this.o==='enemy') GAME.spawnPart(this.x+this.w,this.y+2,'#f00',1,5,0);
    }
    draw(ctx) { 
        if(this.o === 'enemy') {
            ctx.fillStyle = '#f00'; ctx.fillRect(this.x,this.y,this.w,this.h); 
            return;
        }
        if(this.theme === 'Mars') {
            ctx.fillStyle = '#f00'; ctx.shadowBlur = 10; ctx.shadowColor = '#f00';
            ctx.fillRect(this.x, this.y+1, 40, 4);
        } else if (this.theme === 'Neon') {
            ctx.fillStyle = '#0ff'; ctx.shadowBlur = 15; ctx.shadowColor = '#0ff';
            ctx.fillRect(this.x, this.y, 30, 8);
            ctx.fillStyle = '#fff'; ctx.fillRect(this.x+5, this.y+2, 20, 4);
        } else if (this.theme === 'Space') {
            ctx.fillStyle = '#0f0'; ctx.shadowBlur = 10; ctx.shadowColor = '#0f0';
            ctx.beginPath(); ctx.arc(this.x+10, this.y+3, 8, 0, Math.PI*2); ctx.fill();
        } else {
            ctx.fillStyle = '#ffcc00'; ctx.shadowBlur = 0;
            ctx.fillRect(this.x, this.y, this.w, this.h);
        }
        ctx.shadowBlur = 0; 
    }
}

class Player {
    constructor() {
        this.w=40; this.h=50; this.x=200; this.y=0; this.vx=0; this.vy=0;
        this.hp=3; this.fuel=100; this.ammo=12; 
        this.grounded=false; this.invuln=0; this.walkCycle=0;
        this.jumpCount=0; this.reloadTimer=0;
        this.crouching = false;
    }
    update() {
        this.crouching = this.grounded && Input.keys.Down;

        if(!this.crouching) {
            if(Input.keys.Left) { this.vx -= 0.8; this.walkCycle += 0.4; } 
            else if(Input.keys.Right) { this.vx += 0.8; this.walkCycle += 0.4; } 
            else { this.vx *= 0.85; this.walkCycle = 0; }
        } else {
            this.vx *= 0.7;
        }

        this.vx = Math.max(-9, Math.min(9, this.vx));
        this.x = Math.max(0, Math.min(GAME.W-this.w, this.x+this.vx));

        if(Input.keys.Up && !this.grounded && this.fuel>0) {
            this.vy -= 0.9; this.fuel -= 1.2;
            GAME.spawnPart(this.x+10, this.y+45, '#0ff', 4, 10, 0.5);
            if(GAME.frames%6===0) AudioSys.play('jet');
        } else if(this.grounded && this.fuel<100) this.fuel += 0.6;

        let g = (GAME.themes[GAME.themeIdx].id === 'Mars') ? 0.25 : 0.45;
        this.vy += g;
        this.y += this.vy;

        if(this.y < 0) { this.y = 0; if(this.vy < 0) this.vy = 0; }
        if(this.y+this.h > GAME.GroundY) {
            this.y = GAME.GroundY - this.h; this.vy = 0; 
            this.grounded = true; this.jumpCount=0;
        } else this.grounded = false;

        if(this.ammo < 12) {
            this.reloadTimer++;
            if(this.reloadTimer > 40) { this.ammo++; this.reloadTimer=0; }
        }

        if(this.invuln>0) this.invuln--;
        this.updateHUD();
    }
    tapJump() {
        if(this.grounded || this.jumpCount < 2) {
            this.vy = -12; this.jumpCount++; this.grounded=false;
            AudioSys.play('jump');
            GAME.spawnPart(this.x+20, this.y+50, '#fff', 5, 20, 0);
        }
    }
    shoot() {
        if(this.ammo>0) {
            this.ammo--; 
            let t = GAME.themes[GAME.themeIdx].id;
            let fireY = this.crouching ? this.y + 35 : this.y + 15;
            GAME.bulls.push(new Bullet(this.x+40, fireY, 15, 'player', t));
            AudioSys.play('shoot'); 
            this.reloadTimer=0;
        }
    }
    hit(d) {
        if(this.invuln>0) return;
        this.hp-=d; this.invuln=60; GAME.shake=15; AudioSys.play('boom');
        if(this.hp<=0) GAME.over();
    }
    updateHUD() {
        document.getElementById('hud-hp').innerText = "‚ù§".repeat(Math.max(0,this.hp));
        document.getElementById('hud-score').innerText = GAME.score.toString().padStart(5,'0');
        document.getElementById('hud-ammo-bar').style.width = (this.ammo/12*100)+"%";
        document.getElementById('hud-fuel-bar').style.width = this.fuel+"%";
        document.getElementById('hud-ammo-txt').innerText = this.ammo;
    }
    draw(ctx) {
        if(this.invuln>0 && Math.floor(GAME.frames/4)%2) return;
        let legOffset = Math.sin(this.walkCycle) * 10;
        
        ctx.save();
        ctx.translate(this.x+this.w/2, this.y+this.h/2);
        ctx.rotate(this.vx * 0.02);
        ctx.translate(-(this.x+this.w/2), -(this.y+this.h/2));

        if(this.crouching) {
            ctx.fillStyle = '#999';
            ctx.fillRect(this.x+5, this.y+40, 30, 10);
            let grad = ctx.createLinearGradient(this.x, this.y+15, this.x, this.y+this.h);
            grad.addColorStop(0, '#fff'); grad.addColorStop(1, '#aaa');
            ctx.fillStyle = grad; 
            ctx.fillRect(this.x, this.y+15, this.w, 25);
            ctx.fillStyle = '#333'; ctx.fillRect(this.x+15, this.y+23, 25, 12);
            ctx.fillStyle = '#0ff'; ctx.fillRect(this.x+18, this.y+25, 20, 5); 
        } else {
            ctx.fillStyle = '#999';
            if(this.grounded) {
                ctx.fillRect(this.x+8 + legOffset, this.y+40, 8, 10); 
                ctx.fillRect(this.x+24 - legOffset, this.y+40, 8, 10);
            } else {
                ctx.fillRect(this.x+8, this.y+40, 8, 8); 
                ctx.fillRect(this.x+24, this.y+45, 8, 8);
            }
            let grad = ctx.createLinearGradient(this.x, this.y, this.x, this.y+this.h);
            grad.addColorStop(0, '#fff'); grad.addColorStop(1, '#aaa');
            ctx.fillStyle = grad; 
            ctx.fillRect(this.x, this.y, this.w, this.h-10);
            ctx.fillStyle = '#333'; ctx.fillRect(this.x+15, this.y+8, 25, 12);
            ctx.fillStyle = '#0ff'; ctx.fillRect(this.x+18, this.y+10, 20, 5); 
            ctx.fillStyle = '#555'; ctx.fillRect(this.x-6, this.y+10, 6, 30);
            ctx.fillStyle = this.fuel>20 ? '#0f0' : '#f00'; 
            ctx.shadowBlur=5; ctx.shadowColor=ctx.fillStyle;
            ctx.fillRect(this.x-6, this.y+15, 3, 5);
            ctx.shadowBlur=0;
        }
        ctx.restore();
    }
}

class Enemy {
    constructor(t) {
        this.t=t; this.dead=false; this.x=GAME.W+50; this.w=40; this.h=40; this.hp=1; this.tm=0;
        this.yBase = 50 + Math.random() * (GAME.GroundY - 150);
        this.yPhase = Math.random() * Math.PI;
        this.beamTimer = 0; 
        
        this.bombTimer = 0; 
        this.triggered = false;
        
        if(t==='dragon') { this.w=50; this.h=40; this.hp=2; } 
        else if(t==='ufo') { this.w=60; this.h=30; this.hp=2; }
        else if(t==='tnt') { this.y=GAME.GroundY-30; this.w=30; this.h=30; this.hp=2; }
        else if(t==='traitor') { this.y=GAME.GroundY-60; this.h=50; this.hp=2; this.fired=false; }
        else this.y=GAME.GroundY-40; 
    }
    update() {
        if(this.t !== 'ufo' || this.beamTimer <= 0) {
            if(this.t === 'traitor') {
                this.x -= 4;
            } else {
                let spd = (this.t === 'tnt') ? (2 + GAME.level*0.5) : (3 + GAME.level * 0.8);
                this.x -= spd; 
            }
        }
        this.tm++;
        
        if(this.t === 'tnt') {
             let centerX = this.x + this.w/2;
             let pCenterX = GAME.player.x + GAME.player.w/2;
             let dist = Math.abs(centerX - pCenterX);
             if(!this.triggered && dist < 150) {
                 this.triggered = true; this.bombTimer = 90;
             }
             if(this.triggered) {
                 this.bombTimer--;
                 if(this.bombTimer % 15 === 0) AudioSys.play('beep'); 
                 if(this.bombTimer <= 0) this.hit(true); 
             }
        }

        if(this.t==='traitor' && this.x < -10 && !this.fired) {
            this.fired = true;
            GAME.ents.push(new BackMissile(this.y + 10));
            GAME.spawnPart(this.x+40, this.y+10, '#fff', 5, 20, 0); 
        }

        if(this.t==='dragon') this.y = this.yBase + Math.sin(this.tm * 0.05 + this.yPhase) * 60;
        
        if(this.t==='ufo') {
            this.y = this.yBase + Math.sin(this.tm * 0.04) * 80;
            if(this.beamTimer === 0 && Math.random() < 0.005) {
                this.beamTimer = 100; AudioSys.play('charge');
            }
            if(this.beamTimer > 0) {
                this.beamTimer--;
                if(this.beamTimer < 40) {
                    if(GAME.player.x < this.x+this.w && GAME.player.x+GAME.player.w > this.x) {
                        GAME.player.hit(1); 
                    }
                }
            }
        }
        
        if(this.x < -200) this.dead=true;

        if(checkRect(this, GAME.player)) {
            let playerBottom = GAME.player.y + GAME.player.h;
            let enemyCenterY = this.y + this.h * 0.5;
            let isStomp = (GAME.player.vy > 0) && (this.t !== 'tnt') && (playerBottom < enemyCenterY + 15);
            
            if(isStomp) {
                if(this.t === 'traitor' && GAME.level >= 3) {
                    this.hit(true); 
                    GAME.player.hit(1);
                } else {
                    this.hit();
                    GAME.player.vy = -8; 
                    GAME.spawnPart(this.x+this.w/2, this.y, '#fff', 5, 10, 0.5);
                    AudioSys.play('jump');
                }
            } else {
                if(this.t==='tnt') this.hit(true); 
                else { GAME.player.hit(1); this.hit(true); }
            }
        }
    }
    
    hit(forceKill) {
        this.hp--; 
        if(this.hp > 0 && !forceKill) {
            this.y += 10; AudioSys.play('jump'); GAME.spawnPart(this.x+20,this.y+20,'#fff',3,5,0);
        } else {
            this.dead=true; 
            if(!forceKill) GAME.score += (this.t==='dragon'?500:100);
            
            if(this.t === 'traitor' || this.t === 'tnt') {
                GAME.spawnPart(this.x, this.y, '#ff4400', 10, 50, 0, 'shock');
                for(let i=0; i<25; i++) GAME.spawnPart(this.x+15, this.y+15, Math.random()>.5?'#f00':'#ff0', 12, 40, 0.5);
                GAME.shake = 18;
                AudioSys.play('boom');

                let blastRadius = (GAME.level <= 2) ? 70 : 160;

                let dx = (this.x+this.w/2) - (GAME.player.x+GAME.player.w/2);
                let dy = (this.y+this.h/2) - (GAME.player.y+GAME.player.h/2);
                let dist = Math.sqrt(dx*dx + dy*dy);
                
                if(dist < blastRadius) {
                    GAME.player.hit(1);
                    GAME.txts.push(new FloatingText(GAME.player.x, GAME.player.y-50, "BLAST!", "#f00"));
                }
            } else {
                GAME.spawnPart(this.x,this.y,this.t==='ufo'?'#0f0':'#fc0', 15, 20, 0.5);
                AudioSys.play('boom');
            }
        }
    }
    
    draw(ctx) {
        if(this.t==='dragon') {
            let wingOffset = Math.sin(this.tm * 0.3) * 15;
            let grad = ctx.createLinearGradient(this.x,this.y,this.x,this.y+30);
            grad.addColorStop(0, '#e55'); grad.addColorStop(1, '#800');
            ctx.fillStyle = grad; 
            ctx.beginPath(); ctx.ellipse(this.x+25, this.y+20, 20, 12, 0, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#ff0'; ctx.beginPath(); ctx.moveTo(this.x, this.y+20); ctx.lineTo(this.x+10, this.y+15); ctx.lineTo(this.x+10, this.y+25); ctx.fill();
            ctx.fillStyle = '#a00'; 
            ctx.beginPath(); ctx.moveTo(this.x+25, this.y+15); ctx.lineTo(this.x+15, this.y-10+wingOffset); ctx.lineTo(this.x+40, this.y+15); ctx.fill();
            ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(this.x+15, this.y+15, 3, 0, Math.PI*2); ctx.fill();

        } else if(this.t==='tnt') {
            let flash = (this.triggered && Math.floor(this.bombTimer/5)%2===0);
            ctx.fillStyle= flash ? '#fff' : '#B22222'; 
            ctx.fillRect(this.x, this.y, this.w, this.h); 
            ctx.fillStyle='#800000'; ctx.fillRect(this.x, this.y+10, this.w, 4); 
            ctx.fillRect(this.x, this.y+20, this.w, 4);
            if(this.triggered) {
                ctx.fillStyle = '#f00'; ctx.font="bold 12px monospace"; 
                ctx.fillText((this.bombTimer/60).toFixed(1), this.x+5, this.y-10);
            } else {
                ctx.fillStyle='#ff0'; ctx.font="bold 10px Arial"; ctx.fillText("TNT", this.x+5, this.y+18);
            }

        } else if(this.t==='ufo') {
            if(this.beamTimer > 0) {
                let alpha = this.beamTimer > 40 ? 0.2 : 0.6;
                ctx.fillStyle = `rgba(255,0,0,${alpha})`;
                ctx.fillRect(this.x+15, this.y+20, 30, GAME.GroundY - this.y);
            }
            ctx.fillStyle='#0f0'; ctx.beginPath(); ctx.arc(this.x+30,this.y+15,18,Math.PI,0); ctx.fill(); 
            let grad = ctx.createLinearGradient(this.x, this.y, this.x, this.y+30);
            grad.addColorStop(0, '#888'); grad.addColorStop(1, '#333');
            ctx.fillStyle=grad; 
            ctx.beginPath(); ctx.ellipse(this.x+30,this.y+15,35,10,0,0,Math.PI*2); ctx.fill();
            ctx.fillStyle = (Math.floor(this.tm/10)%2===0) ? '#f00' : '#ff0';
            ctx.beginPath(); ctx.arc(this.x+10, this.y+15, 3, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(this.x+50, this.y+15, 3, 0, Math.PI*2); ctx.fill();

        } else if(this.t==='traitor') {
            let grad = ctx.createLinearGradient(this.x, this.y, this.x+this.w, this.y);
            grad.addColorStop(0, '#444'); grad.addColorStop(1, '#222');
            ctx.fillStyle=grad; ctx.fillRect(this.x,this.y+10,this.w,40); 
            ctx.fillStyle='#111'; ctx.fillRect(this.x-2,this.y+45,this.w+4,8); 
            ctx.fillStyle='#f00'; ctx.shadowBlur=10; ctx.shadowColor='#f00';
            ctx.fillRect(this.x+10,this.y+15,20,5); 
            ctx.shadowBlur=0;
            ctx.fillStyle='#888'; ctx.fillRect(this.x+15,this.y-5,2,15);

        } else {
            this.drawCar(ctx, GAME.themes[GAME.themeIdx].id);
        }
    }

    drawCar(ctx, theme) {
        if(theme === 'Earth' || theme === 'Neon') {
            let cMain = theme==='Earth' ? '#eec' : '#309';
            let cTop = theme==='Earth' ? '#cca' : '#60c';
            ctx.fillStyle = cMain; ctx.fillRect(this.x, this.y+15, 40, 15); 
            ctx.fillStyle = cTop;  ctx.fillRect(this.x+5, this.y, 25, 15); 
            ctx.fillStyle = '#222'; 
            ctx.beginPath(); ctx.arc(this.x+10, this.y+30, 6, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(this.x+30, this.y+30, 6, 0, Math.PI*2); ctx.fill();
            if(theme === 'Neon') {
                ctx.fillStyle='#0ff'; ctx.shadowBlur=5; ctx.shadowColor='#0ff';
                ctx.fillRect(this.x, this.y+28, 40, 2); 
                ctx.shadowBlur=0;
            }
        } else if (theme === 'Mars') {
            ctx.fillStyle = '#842'; ctx.fillRect(this.x, this.y+5, 40, 15);
            ctx.fillStyle = '#111'; 
            ctx.beginPath(); ctx.arc(this.x+8, this.y+30, 8, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(this.x+32, this.y+30, 8, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle='#aaa'; ctx.beginPath(); ctx.moveTo(this.x+10, this.y+5); ctx.lineTo(this.x+5, this.y-10); ctx.stroke();
        } else {
            let grad = ctx.createRadialGradient(this.x+20, this.y+20, 5, this.x+20, this.y+20, 20);
            grad.addColorStop(0, '#fff'); grad.addColorStop(1, '#888');
            ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(this.x+20, this.y+20, 15, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#55f'; ctx.beginPath(); ctx.arc(this.x+20, this.y+20, 8, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#999'; ctx.fillRect(this.x+5, this.y+30, 5, 10); ctx.fillRect(this.x+30, this.y+30, 5, 10);
        }
    }
}

class FloatingText {
    constructor(x,y,t,c) { this.x=x;this.y=y;this.t=t;this.c=c;this.l=60; }
    update() { this.y-=1; this.l--; }
    draw(ctx) { ctx.globalAlpha=this.l/60; ctx.fillStyle=this.c; ctx.font="bold 20px Orbitron"; ctx.fillText(this.t,this.x,this.y); ctx.globalAlpha=1; }
}

const GAME = {
    cvs: document.getElementById('cvs'), ctx: document.getElementById('cvs').getContext('2d'),
    W: 1280, H: 720, GroundY: 640, Gravity: 0.6,
    active: false, frames: 0, score: 0, level: 3, shake: 0,
    player: null, ents: [], bulls: [], parts: [], txts: [], 
    playerName: '',
    mobileControlsEnabled: false,
    
    themes: [
        {id:'Earth', sky:['#87CEEB','#E0F7FA'], ground:'#228B22'},
        {id:'Mars', sky:['#4a0e0e','#1a0505'], ground:'#8B4513'},
        {id:'Neon', sky:['#1a0033','#000'], ground:'#ff00ff'},
        {id:'Space', sky:['#000','#001'], ground:'#333'}
    ],
    themeIdx: 0,
    bgLayer1: [], bgLayer2: [],

    init: function() {
        Input.init(); AudioSys.init();
        const c = document.getElementById('lvl-container');
        for(let i=1; i<=5; i++) {
            let b = document.createElement('div');
            b.className = i===3 ? 'lvl-btn active' : 'lvl-btn';
            b.innerText = "LVL "+i;
            b.onclick = () => { GAME.level = i; document.querySelectorAll('.lvl-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); };
            c.appendChild(b);
        }
        
        // Load saved name
        const savedName = localStorage.getItem('omni_player_name');
        if(savedName) document.getElementById('player-name').value = savedName;
        
        // Load mobile controls preference
        const savedMobile = localStorage.getItem('omni_mobile_controls');
        if(savedMobile === 'true') {
            this.mobileControlsEnabled = true;
            document.getElementById('mobile-toggle').classList.add('active');
            document.getElementById('mobile-controls').classList.add('active');
        }
        
        this.loadScoreboard();
        this.ctx.fillStyle = '#000'; this.ctx.fillRect(0,0,this.W,this.H);
        this.ctx.fillStyle = '#00f3ff'; this.ctx.font = '30px Orbitron';
        this.ctx.fillText("SYSTEM READY", 50, 50);
    },

    start: function() {
        const nameInput = document.getElementById('player-name').value.trim();
        this.playerName = nameInput || 'PLAYER';
        localStorage.setItem('omni_player_name', this.playerName);
        
        this.active = true; this.score = 0; this.frames = 0; 
        this.player = new Player();
        this.ents = []; this.bulls = []; this.parts = []; this.txts = [];
        this.bgLayer1 = []; this.bgLayer2 = [];
        AudioSys.init();
        document.getElementById('menu-overlay').classList.add('hidden');
        document.querySelector('h1').innerText = "OMNIVERSE";
        this.loop();
    },

    spawnPart: function(x,y,c,s,l,g,t) { for(let i=0;i<4;i++) this.parts.push(new Particle(x,y,c,s,l,g,t)); },

    update: function() {
        this.frames++;
        if(this.frames % 1200 === 0) {
            this.themeIdx = (this.themeIdx + 1) % 4;
            this.txts.push(new FloatingText(this.W/2-50, 200, "WARP: " + this.themes[this.themeIdx].id.toUpperCase(), "#fff"));
        }
        if(this.frames % 200 === 0) this.bgLayer1.push({x:this.W, type:'mountain'}); 
        if(this.frames % 60 === 0) this.bgLayer2.push({x:this.W, type:'tree'});
        if(this.frames % 1200 === 100) this.bgLayer1.push({x:this.W, type:'brand'});

        let currentDifficulty = GAME.level + Math.floor(GAME.score/2000);
        let spawnRate = Math.max(20, 80 - (currentDifficulty * 8));

        if(this.frames % spawnRate === 0) {
            let r=Math.random();
            let newE;

            if(GAME.level === 5 && Math.random() < 0.3) {
                 if(Math.random() > 0.5) newE = new Enemy('ufo');
                 else newE = new Enemy('tnt');
                 if(newE.t !== 'tnt') newE.y = 100 + Math.random() * 400; 
            } else {
                 if(r<0.15) newE = new Enemy('dragon'); 
                 else if(r<0.3) newE = new Enemy('ufo');
                 else if(r<0.6) newE = new Enemy('traitor');
                 else if(r<0.7) newE = new Enemy('tnt');
                 else newE = new Enemy('basic'); 
            }
            
            if(newE) GAME.ents.push(newE);
        }

        if(this.frames % 600 === 0) { 
            this.ents.push(new HeartItem());
        }

        this.player.update();
        this.ents.forEach(e=>e.update()); this.ents=this.ents.filter(e=>!e.dead);
        this.bulls.forEach(b=>{
            b.update();
            if(b.o==='player') {
                this.ents.forEach(e=>{ 
                    if(!b.dead && !e.dead && !(e instanceof HeartItem) && checkRect(b,e)) { 
                        b.dead=true; 
                        if(e.t === 'tnt') e.hit(true); 
                        else e.hit(); 
                    }
                });
                this.ents.forEach(e=>{ if(!b.dead && e instanceof BackMissile && checkRect(b,e)) { b.dead=true; e.hit(); }});
            } else if (checkRect(b, GAME.player)) { b.dead=true; GAME.player.hit(1); }
        });
        this.bulls=this.bulls.filter(b=>!b.dead);
        this.parts.forEach(p=>p.update()); this.parts=this.parts.filter(p=>p.l>0);
        this.txts.forEach(t=>t.update()); this.txts=this.txts.filter(t=>t.l>0);
        this.bgLayer1.forEach(b => b.x -= 0.5); this.bgLayer1 = this.bgLayer1.filter(b=>b.x > -500);
        this.bgLayer2.forEach(b => b.x -= 2);   this.bgLayer2 = this.bgLayer2.filter(b=>b.x > -200);
        if(this.shake>0) this.shake*=0.9;
        if(this.score > 0 && this.score % 1000 === 0) this.txts.push(new FloatingText(this.W/2, 100, "SPEED UP!", "#0ff"));
    },

    draw: function() {
        let t = this.themes[this.themeIdx];
        let g = this.ctx.createLinearGradient(0,0,0,this.H); g.addColorStop(0,t.sky[0]); g.addColorStop(1,t.sky[1]);
        this.ctx.fillStyle = g; this.ctx.fillRect(0,0,this.W,this.H);
        this.ctx.save();
        if(this.shake>0.5) this.ctx.translate((Math.random()-.5)*this.shake, (Math.random()-.5)*this.shake);

        if(t.id==='Mars') {
            this.ctx.fillStyle = "rgba(200,50,50,0.4)";
            this.ctx.beginPath(); this.ctx.arc(this.W-200, 150, 40, 0, Math.PI*2); this.ctx.fill();
            this.ctx.beginPath(); this.ctx.arc(this.W-100, 250, 20, 0, Math.PI*2); this.ctx.fill();
        }
        
        this.bgLayer1.forEach(b => {
            if(b.type==='mountain') {
                this.ctx.fillStyle = "rgba(0,0,0,0.3)";
                this.ctx.beginPath(); this.ctx.moveTo(b.x, this.GroundY); 
                this.ctx.lineTo(b.x+150, this.GroundY-200); this.ctx.lineTo(b.x+300, this.GroundY); this.ctx.fill();
            } else if (b.type==='brand') { this.drawBrand(b.x, t.id); }
        });

        this.bgLayer2.forEach(b => {
            // Improved tree rendering
            this.ctx.fillStyle = "#5D4037"; 
            this.ctx.fillRect(b.x+12, this.GroundY-35, 6, 35);
            
            // Tree foliage - 3 layers
            this.ctx.fillStyle = "#1B5E20";
            this.ctx.beginPath();
            this.ctx.moveTo(b.x, this.GroundY-25);
            this.ctx.lineTo(b.x+15, this.GroundY-65);
            this.ctx.lineTo(b.x+30, this.GroundY-25);
            this.ctx.fill();
            
            this.ctx.fillStyle = "#2E7D32";
            this.ctx.beginPath();
            this.ctx.moveTo(b.x-5, this.GroundY-40);
            this.ctx.lineTo(b.x+15, this.GroundY-85);
            this.ctx.lineTo(b.x+35, this.GroundY-40);
            this.ctx.fill();
            
            this.ctx.fillStyle = "#388E3C";
            this.ctx.beginPath();
            this.ctx.moveTo(b.x-8, this.GroundY-55);
            this.ctx.lineTo(b.x+15, this.GroundY-100);
            this.ctx.lineTo(b.x+38, this.GroundY-55);
            this.ctx.fill();
        });

        this.ctx.fillStyle = t.ground; this.ctx.fillRect(0, this.GroundY, this.W, this.H-this.GroundY);
        this.ctx.fillStyle = "rgba(255,255,255,0.05)"; this.ctx.fillRect(0, this.GroundY, this.W, 10);

        this.ents.forEach(e=>e.draw(this.ctx));
        this.bulls.forEach(b=>b.draw(this.ctx));
        this.player.draw(this.ctx);
        this.parts.forEach(p=>p.draw(this.ctx));
        this.txts.forEach(t=>t.draw(this.ctx));
        this.ctx.restore();
    },

    drawBrand: function(x, id) {
        this.ctx.save(); this.ctx.translate(x, 250);
        if(id==='Earth') {
            this.ctx.fillStyle="#fff"; this.ctx.font="900 50px Arial"; this.ctx.fillText("OMNI",0,0);
            this.ctx.fillStyle="#333"; this.ctx.fillRect(0,10,400,10);
        } else if(id==='Mars') {
            this.ctx.rotate(-0.3);
            this.ctx.fillStyle="#ccc"; this.ctx.fillRect(0,0,80,30);
            this.ctx.fillStyle="red"; this.ctx.beginPath(); this.ctx.moveTo(80,0); this.ctx.lineTo(100,15); this.ctx.lineTo(80,30); this.ctx.fill();
            this.ctx.fillStyle="#000"; this.ctx.font="bold 16px Arial"; this.ctx.fillText("BASE", 10, 20);
        } else if(id==='Neon') {
            this.ctx.fillStyle="#000"; this.ctx.fillRect(0,0,300,80);
            this.ctx.strokeStyle="#0ff"; this.ctx.lineWidth=4; this.ctx.strokeRect(0,0,300,80);
            this.ctx.fillStyle="#f0f"; this.ctx.font="30px Orbitron"; this.ctx.fillText("NEON CITY", 30, 50);
        } else {
             this.ctx.fillStyle="#222"; this.ctx.fillRect(0,0,150,50);
             this.ctx.fillStyle="#0f0"; this.ctx.font="20px monospace"; this.ctx.fillText("STATION_9", 10, 30);
        }
        this.ctx.restore();
    },

    loop: function() {
        if(!this.active) return;
        requestAnimationFrame(()=>this.loop());
        this.update(); this.draw();
    },

    over: function() {
        this.active=false;
        this.saveScore();
        document.getElementById('menu-overlay').classList.remove('hidden');
        document.querySelector('h1').innerText="GAME OVER";
    },
    
    saveScore: function() {
        let scores = JSON.parse(localStorage.getItem('omni_scores') || '[]');
        scores.push({
            name: this.playerName,
            score: this.score,
            level: this.level,
            date: new Date().toLocaleDateString()
        });
        scores.sort((a, b) => b.score - a.score);
        scores = scores.slice(0, 10); // Keep top 10
        localStorage.setItem('omni_scores', JSON.stringify(scores));
        this.loadScoreboard(this.score);
    },
    
    loadScoreboard: function(highlightScore) {
        const scores = JSON.parse(localStorage.getItem('omni_scores') || '[]');
        const list = document.getElementById('score-list');
        
        if(scores.length === 0) {
            list.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No scores yet. Be the first!</div>';
            return;
        }
        
        list.innerHTML = scores.map((s, i) => {
            const isHighlight = highlightScore && s.score === highlightScore;
            return `<div class="score-entry ${isHighlight ? 'highlight' : ''}">
                <span class="score-rank">#${i+1}</span>
                <span class="score-name">${s.name}</span>
                <span class="score-value">${s.score}</span>
            </div>`;
        }).join('');
    },
    
    toggleSettings: function() {
        document.getElementById('settings-panel').classList.toggle('hidden');
    },
    
    toggleMobileControls: function() {
        this.mobileControlsEnabled = !this.mobileControlsEnabled;
        localStorage.setItem('omni_mobile_controls', this.mobileControlsEnabled);
        document.getElementById('mobile-toggle').classList.toggle('active');
        document.getElementById('mobile-controls').classList.toggle('active');
    },
    
    updateSoundToggle: function() {
        const toggle = document.getElementById('sound-toggle');
        toggle.classList.toggle('active', !AudioSys.muted);
    }
};

function checkRect(a,b) { return a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y; }

GAME.init();
</script>
</body>
</html>
