<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Omniverse: Ultimate Edition</title>
<link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Orbitron:wght@500;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
    :root { 
        --primary: #00f3ff; 
        --danger: #ff0044; 
        --warn: #ffcc00; 
        --hud-bg: rgba(0, 10, 20, 0.95);
    }
    * { box-sizing: border-box; }
    
    body {
        margin: 0; padding: 0;
        overflow: hidden; background: #050505;
        font-family: 'Orbitron', sans-serif;
        display: flex; justify-content: center; align-items: center; 
        height: 100vh; width: 100vw;
        user-select: none;
    }

    #game-container {
        position: relative; 
        width: 100%; max-width: 1280px;
        aspect-ratio: 16/9;
        background: #000; 
        box-shadow: 0 0 80px rgba(0, 243, 255, 0.15);
        border: 2px solid #333;
    }
    
    canvas { 
        display: block; width: 100%; height: 100%; 
        image-rendering: auto; 
    }

    #ui-layer {
        position: absolute; inset: 0; pointer-events: none; padding: 25px;
        display: flex; flex-direction: column; justify-content: space-between; z-index: 10;
    }
    .hud-top { display: flex; justify-content: space-between; width: 100%; align-items: flex-start; }
    
    .stat-panel {
        background: var(--hud-bg); 
        border: 1px solid rgba(255,255,255,0.15);
        padding: 10px 20px; border-radius: 4px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        min-width: 220px;
        pointer-events: auto;
    }
    
    .hp-text { font-size: 2rem; letter-spacing: 5px; color: var(--danger); text-shadow: 0 0 15px var(--danger); }
    .score-box { font-family: 'Share Tech Mono'; font-size: 1.2rem; color: #fff; margin-top: 5px; }
    .score-val { color: var(--primary); font-weight: 900; }

    .bar-group { margin-bottom: 8px; }
    .bar-label { font-size: 0.8rem; color: #888; display: flex; justify-content: space-between; margin-bottom: 2px;}
    .bar-track { width: 100%; height: 8px; background: #222; border: 1px solid #444; border-radius: 2px; overflow: hidden; }
    .bar-fill { height: 100%; transition: width 0.1s linear; }

    #sound-btn {
        background: transparent; border: 1px solid #555; color: #fff;
        cursor: pointer; padding: 5px 10px; font-size: 1.2rem;
        margin-left: 10px; border-radius: 4px; transition: 0.2s;
    }
    #sound-btn:hover { background: #333; border-color: var(--primary); color: var(--primary); }
    .off-sound { opacity: 0.5; text-decoration: line-through; }

    #menu-overlay {
        position: absolute; inset: 0; background: rgba(0,0,0,0.95);
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        z-index: 100; text-align: center; backdrop-filter: blur(10px);
    }
    h1 {
        font-family: 'Black Ops One'; font-size: clamp(3rem, 6vw, 6rem); margin: 0;
        background: linear-gradient(180deg, #fff, #555);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        filter: drop-shadow(0 0 30px var(--primary)); letter-spacing: -2px;
    }
    .menu-panel {
        border-top: 2px solid var(--primary); border-bottom: 2px solid var(--primary); 
        padding: 40px; background: rgba(0, 20, 20, 0.8);
        width: 100%; max-width: 700px;
    }
    .lvl-select { display: flex; gap: 10px; justify-content: center; margin: 20px 0; flex-wrap: wrap; }
    .lvl-btn {
        background: rgba(0,0,0,0.5); border: 1px solid #555; color: #888;
        padding: 10px 20px; cursor: pointer; font-family: 'Orbitron'; transition: 0.2s;
    }
    .lvl-btn.active { background: var(--primary); color: #000; box-shadow: 0 0 15px var(--primary); transform: scale(1.1); border-color: #fff;}

    .start-btn {
        display: inline-block; padding: 20px 60px; font-family: 'Orbitron'; font-size: 1.5rem; font-weight: 900;
        background: var(--danger); border: none; color: white; cursor: pointer; 
        clip-path: polygon(15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%, 0 15px);
        transition: transform 0.1s, filter 0.1s; margin-top: 10px;
    }
    .start-btn:hover { transform: scale(1.05); filter: brightness(1.2); box-shadow: 0 0 30px var(--danger); }
    .hidden { display: none !important; }

    #controls-hint {
        margin-top: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
        text-align: left; font-size: 1rem; color: #aaa;
    }
    .key { color: #fff; border: 1px solid #666; padding: 2px 8px; border-radius: 4px; background: #222; font-family: monospace; }
</style>
</head>
<body>

<div id="game-container">
    <canvas id="cvs" width="1280" height="720"></canvas>

    <div id="ui-layer">
        <div class="hud-top">
            <div class="stat-panel">
                <div class="hp-text" id="hud-hp">‚ù§‚ù§‚ù§</div>
                <div class="score-box">SCORE <span class="score-val" id="hud-score">00000</span></div>
            </div>
            <div class="stat-panel" style="display:flex; gap:15px; align-items:center;">
                <div style="flex-grow:1;">
                    <div class="bar-group">
                        <div class="bar-label"><span>PLASMA</span> <span id="hud-ammo-txt">12</span></div>
                        <div class="bar-track"><div class="bar-fill" id="hud-ammo-bar" style="background:var(--warn)"></div></div>
                    </div>
                    <div class="bar-group">
                        <div class="bar-label"><span>FUEL</span> <span id="hud-fuel-txt">100%</span></div>
                        <div class="bar-track"><div class="bar-fill" id="hud-fuel-bar" style="background:var(--primary)"></div></div>
                    </div>
                </div>
                <button id="sound-btn" onclick="AudioSys.toggle()">üîä</button>
            </div>
        </div>
    </div>

    <div id="menu-overlay">
        <div class="menu-panel">
            <h1>OMNIVERSE</h1>
            <p style="color:var(--primary); font-size: 1.2rem; letter-spacing: 6px; font-weight:bold;">ULTIMATE EDITION</p>
            <div class="lvl-select" id="lvl-container"></div>
            <button class="start-btn" onclick="GAME.start()">INITIALIZE SYSTEM</button>
            <div style="font-size:0.8rem; margin-top:10px; color:#666;">PRESS [SPACE] TO START</div>
            <div id="controls-hint">
                <div>MOVE: <span class="key">‚Üê</span> <span class="key">‚Üí</span></div>
                <div>JUMP: <span class="key">SPACE</span> (Tap)</div>
                <div>JETPACK: <span class="key">SPACE</span> (Hold)</div>
                <div>SHOOT: <span class="key">F</span></div>
            </div>
        </div>
    </div>
</div>

<script>
/* ================= SYSTEM ================= */
const AudioSys = {
    ctx: null,
    muted: false,
    init: function() {
        if(!this.ctx) {
            try { this.ctx = new (window.AudioContext||window.webkitAudioContext)(); } catch(e){}
        }
        const saved = localStorage.getItem('omni_mute');
        if(saved !== null) this.muted = (saved === 'true');
        this.updateBtn();
        if(this.ctx && this.ctx.state==='suspended') this.ctx.resume();
    },
    toggle: function() {
        this.muted = !this.muted;
        localStorage.setItem('omni_mute', this.muted);
        this.updateBtn();
    },
    updateBtn: function() {
        const btn = document.getElementById('sound-btn');
        if(btn) {
            btn.innerHTML = this.muted ? 'üîá' : 'üîä';
            btn.classList.toggle('off-sound', this.muted);
        }
    },
    play: function(t) {
        if(this.muted || !this.ctx) return;
        const o=this.ctx.createOscillator(), g=this.ctx.createGain(), now=this.ctx.currentTime;
        o.connect(g); g.connect(this.ctx.destination);
        
        if(t==='shoot'){ o.type='square'; o.frequency.setValueAtTime(800,now); o.frequency.exponentialRampToValueAtTime(100,now+0.1); g.gain.setValueAtTime(0.05,now); g.gain.linearRampToValueAtTime(0,now+0.1); o.start(now); o.stop(now+0.1); }
        if(t==='laser'){ o.type='sawtooth'; o.frequency.setValueAtTime(1200,now); o.frequency.exponentialRampToValueAtTime(600,now+0.15); g.gain.setValueAtTime(0.05,now); g.gain.linearRampToValueAtTime(0,now+0.15); o.start(now); o.stop(now+0.15); }
        if(t==='jump'){ o.type='sine'; o.frequency.setValueAtTime(200,now); o.frequency.linearRampToValueAtTime(400,now+0.2); g.gain.setValueAtTime(0.1,now); g.gain.linearRampToValueAtTime(0,now+0.2); o.start(now); o.stop(now+0.2); }
        if(t==='jet'){ o.type='sawtooth'; o.frequency.setValueAtTime(50,now); g.gain.setValueAtTime(0.05,now); g.gain.linearRampToValueAtTime(0,now+0.1); o.start(now); o.stop(now+0.1); }
        if(t==='boom'){ o.type='sawtooth'; o.frequency.setValueAtTime(100,now); o.frequency.exponentialRampToValueAtTime(10,now+0.4); g.gain.setValueAtTime(0.2,now); g.gain.linearRampToValueAtTime(0,now+0.4); o.start(now); o.stop(now+0.4); }
        if(t==='beep'){ o.type='sine'; o.frequency.setValueAtTime(800,now); g.gain.setValueAtTime(0.1,now); g.gain.linearRampToValueAtTime(0,now+0.1); o.start(now); o.stop(now+0.1); }
        if(t==='charge'){ o.type='triangle'; o.frequency.setValueAtTime(400,now); o.frequency.linearRampToValueAtTime(800,now+0.5); g.gain.setValueAtTime(0.05,now); g.gain.linearRampToValueAtTime(0,now+0.5); o.start(now); o.stop(now+0.5); }
        if(t==='heal'){ o.type='sine'; o.frequency.setValueAtTime(400,now); o.frequency.linearRampToValueAtTime(800,now+0.1); o.frequency.linearRampToValueAtTime(1200,now+0.3); g.gain.setValueAtTime(0.1,now); g.gain.linearRampToValueAtTime(0,now+0.3); o.start(now); o.stop(now+0.3); }
    }
};

const Input = {
    keys: {Left:false, Right:false, Up:false, Fire:false},
    init: function() {
        window.addEventListener('keydown', e => this.handler(e.code, true));
        window.addEventListener('keyup', e => this.handler(e.code, false));
    },
    handler: function(c, s) {
        if(c==='ArrowLeft') this.keys.Left = s;
        if(c==='ArrowRight') this.keys.Right = s;
        if(c==='Space' || c==='ArrowUp') {
            this.keys.Up = s;
            if(s && !this.prevUp) {
                if(!GAME.active) GAME.start();
                else GAME.player.tapJump();
            }
            this.prevUp = s;
        }
        if(c==='KeyF') { if(s && !this.keys.Fire && GAME.active) GAME.player.shoot(); this.keys.Fire = s; }
    },
    prevUp: false
};

/* ================= ENTITIES ================= */
class Particle {
    constructor(x,y,c,s,l,g,type) { 
        this.x=x;this.y=y;this.c=c;
        this.vx=(Math.random()-.5)*s; this.vy=(Math.random()-.5)*s;
        this.l=l;this.ml=l;this.g=g||0; this.type=type||'rect';
        this.size = Math.random()*3+2;
    }
    update() { 
        this.x+=this.vx; this.y+=this.vy; this.vy+=this.g; this.l--; 
        if(this.type==='shock') this.size += 4; 
    }
    draw(ctx) { 
        ctx.globalAlpha=this.l/this.ml; 
        if(this.type==='shock') {
            ctx.strokeStyle = this.c; ctx.lineWidth = 3;
            ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.stroke();
        } else {
            ctx.fillStyle=this.c; ctx.fillRect(this.x,this.y,this.size,this.size); 
        }
        ctx.globalAlpha=1; 
    }
}

class HeartItem {
    constructor() {
        this.x = GAME.W + 50;
        this.y = 100 + Math.random() * (GAME.GroundY - 200);
        this.w = 30; this.h = 30;
        this.vx = 2.5;
        this.tm = 0; this.dead = false;
    }
    update() {
        this.x -= this.vx;
        this.tm += 0.05;
        this.y += Math.sin(this.tm) * 1.5;
        if(this.x < -50) this.dead = true;

        if(checkRect(this, GAME.player)) {
            if(GAME.player.hp < 5) { // Cap HP at 5
                GAME.player.hp++;
                GAME.score += 50;
                AudioSys.play('heal');
                GAME.spawnPart(this.x+15, this.y+15, '#f06', 10, 20, 0);
                GAME.txts.push(new FloatingText(this.x, this.y-20, "HP UP!", "#f06"));
            }
            this.dead = true;
        }
    }
    draw(ctx) {
        ctx.save();
        ctx.translate(this.x+15, this.y+15);
        let s = 1 + Math.sin(this.tm*2)*0.2;
        ctx.scale(s, s);
        
        // Draw Heart
        ctx.shadowBlur = 15; ctx.shadowColor = "#f06";
        ctx.fillStyle = "#ff0066";
        ctx.beginPath();
        ctx.moveTo(0, 5);
        ctx.bezierCurveTo(0, 5, -10, -10, -15, -10);
        ctx.bezierCurveTo(-25, -10, -25, 5, -25, 5);
        ctx.bezierCurveTo(-25, 15, 0, 30, 0, 30);
        ctx.bezierCurveTo(0, 30, 25, 15, 25, 5);
        ctx.bezierCurveTo(25, 5, 25, -10, 15, -10);
        ctx.bezierCurveTo(10, -10, 0, 5, 0, 5);
        ctx.fill();
        
        ctx.restore();
    }
}

class BackMissile {
    constructor(yPos) {
        this.x = -80; this.y = yPos; 
        this.w = 40; this.h = 12;
        this.vx = 9 + (GAME.level*0.5); this.dead = false;
        GAME.txts.push(new FloatingText(150, this.y, "‚ö† INCOMING!", "#f00"));
        AudioSys.play('shoot'); 
    }
    update() {
        this.x += this.vx;
        if(this.x < GAME.player.x) { 
            if(this.y < GAME.player.y) this.y += 1.5;
            if(this.y > GAME.player.y) this.y -= 1.5;
        }
        GAME.spawnPart(this.x, this.y+5, '#f00', 3, 5, 0); 
        if(this.x > GAME.W + 50) this.dead = true;
        if(checkRect(this, GAME.player)) {
            GAME.player.hit(1); this.dead = true;
            GAME.spawnPart(this.x, this.y, '#f00', 20, 20, 0);
        }
    }
    draw(ctx) {
        let grad = ctx.createLinearGradient(this.x, 0, this.x+this.w, 0);
        grad.addColorStop(0, '#555'); grad.addColorStop(1, '#f00');
        ctx.fillStyle = grad;
        ctx.beginPath();
        ctx.moveTo(this.x, this.y); ctx.lineTo(this.x+this.w, this.y+this.h/2); ctx.lineTo(this.x, this.y+this.h);
        ctx.fill();
    }
    hit() { this.dead=true; GAME.score+=200; GAME.spawnPart(this.x,this.y,'#f00',20,30,0.5); AudioSys.play('boom'); }
}

class Bullet {
    constructor(x,y,vx,owner, themeId) { 
        this.x=x;this.y=y;this.vx=vx;this.o=owner;this.dead=false;this.w=20;this.h=6; 
        this.theme = themeId || 'Earth';
    }
    update() { 
        this.x+=this.vx; if(this.x<-50||this.x>GAME.W+50) this.dead=true;
        if(this.o==='enemy') GAME.spawnPart(this.x+this.w,this.y+2,'#f00',1,5,0);
    }
    draw(ctx) { 
        if(this.o === 'enemy') {
            ctx.fillStyle = '#f00'; ctx.fillRect(this.x,this.y,this.w,this.h); 
            return;
        }

        // Theme based Weapon Visuals
        if(this.theme === 'Mars') {
            // LASER
            ctx.fillStyle = '#f00'; ctx.shadowBlur = 10; ctx.shadowColor = '#f00';
            ctx.fillRect(this.x, this.y+1, 40, 4);
        } else if (this.theme === 'Neon') {
            // BEAM
            ctx.fillStyle = '#0ff'; ctx.shadowBlur = 15; ctx.shadowColor = '#0ff';
            ctx.fillRect(this.x, this.y, 30, 8);
            ctx.fillStyle = '#fff'; ctx.fillRect(this.x+5, this.y+2, 20, 4);
        } else if (this.theme === 'Space') {
            // PLASMA PULSE
            ctx.fillStyle = '#0f0'; ctx.shadowBlur = 10; ctx.shadowColor = '#0f0';
            ctx.beginPath(); ctx.arc(this.x+10, this.y+3, 8, 0, Math.PI*2); ctx.fill();
        } else {
            // STANDARD BULLET (EARTH)
            ctx.fillStyle = '#ffcc00'; ctx.shadowBlur = 0;
            ctx.fillRect(this.x, this.y, this.w, this.h);
        }
        ctx.shadowBlur = 0; // Reset
    }
}

class Player {
    constructor() {
        this.w=40; this.h=50; this.x=200; this.y=0; this.vx=0; this.vy=0;
        this.hp=3; this.fuel=100; this.ammo=12; 
        this.grounded=false; this.invuln=0; this.walkCycle=0;
        this.jumpCount=0; this.reloadTimer=0;
    }
    update() {
        if(Input.keys.Left) { this.vx -= 0.8; this.walkCycle += 0.4; } 
        else if(Input.keys.Right) { this.vx += 0.8; this.walkCycle += 0.4; } 
        else { this.vx *= 0.85; this.walkCycle = 0; }

        this.vx = Math.max(-9, Math.min(9, this.vx));
        this.x = Math.max(0, Math.min(GAME.W-this.w, this.x+this.vx));

        if(Input.keys.Up && !this.grounded && this.fuel>0) {
            this.vy -= 0.9; this.fuel -= 1.2;
            GAME.spawnPart(this.x+10, this.y+45, '#0ff', 4, 10, 0.5);
            if(GAME.frames%6===0) AudioSys.play('jet');
        } else if(this.grounded && this.fuel<100) this.fuel += 0.6;

        let g = (GAME.themes[GAME.themeIdx].id === 'Mars') ? 0.25 : 0.45;
        this.vy += g;
        this.y += this.vy;

        if(this.y < 0) { this.y = 0; if(this.vy < 0) this.vy = 0; }
        if(this.y+this.h > GAME.GroundY) {
            this.y = GAME.GroundY - this.h; this.vy = 0; 
            this.grounded = true; this.jumpCount=0;
        } else this.grounded = false;

        if(this.ammo < 12) {
            this.reloadTimer++;
            if(this.reloadTimer > 40) { this.ammo++; this.reloadTimer=0; }
        }

        if(this.invuln>0) this.invuln--;
        this.updateHUD();
    }
    tapJump() {
        if(this.grounded || this.jumpCount < 2) {
            this.vy = -12; this.jumpCount++; this.grounded=false;
            AudioSys.play('jump');
            GAME.spawnPart(this.x+20, this.y+50, '#fff', 5, 20, 0);
        }
    }
    shoot() {
        if(this.ammo>0) {
            this.ammo--; 
            let t = GAME.themes[GAME.themeIdx].id;
            GAME.bulls.push(new Bullet(this.x+40, this.y+15, 15, 'player', t));
            AudioSys.play('shoot'); 
            this.reloadTimer=0;
        }
    }
    hit(d) {
        if(this.invuln>0) return;
        this.hp-=d; this.invuln=60; GAME.shake=15; AudioSys.play('boom');
        if(this.hp<=0) GAME.over();
    }
    updateHUD() {
        document.getElementById('hud-hp').innerText = "‚ù§".repeat(Math.max(0,this.hp));
        document.getElementById('hud-score').innerText = GAME.score.toString().padStart(5,'0');
        document.getElementById('hud-ammo-bar').style.width = (this.ammo/12*100)+"%";
        document.getElementById('hud-fuel-bar').style.width = this.fuel+"%";
        document.getElementById('hud-ammo-txt').innerText = this.ammo;
    }
    draw(ctx) {
        if(this.invuln>0 && Math.floor(GAME.frames/4)%2) return;
        let legOffset = Math.sin(this.walkCycle) * 10;
        
        ctx.save();
        ctx.translate(this.x+this.w/2, this.y+this.h/2);
        ctx.rotate(this.vx * 0.02);
        ctx.translate(-(this.x+this.w/2), -(this.y+this.h/2));

        // Legs
        ctx.fillStyle = '#999';
        if(this.grounded) {
            ctx.fillRect(this.x+8 + legOffset, this.y+40, 8, 10); 
            ctx.fillRect(this.x+24 - legOffset, this.y+40, 8, 10);
        } else {
            ctx.fillRect(this.x+8, this.y+40, 8, 8); 
            ctx.fillRect(this.x+24, this.y+45, 8, 8); // Jet pose
        }

        // Body Gradient
        let grad = ctx.createLinearGradient(this.x, this.y, this.x, this.y+this.h);
        grad.addColorStop(0, '#fff'); grad.addColorStop(1, '#aaa');
        ctx.fillStyle = grad; 
        ctx.fillRect(this.x, this.y, this.w, this.h-10);

        // Visor
        ctx.fillStyle = '#333'; ctx.fillRect(this.x+15, this.y+8, 25, 12);
        ctx.fillStyle = '#0ff'; ctx.fillRect(this.x+18, this.y+10, 20, 5); // Visor Glow

        // Jetpack
        ctx.fillStyle = '#555'; ctx.fillRect(this.x-6, this.y+10, 6, 30);
        ctx.fillStyle = this.fuel>20 ? '#0f0' : '#f00'; 
        ctx.shadowBlur=5; ctx.shadowColor=ctx.fillStyle;
        ctx.fillRect(this.x-6, this.y+15, 3, 5);
        ctx.shadowBlur=0;
        
        ctx.restore();
    }
}

class Enemy {
    constructor(t) {
        this.t=t; this.dead=false; this.x=GAME.W+50; this.w=40; this.h=40; this.hp=1; this.tm=0;
        this.yBase = 50 + Math.random() * (GAME.GroundY - 150);
        this.yPhase = Math.random() * Math.PI;
        this.beamTimer = 0; 
        
        this.bombTimer = 0; 
        this.triggered = false;
        
        if(t==='dragon') { this.w=50; this.h=40; this.hp=2; } 
        else if(t==='ufo') { this.w=60; this.h=30; this.hp=2; }
        else if(t==='tnt') { this.y=GAME.GroundY-30; this.w=30; this.h=30; this.hp=2; }
        else if(t==='traitor') { this.y=GAME.GroundY-60; this.h=50; this.hp=2; this.fired=false; }
        else this.y=GAME.GroundY-40; 
    }
    update() {
        if(this.t !== 'ufo' || this.beamTimer <= 0) {
            let spd = (this.t === 'tnt') ? (2 + GAME.level*0.5) : (3 + GAME.level * 0.8);
            this.x -= spd; 
        }
        this.tm++;
        
        // == TNT LOGIC ==
        if(this.t === 'tnt') {
             let centerX = this.x + this.w/2;
             let pCenterX = GAME.player.x + GAME.player.w/2;
             let dist = Math.abs(centerX - pCenterX);
             
             if(!this.triggered && dist < 150) {
                 this.triggered = true;
                 this.bombTimer = 90;
             }
             if(this.triggered) {
                 this.bombTimer--;
                 if(this.bombTimer % 15 === 0) AudioSys.play('beep'); 
                 if(this.bombTimer <= 0) {
                     this.hit(true); 
                 }
             }
        }

        if(this.t==='traitor' && this.x < -10 && !this.fired) {
            this.fired = true;
            GAME.ents.push(new BackMissile(this.y + 10));
            GAME.spawnPart(this.x+40, this.y+10, '#fff', 5, 20, 0); 
        }

        if(this.t==='dragon') {
            this.y = this.yBase + Math.sin(this.tm * 0.05 + this.yPhase) * 60;
        }
        
        if(this.t==='ufo') {
            this.y = this.yBase + Math.sin(this.tm * 0.04) * 80;
            if(this.beamTimer === 0 && Math.random() < 0.005) {
                this.beamTimer = 100; AudioSys.play('charge');
            }
            if(this.beamTimer > 0) {
                this.beamTimer--;
                if(this.beamTimer < 40) {
                    if(GAME.player.x < this.x+this.w && GAME.player.x+GAME.player.w > this.x) {
                        GAME.player.hit(1); 
                    }
                }
            }
        }
        
        if(this.x < -200) this.dead=true;

        // == COLLISION & STOMP LOGIC ==
        if(checkRect(this, GAME.player)) {
            let playerBottom = GAME.player.y + GAME.player.h;
            let enemyCenterY = this.y + this.h * 0.5;
            
            // STOMP CONDITION:
            // 1. Player is falling (vy > 0)
            // 2. Player is NOT touching TNT (TNT hurts always)
            // 3. Player's bottom is roughly above the enemy's center (forgiving angle)
            let isStomp = (GAME.player.vy > 0) && 
                          (this.t !== 'tnt') && 
                          (playerBottom < enemyCenterY + 15); // +15 forgiveness
            
            if(isStomp) {
                this.hit(); 
                GAME.player.vy = -8; // Bounce
                GAME.spawnPart(this.x+this.w/2, this.y, '#fff', 5, 10, 0.5);
                AudioSys.play('jump');
            } else {
                if(this.t==='tnt') {
                     this.hit(true); // Force TNT explosion
                } else {
                     GAME.player.hit(1);
                     this.hit(true); // Enemy destroys
                }
            }
        }
    }
    
    hit(forceKill) {
        this.hp--; 
        if(this.hp > 0 && !forceKill) {
            this.y += 10; AudioSys.play('jump'); GAME.spawnPart(this.x+20,this.y+20,'#fff',3,5,0);
        } else {
            this.dead=true; 
            if(!forceKill) GAME.score += (this.t==='dragon'?500:100);
            
            if(this.t === 'traitor' || this.t === 'tnt') {
                GAME.spawnPart(this.x, this.y, '#ff4400', 10, 50, 0, 'shock');
                for(let i=0; i<30; i++) GAME.spawnPart(this.x+15, this.y+15, Math.random()>.5?'#f00':'#ff0', 15, 50, 0.5);
                GAME.shake = 20;
                AudioSys.play('boom');

                let dx = (this.x+this.w/2) - (GAME.player.x+GAME.player.w/2);
                let dy = (this.y+this.h/2) - (GAME.player.y+GAME.player.h/2);
                let dist = Math.sqrt(dx*dx + dy*dy);
                if(dist < 180) {
                    GAME.player.hit(1);
                    GAME.txts.push(new FloatingText(GAME.player.x, GAME.player.y-50, "BLAST HIT!", "#f00"));
                }
            } else {
                GAME.spawnPart(this.x,this.y,this.t==='ufo'?'#0f0':'#fc0', 20, 20, 0.5);
                AudioSys.play('boom');
            }
        }
    }
    
    draw(ctx) {
        if(this.t==='dragon') {
            let wingOffset = Math.sin(this.tm * 0.3) * 15;
            let grad = ctx.createLinearGradient(this.x,this.y,this.x,this.y+30);
            grad.addColorStop(0, '#e55'); grad.addColorStop(1, '#800');
            ctx.fillStyle = grad; 
            ctx.beginPath(); ctx.ellipse(this.x+25, this.y+20, 20, 12, 0, 0, Math.PI*2); ctx.fill();
            // Beak
            ctx.fillStyle = '#ff0'; ctx.beginPath(); ctx.moveTo(this.x, this.y+20); ctx.lineTo(this.x+10, this.y+15); ctx.lineTo(this.x+10, this.y+25); ctx.fill();
            // Wing
            ctx.fillStyle = '#a00'; 
            ctx.beginPath(); ctx.moveTo(this.x+25, this.y+15); ctx.lineTo(this.x+15, this.y-10+wingOffset); ctx.lineTo(this.x+40, this.y+15); ctx.fill();
            // Eye
            ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(this.x+15, this.y+15, 3, 0, Math.PI*2); ctx.fill();

        } else if(this.t==='tnt') {
            let flash = (this.triggered && Math.floor(this.bombTimer/5)%2===0);
            ctx.fillStyle= flash ? '#fff' : '#B22222'; 
            ctx.fillRect(this.x, this.y, this.w, this.h); 
            ctx.fillStyle='#800000'; ctx.fillRect(this.x, this.y+10, this.w, 4); 
            ctx.fillRect(this.x, this.y+20, this.w, 4);
            if(this.triggered) {
                ctx.fillStyle = '#f00'; ctx.font="bold 12px monospace"; 
                ctx.fillText((this.bombTimer/60).toFixed(1), this.x+5, this.y-10);
            } else {
                ctx.fillStyle='#ff0'; ctx.font="bold 10px Arial"; ctx.fillText("TNT", this.x+5, this.y+18);
            }

        } else if(this.t==='ufo') {
            if(this.beamTimer > 0) {
                let alpha = this.beamTimer > 40 ? 0.2 : 0.7;
                ctx.fillStyle = `rgba(255,0,0,${alpha})`;
                ctx.fillRect(this.x+15, this.y+20, 30, GAME.GroundY - this.y);
            }
            // Dome
            ctx.fillStyle='#0f0'; ctx.beginPath(); ctx.arc(this.x+30,this.y+15,18,Math.PI,0); ctx.fill(); 
            // Body
            let grad = ctx.createLinearGradient(this.x, this.y, this.x, this.y+30);
            grad.addColorStop(0, '#888'); grad.addColorStop(1, '#333');
            ctx.fillStyle=grad; 
            ctx.beginPath(); ctx.ellipse(this.x+30,this.y+15,35,10,0,0,Math.PI*2); ctx.fill();
            // Lights
            ctx.fillStyle = (Math.floor(this.tm/10)%2===0) ? '#f00' : '#ff0';
            ctx.beginPath(); ctx.arc(this.x+10, this.y+15, 3, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(this.x+50, this.y+15, 3, 0, Math.PI*2); ctx.fill();

        } else if(this.t==='traitor') {
            // Robo Enemy
            let grad = ctx.createLinearGradient(this.x, this.y, this.x+this.w, this.y);
            grad.addColorStop(0, '#444'); grad.addColorStop(1, '#222');
            ctx.fillStyle=grad; ctx.fillRect(this.x,this.y+10,this.w,40); 
            // Tracks
            ctx.fillStyle='#111'; ctx.fillRect(this.x-2,this.y+45,this.w+4,8); 
            // Red Eye
            ctx.fillStyle='#f00'; ctx.shadowBlur=10; ctx.shadowColor='#f00';
            ctx.fillRect(this.x+10,this.y+15,20,5); 
            ctx.shadowBlur=0;
            // Antenna
            ctx.fillStyle='#888'; ctx.fillRect(this.x+15,this.y-5,2,15);

        } else {
            this.drawCar(ctx, GAME.themes[GAME.themeIdx].id);
        }
    }

    drawCar(ctx, theme) {
        if(theme === 'Earth' || theme === 'Neon') {
            let cMain = theme==='Earth' ? '#eec' : '#309';
            let cTop = theme==='Earth' ? '#cca' : '#60c';
            ctx.fillStyle = cMain; ctx.fillRect(this.x, this.y+15, 40, 15); 
            ctx.fillStyle = cTop;  ctx.fillRect(this.x+5, this.y, 25, 15); 
            ctx.fillStyle = '#222'; 
            ctx.beginPath(); ctx.arc(this.x+10, this.y+30, 6, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(this.x+30, this.y+30, 6, 0, Math.PI*2); ctx.fill();
            if(theme === 'Neon') {
                ctx.fillStyle='#0ff'; ctx.shadowBlur=5; ctx.shadowColor='#0ff';
                ctx.fillRect(this.x, this.y+28, 40, 2); 
                ctx.shadowBlur=0;
            }
        } else if (theme === 'Mars') {
            // Mars Rover
            ctx.fillStyle = '#842'; ctx.fillRect(this.x, this.y+5, 40, 15);
            ctx.fillStyle = '#111'; 
            ctx.beginPath(); ctx.arc(this.x+8, this.y+30, 8, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(this.x+32, this.y+30, 8, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle='#aaa'; ctx.beginPath(); ctx.moveTo(this.x+10, this.y+5); ctx.lineTo(this.x+5, this.y-10); ctx.stroke();
        } else {
            // Space Bubble
            let grad = ctx.createRadialGradient(this.x+20, this.y+20, 5, this.x+20, this.y+20, 20);
            grad.addColorStop(0, '#fff'); grad.addColorStop(1, '#888');
            ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(this.x+20, this.y+20, 15, 0, Math.PI*2); ctx.fill();
            
            ctx.fillStyle = '#55f'; ctx.beginPath(); ctx.arc(this.x+20, this.y+20, 8, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#999'; ctx.fillRect(this.x+5, this.y+30, 5, 10); ctx.fillRect(this.x+30, this.y+30, 5, 10);
        }
    }
}

class FloatingText {
    constructor(x,y,t,c) { this.x=x;this.y=y;this.t=t;this.c=c;this.l=60; }
    update() { this.y-=1; this.l--; }
    draw(ctx) { ctx.globalAlpha=this.l/60; ctx.fillStyle=this.c; ctx.font="bold 20px Orbitron"; ctx.fillText(this.t,this.x,this.y); ctx.globalAlpha=1; }
}

const GAME = {
    cvs: document.getElementById('cvs'), ctx: document.getElementById('cvs').getContext('2d'),
    W: 1280, H: 720, GroundY: 640, Gravity: 0.6,
    active: false, frames: 0, score: 0, level: 3, shake: 0,
    player: null, ents: [], bulls: [], parts: [], txts: [], 
    
    themes: [
        {id:'Earth', sky:['#87CEEB','#E0F7FA'], ground:'#228B22'},
        {id:'Mars', sky:['#4a0e0e','#1a0505'], ground:'#8B4513'},
        {id:'Neon', sky:['#1a0033','#000'], ground:'#ff00ff'},
        {id:'Space', sky:['#000','#001'], ground:'#333'}
    ],
    themeIdx: 0,
    bgLayer1: [], bgLayer2: [],

    init: function() {
        Input.init(); AudioSys.init();
        const c = document.getElementById('lvl-container');
        for(let i=1; i<=5; i++) {
            let b = document.createElement('div');
            b.className = i===3 ? 'lvl-btn active' : 'lvl-btn';
            b.innerText = "LVL "+i;
            b.onclick = () => { GAME.level = i; document.querySelectorAll('.lvl-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); };
            c.appendChild(b);
        }
        this.ctx.fillStyle = '#000'; this.ctx.fillRect(0,0,this.W,this.H);
        this.ctx.fillStyle = '#00f3ff'; this.ctx.font = '30px Orbitron';
        this.ctx.fillText("SYSTEM READY", 50, 50);
    },

    start: function() {
        this.active = true; this.score = 0; this.frames = 0; 
        this.player = new Player();
        this.ents = []; this.bulls = []; this.parts = []; this.txts = [];
        this.bgLayer1 = []; this.bgLayer2 = [];
        AudioSys.init();
        document.getElementById('menu-overlay').classList.add('hidden');
        this.loop();
    },

    spawnPart: function(x,y,c,s,l,g,t) { for(let i=0;i<5;i++) this.parts.push(new Particle(x,y,c,s,l,g,t)); },

    update: function() {
        this.frames++;
        if(this.frames % 1200 === 0) {
            this.themeIdx = (this.themeIdx + 1) % 4;
            this.txts.push(new FloatingText(this.W/2-50, 200, "WARP: " + this.themes[this.themeIdx].id.toUpperCase(), "#fff"));
        }
        if(this.frames % 200 === 0) this.bgLayer1.push({x:this.W, type:'mountain'}); 
        if(this.frames % 60 === 0) this.bgLayer2.push({x:this.W, type:'tree'});
        if(this.frames % 1200 === 100) this.bgLayer1.push({x:this.W, type:'brand'});

        let currentDifficulty = GAME.level + Math.floor(GAME.score/2000);
        let spawnRate = Math.max(20, 80 - (currentDifficulty * 8));

        // Enemy Spawn
        if(this.frames % spawnRate === 0) {
            let r=Math.random();
            if(r<0.15) this.ents.push(new Enemy('dragon')); 
            else if(r<0.3) this.ents.push(new Enemy('ufo'));
            else if(r<0.6) this.ents.push(new Enemy('traitor'));
            else if(r<0.7) this.ents.push(new Enemy('tnt'));
            else this.ents.push(new Enemy('basic')); 
        }

        // Heart Spawn (Ample amount)
        if(this.frames % 600 === 0) { // Approx every 10 seconds
            this.ents.push(new HeartItem());
        }

        this.player.update();
        this.ents.forEach(e=>e.update()); this.ents=this.ents.filter(e=>!e.dead);
        this.bulls.forEach(b=>{
            b.update();
            if(b.o==='player') {
                this.ents.forEach(e=>{ if(!b.dead && !e.dead && !(e instanceof HeartItem) && checkRect(b,e)) { b.dead=true; e.hit(); }});
                this.ents.forEach(e=>{ if(!b.dead && e instanceof BackMissile && checkRect(b,e)) { b.dead=true; e.hit(); }});
            } else if (checkRect(b, GAME.player)) { b.dead=true; GAME.player.hit(1); }
        });
        this.bulls=this.bulls.filter(b=>!b.dead);
        this.parts.forEach(p=>p.update()); this.parts=this.parts.filter(p=>p.l>0);
        this.txts.forEach(t=>t.update()); this.txts=this.txts.filter(t=>t.l>0);
        this.bgLayer1.forEach(b => b.x -= 0.5); this.bgLayer1 = this.bgLayer1.filter(b=>b.x > -500);
        this.bgLayer2.forEach(b => b.x -= 2);   this.bgLayer2 = this.bgLayer2.filter(b=>b.x > -200);
        if(this.shake>0) this.shake*=0.9;
        if(this.score > 0 && this.score % 1000 === 0) this.txts.push(new FloatingText(this.W/2, 100, "SPEED UP!", "#0ff"));
    },

    draw: function() {
        let t = this.themes[this.themeIdx];
        let g = this.ctx.createLinearGradient(0,0,0,this.H); g.addColorStop(0,t.sky[0]); g.addColorStop(1,t.sky[1]);
        this.ctx.fillStyle = g; this.ctx.fillRect(0,0,this.W,this.H);
        this.ctx.save();
        if(this.shake>0.5) this.ctx.translate((Math.random()-.5)*this.shake, (Math.random()-.5)*this.shake);

        if(t.id==='Mars') {
            this.ctx.fillStyle = "rgba(200,50,50,0.4)";
            this.ctx.beginPath(); this.ctx.arc(this.W-200, 150, 40, 0, Math.PI*2); this.ctx.fill();
            this.ctx.beginPath(); this.ctx.arc(this.W-100, 250, 20, 0, Math.PI*2); this.ctx.fill();
        }
        
        this.bgLayer1.forEach(b => {
            if(b.type==='mountain') {
                this.ctx.fillStyle = "rgba(0,0,0,0.3)";
                this.ctx.beginPath(); this.ctx.moveTo(b.x, this.GroundY); 
                this.ctx.lineTo(b.x+150, this.GroundY-200); this.ctx.lineTo(b.x+300, this.GroundY); this.ctx.fill();
            } else if (b.type==='brand') { this.drawBrand(b.x, t.id); }
        });

        this.bgLayer2.forEach(b => {
            this.ctx.fillStyle = "#5D4037"; this.ctx.fillRect(b.x+8, this.GroundY-30, 14, 30); 
            this.ctx.fillStyle = "#2E7D32"; this.ctx.beginPath(); this.ctx.moveTo(b.x-15, this.GroundY-30); 
            this.ctx.lineTo(b.x+15, this.GroundY-110); this.ctx.lineTo(b.x+45, this.GroundY-30); this.ctx.fill();
        });

        // Ground
        this.ctx.fillStyle = t.ground; this.ctx.fillRect(0, this.GroundY, this.W, this.H-this.GroundY);
        // Ground Shine
        this.ctx.fillStyle = "rgba(255,255,255,0.05)"; this.ctx.fillRect(0, this.GroundY, this.W, 10);

        this.ents.forEach(e=>e.draw(this.ctx));
        this.bulls.forEach(b=>b.draw(this.ctx));
        this.player.draw(this.ctx);
        this.parts.forEach(p=>p.draw(this.ctx));
        this.txts.forEach(t=>t.draw(this.ctx));
        this.ctx.restore();
    },

    drawBrand: function(x, id) {
        this.ctx.save(); this.ctx.translate(x, 250);
        if(id==='Earth') {
            this.ctx.fillStyle="#fff"; this.ctx.font="900 50px Arial"; this.ctx.fillText("OMNI",0,0);
            this.ctx.fillStyle="#333"; this.ctx.fillRect(0,10,400,10);
        } else if(id==='Mars') {
            this.ctx.rotate(-0.3);
            this.ctx.fillStyle="#ccc"; this.ctx.fillRect(0,0,80,30);
            this.ctx.fillStyle="red"; this.ctx.beginPath(); this.ctx.moveTo(80,0); this.ctx.lineTo(100,15); this.ctx.lineTo(80,30); this.ctx.fill();
            this.ctx.fillStyle="#000"; this.ctx.font="bold 16px Arial"; this.ctx.fillText("BASE", 10, 20);
        } else if(id==='Neon') {
            this.ctx.fillStyle="#000"; this.ctx.fillRect(0,0,300,80);
            this.ctx.strokeStyle="#0ff"; this.ctx.lineWidth=4; this.ctx.strokeRect(0,0,300,80);
            this.ctx.fillStyle="#f0f"; this.ctx.font="30px Orbitron"; this.ctx.fillText("NEON CITY", 30, 50);
        } else {
             this.ctx.fillStyle="#222"; this.ctx.fillRect(0,0,150,50);
             this.ctx.fillStyle="#0f0"; this.ctx.font="20px monospace"; this.ctx.fillText("STATION_9", 10, 30);
        }
        this.ctx.restore();
    },

    loop: function() {
        if(!this.active) return;
        requestAnimationFrame(()=>this.loop());
        this.update(); this.draw();
    },

    over: function() {
        this.active=false;
        document.getElementById('menu-overlay').classList.remove('hidden');
        document.querySelector('h1').innerText="GAME OVER";
    }
};

function checkRect(a,b) { return a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y; }

GAME.init();
</script>
</body>
</html>
