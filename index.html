<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Omniverse: Hardcore Edition</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéÆ</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Orbitron:wght@500;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
    :root { 
        --primary: #00f3ff; 
        --danger: #ff0044; 
        --warn: #ffcc00; 
        --bg: #050505;
        --hud-bg: rgba(0, 20, 40, 0.85);
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
        margin: 0; overflow: hidden; background: var(--bg);
        font-family: 'Orbitron', sans-serif;
        display: flex; justify-content: center; align-items: center; 
        height: 100vh; height: 100svh; /* Mobile viewport fix */
        user-select: none; touch-action: none;
    }

    /* GAME CONTAINER - Aspect Ratio Lock */
    #game-container {
        position: relative; 
        width: 100%; height: 100%; 
        max-width: 1280px; max-height: 720px;
        background: #000; 
        box-shadow: 0 0 100px rgba(0, 243, 255, 0.1);
        overflow: hidden;
    }
    
    canvas { display: block; width: 100%; height: 100%; image-rendering: auto; }

    /* HUD LAYER */
    #ui-layer {
        position: absolute; inset: 0; pointer-events: none; padding: 15px;
        display: flex; flex-direction: column; justify-content: space-between; z-index: 10;
    }
    
    .hud-top { 
        display: flex; justify-content: space-between; align-items: flex-start;
        width: 100%;
    }
    
    .stat-panel {
        background: var(--hud-bg); 
        border: 1px solid rgba(255,255,255,0.2);
        padding: 10px 15px; border-radius: 6px;
        backdrop-filter: blur(4px);
        min-width: 140px;
    }

    .hp-container { font-size: 1.5rem; letter-spacing: 2px; color: var(--danger); text-shadow: 0 0 10px var(--danger); margin-bottom: 5px; }
    .score-txt { font-size: 1rem; color: #fff; font-family: 'Share Tech Mono'; }
    .score-val { color: var(--primary); font-weight: bold; }

    .bar-label { font-size: 0.7rem; color: #aaa; margin-top: 5px; display: flex; justify-content: space-between; }
    .progress-track { width: 100%; height: 6px; background: #222; border: 1px solid #444; margin-top: 2px; border-radius: 2px; overflow: hidden; }
    .progress-fill { height: 100%; width: 100%; transition: width 0.1s linear; }

    /* MOBILE CONTROLS - FIXED POSITIONING */
    #mobile-controls {
        position: absolute; inset: 0; pointer-events: none; z-index: 20; display: none;
    }
    
    .control-cluster {
        position: absolute; pointer-events: auto; display: flex; gap: 15px;
    }
    .left-cluster { bottom: 30px; left: 30px; }
    .right-cluster { bottom: 30px; right: 30px; align-items: flex-end; }

    /* BUTTON STYLES */
    .btn {
        width: 70px; height: 70px; border-radius: 50%;
        background: rgba(255, 255, 255, 0.1); 
        border: 2px solid rgba(255,255,255,0.3);
        color: white; font-size: 24px; 
        display: flex; justify-content: center; align-items: center;
        backdrop-filter: blur(5px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        transition: transform 0.1s, background 0.1s;
    }
    .btn:active { transform: scale(0.9); background: rgba(0, 243, 255, 0.2); border-color: var(--primary); }
    
    .btn-fire { border-color: var(--danger); color: var(--danger); width: 80px; height: 80px; margin-right: 10px; margin-bottom: 10px;}
    .btn-jump { border-color: var(--primary); color: var(--primary); width: 90px; height: 90px; font-size: 30px; }
    .btn-up { 
        position: absolute; bottom: 110px; right: 10px; 
        width: 60px; height: 60px; border-color: #fff; color: #fff; 
        background: rgba(255,255,255,0.15);
    }

    /* MENUS */
    #menu-overlay {
        position: absolute; inset: 0; background: rgba(0,0,0,0.92);
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        z-index: 100; text-align: center;
    }
    
    h1 {
        font-family: 'Black Ops One'; font-size: 3.5rem; margin: 0;
        background: linear-gradient(180deg, #fff, #888);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        filter: drop-shadow(0 0 20px var(--primary));
    }
    
    .menu-panel {
        border: 1px solid var(--primary); padding: 30px;
        background: rgba(0, 20, 20, 0.6);
        box-shadow: 0 0 50px rgba(0,243,255,0.1);
        max-width: 90%;
    }

    .start-btn {
        display: block; width: 100%; margin: 10px 0;
        padding: 15px; font-family: 'Orbitron'; font-size: 1.2rem; font-weight: 900;
        background: var(--danger); border: none; color: white;
        cursor: pointer; clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
    }
    .start-btn:hover { filter: brightness(1.2); }
    .btn-mobile { background: var(--warn); color: #000; }

    .hidden { display: none !important; }
    
    /* ROTATION WARNING */
    @media (orientation: portrait) {
        #menu-overlay::before {
            content: "‚ö†Ô∏è ROTATE DEVICE FOR BEST EXPERIENCE";
            display: block; margin-bottom: 20px; color: var(--warn); font-size: 0.9rem;
        }
    }
</style>
</head>
<body>

<div id="game-container">
    <canvas id="cvs"></canvas>

    <div id="ui-layer">
        <div class="hud-top">
            <div class="stat-panel">
                <div class="hp-container" id="hud-hp">‚ù§‚ù§‚ù§</div>
                <div class="score-txt">SCORE: <span class="score-val" id="hud-score">0</span></div>
            </div>
            <div class="stat-panel" style="text-align: right;">
                <div class="bar-label"><span>PLASMA</span> <span id="hud-ammo-txt">12/12</span></div>
                <div class="progress-track"><div class="progress-fill" id="hud-ammo-bar" style="background:var(--warn)"></div></div>
                
                <div class="bar-label"><span>JET FUEL</span></div>
                <div class="progress-track"><div class="progress-fill" id="hud-fuel-bar" style="background:var(--primary)"></div></div>
            </div>
        </div>
    </div>

    <div id="mobile-controls">
        <div class="control-cluster left-cluster">
            <div class="btn" id="btn-left">‚Üê</div>
            <div class="btn" id="btn-right">‚Üí</div>
        </div>
        <div class="control-cluster right-cluster">
            <div class="btn btn-up" id="btn-up">‚Üë</div>
            <div class="btn btn-fire" id="btn-fire">üî•</div>
            <div class="btn btn-jump" id="btn-jump">üöÄ</div>
        </div>
    </div>

    <div id="menu-overlay">
        <div class="menu-panel">
            <h1>OMNIVERSE</h1>
            <p style="color:var(--primary); font-size: 0.9rem; letter-spacing: 4px; margin-bottom: 30px;">HARDCORE EDITION</p>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;">
                <button class="start-btn" onclick="APP.start(false)">PLAY PC</button>
                <button class="start-btn btn-mobile" onclick="APP.start(true)">PLAY MOBILE</button>
            </div>
            <div style="color:#666; font-size: 0.8rem;">
                CONTROLS: ARROWS + SPACE + F <br>
                FEATURES: JETPACK HOVER, AUTO-RELOAD, BOSSES
            </div>
        </div>
    </div>
</div>

<script>
/**
 * ============================================================================
 * 1000+ LOGIC DEPTH: MODULAR ARCHITECTURE
 * ============================================================================
 */

/* --- AUDIO MANAGER --- */
const AudioSys = {
    ctx: null,
    init: function() {
        if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        if(this.ctx.state === 'suspended') this.ctx.resume();
    },
    playTone: function(type) {
        if(!this.ctx) return;
        const t = this.ctx.currentTime;
        const o = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        o.connect(g); g.connect(this.ctx.destination);

        if(type === 'shoot') {
            o.type = 'square'; o.frequency.setValueAtTime(400, t); 
            o.frequency.exponentialRampToValueAtTime(100, t + 0.1);
            g.gain.setValueAtTime(0.05, t); g.gain.linearRampToValueAtTime(0, t + 0.1);
            o.start(t); o.stop(t + 0.1);
        } else if (type === 'jump') {
            o.type = 'sine'; o.frequency.setValueAtTime(200, t);
            o.frequency.linearRampToValueAtTime(400, t + 0.15);
            g.gain.setValueAtTime(0.1, t); g.gain.linearRampToValueAtTime(0, t + 0.15);
            o.start(t); o.stop(t + 0.15);
        } else if (type === 'rocket') {
            o.type = 'sawtooth'; o.frequency.setValueAtTime(100, t);
            g.gain.setValueAtTime(0.05, t); g.gain.exponentialRampToValueAtTime(0.01, t + 0.5);
            o.start(t); o.stop(t + 0.5);
        } else if (type === 'explosion') {
            o.type = 'sawtooth'; o.frequency.setValueAtTime(100, t);
            o.frequency.exponentialRampToValueAtTime(10, t + 0.3);
            g.gain.setValueAtTime(0.2, t); g.gain.linearRampToValueAtTime(0, t + 0.3);
            o.start(t); o.stop(t + 0.3);
        }
    }
};

/* --- INPUT HANDLER --- */
const Input = {
    keys: { Up: false, Down: false, Left: false, Right: false, Jump: false, Fire: false },
    touchactive: false,
    
    init: function() {
        window.addEventListener('keydown', e => this.handleKey(e.code, true));
        window.addEventListener('keyup', e => this.handleKey(e.code, false));
        
        // Mobile Bindings with Passive False for Chrome Fix
        this.bindTouch('btn-left', 'Left');
        this.bindTouch('btn-right', 'Right');
        this.bindTouch('btn-up', 'Up'); // 3. Jetpack Hover Input
        this.bindTouch('btn-jump', 'Jump');
        this.bindTouch('btn-fire', 'Fire');
    },
    
    handleKey: function(code, state) {
        if(code === 'ArrowUp') this.keys.Up = state;
        if(code === 'ArrowDown') this.keys.Down = state;
        if(code === 'ArrowLeft') this.keys.Left = state;
        if(code === 'ArrowRight') this.keys.Right = state;
        if(code === 'Space') this.keys.Jump = state;
        if(code === 'KeyF') { if(state && !this.keys.Fire) GAME.player.shoot(); this.keys.Fire = state; }
    },
    
    bindTouch: function(id, key) {
        const el = document.getElementById(id);
        if(!el) return;
        el.addEventListener('touchstart', (e) => { 
            e.preventDefault(); 
            this.keys[key] = true;
            if(key === 'Fire') GAME.player.shoot();
            if(key === 'Jump') GAME.player.jump();
        }, {passive: false});
        el.addEventListener('touchend', (e) => { 
            e.preventDefault(); 
            this.keys[key] = false; 
        }, {passive: false});
    }
};

/* --- ENTITY CLASSES --- */
class Particle {
    constructor(x, y, color, speed, life, type) {
        this.x = x; this.y = y; this.color = color;
        this.vx = (Math.random() - 0.5) * speed;
        this.vy = (Math.random() - 0.5) * speed;
        this.life = life; this.maxLife = life;
        this.type = type || 'dust';
    }
    update() {
        this.x += this.vx; this.y += this.vy;
        this.life--;
        if(this.type === 'smoke') this.vy -= 0.1; // Smoke rises
    }
    draw(ctx) {
        ctx.globalAlpha = this.life / this.maxLife;
        ctx.fillStyle = this.color;
        const s = (this.type === 'fire') ? Math.random() * 5 + 2 : 3;
        ctx.fillRect(this.x, this.y, s, s);
        ctx.globalAlpha = 1;
    }
}

class FloatingText {
    constructor(x, y, text, color) {
        this.x = x; this.y = y; this.text = text; this.color = color;
        this.life = 60; this.vy = -1;
    }
    update() { this.y += this.vy; this.life--; }
    draw(ctx) {
        ctx.globalAlpha = Math.max(0, this.life / 60);
        ctx.fillStyle = this.color; ctx.font = "bold 16px 'Orbitron'";
        ctx.fillText(this.text, this.x, this.y);
        ctx.globalAlpha = 1;
    }
}

class Bullet {
    constructor(x, y, vx, owner) {
        this.x = x; this.y = y; this.vx = vx;
        this.w = 15; this.h = 5;
        this.owner = owner; // 'player' or 'enemy'
        this.dead = false;
        
        // 4. Backfire Rocket visuals
        if(owner === 'enemy') { 
            this.w = 20; this.h = 10; 
            AudioSys.playTone('rocket');
        }
    }
    update() {
        this.x += this.vx;
        if(this.owner === 'enemy') {
            GAME.spawnParticle(this.x + 20, this.y + 5, '#f00', 2, 10, 'fire');
        }
        if(this.x < -50 || this.x > GAME.W + 50) this.dead = true;
    }
    draw(ctx) {
        if(this.owner === 'player') {
            ctx.fillStyle = '#00f3ff';
            ctx.fillRect(this.x, this.y, this.w, this.h);
        } else {
            // Rocket Visual
            ctx.fillStyle = '#ff0000';
            ctx.beginPath(); ctx.moveTo(this.x, this.y);
            ctx.lineTo(this.x+this.w, this.y+this.h/2);
            ctx.lineTo(this.x, this.y+this.h); ctx.fill();
        }
    }
}

class Player {
    constructor() {
        this.w = 40; this.h = 50;
        this.x = 100; this.y = 0;
        this.vx = 0; this.vy = 0;
        this.hp = 3; 
        this.fuel = 100; this.maxFuel = 100;
        this.ammo = 12; this.maxAmmo = 12;
        this.reloadTimer = 0;
        this.grounded = false;
        this.invuln = 0;
    }
    
    update() {
        // Horizontal Movement
        if(Input.keys.Left) this.vx = -6;
        else if(Input.keys.Right) this.vx = 6;
        else this.vx *= 0.8;
        
        this.x += this.vx;
        this.x = Math.max(0, Math.min(GAME.W - this.w, this.x));
        
        // 2. JETPACK PHYSICS (Hovering)
        // If holding UP and has fuel, apply upward force
        if(Input.keys.Up && this.fuel > 0) {
            this.vy -= 0.8; // Thrust
            this.fuel -= 1.2; // Consumption
            this.grounded = false;
            // Particles
            GAME.spawnParticle(this.x + 10, this.y + 40, '#00f3ff', 4, 15, 'smoke');
            GAME.spawnParticle(this.x + 30, this.y + 40, '#00f3ff', 4, 15, 'smoke');
        } else if (this.grounded && this.fuel < this.maxFuel) {
            this.fuel += 0.8; // Refuel on ground
        }
        
        // Gravity
        this.vy += GAME.Gravity;
        this.y += this.vy;
        
        // Ground Collision
        if(this.y + this.h > GAME.GroundY) {
            this.y = GAME.GroundY - this.h;
            this.vy = 0;
            this.grounded = true;
        } else {
            this.grounded = false;
        }
        
        // 3. AUTO RELOAD
        if(this.ammo < this.maxAmmo) {
            this.reloadTimer++;
            if(this.reloadTimer > 45) { // ~0.75 seconds
                this.ammo++;
                this.reloadTimer = 0;
            }
        }
        
        if(this.invuln > 0) this.invuln--;
        this.updateHUD();
    }
    
    jump() {
        if(this.grounded) {
            this.vy = -14;
            this.grounded = false;
            AudioSys.playTone('jump');
            GAME.spawnParticle(this.x+20, this.y+50, '#fff', 5, 20, 'dust');
        }
    }
    
    shoot() {
        if(this.ammo > 0) {
            this.ammo--;
            this.reloadTimer = 0; // Reset reload delay
            GAME.bullets.push(new Bullet(this.x + 40, this.y + 15, 15, 'player'));
            AudioSys.playTone('shoot');
        } else {
            // Click empty sound?
        }
    }
    
    hit(dmg) {
        if(this.invuln > 0) return;
        this.hp -= dmg;
        this.invuln = 60;
        AudioSys.playTone('explosion');
        GAME.shake = 10;
        GAME.texts.push(new FloatingText(this.x, this.y, "-1 HP", "#f00"));
        if(this.hp <= 0) GAME.gameOver();
    }
    
    updateHUD() {
        document.getElementById('hud-hp').innerText = "‚ù§".repeat(Math.max(0, this.hp));
        document.getElementById('hud-score').innerText = GAME.score;
        document.getElementById('hud-ammo-txt').innerText = `${this.ammo}/${this.maxAmmo}`;
        document.getElementById('hud-ammo-bar').style.width = (this.ammo/this.maxAmmo*100) + "%";
        document.getElementById('hud-fuel-bar').style.width = Math.max(0, this.fuel) + "%";
    }
    
    draw(ctx) {
        if(this.invuln > 0 && Math.floor(Date.now()/50)%2===0) return;
        
        // Character Body
        ctx.fillStyle = '#fff';
        ctx.fillRect(this.x, this.y, this.w, this.h);
        
        // Visor
        ctx.fillStyle = '#333';
        ctx.fillRect(this.x + 20, this.y + 10, 20, 10);
        
        // Jetpack
        ctx.fillStyle = '#555';
        ctx.fillRect(this.x - 5, this.y + 10, 10, 30);
        if(this.fuel < 20) { ctx.fillStyle = '#f00'; ctx.fillRect(this.x-2, this.y+12, 4, 4); }
    }
}

class Enemy {
    constructor(type) {
        this.type = type;
        this.dead = false;
        this.x = GAME.W + 50;
        this.w = 40; this.h = 40;
        this.vx = -3 - (GAME.level * 0.5);
        this.hp = 1;
        this.timer = 0;
        
        // 1. & 4. & 5. ENEMY TYPES CONFIG
        switch(type) {
            case 'dragon': // 1. Red Dragon (Boss-like)
                this.y = 50 + Math.random() * 200;
                this.w = 100; this.h = 60;
                this.hp = 6; // Double power/Health
                this.vx = -4;
                break;
                
            case 'traitor': // 4. Backfire enemy
                this.y = GAME.GroundY - 50;
                this.w = 40; this.h = 50;
                this.hp = 2;
                this.hasFired = false;
                break;
                
            case 'ufo': // 5. Vertical Aliens
                this.y = 100;
                this.w = 50; this.h = 30;
                this.baseY = this.y;
                break;
                
            case 'tnt': // 5. TNT Bombs
                this.y = GAME.GroundY - 30;
                this.w = 30; this.h = 30;
                this.vx = -7; // Fast
                break;
                
            default: // Basic
                this.y = GAME.GroundY - 40;
                break;
        }
    }
    
    update() {
        this.x += this.vx;
        this.timer++;
        
        // Specific Behaviors
        if(this.type === 'dragon') {
            // Flying Sine Wave
            this.y += Math.sin(this.timer * 0.05) * 2;
        } 
        else if (this.type === 'ufo') {
            // Vertical movement
            this.y += Math.sin(this.timer * 0.1) * 4;
            if(this.timer % 100 === 0) { /* Alien Shoot logic could go here */ }
        }
        else if (this.type === 'traitor') {
            // 4. Backfire Logic: Fire rocket when player is in range
            if(!this.hasFired && this.x < GAME.W - 100) {
                GAME.bullets.push(new Bullet(this.x, this.y + 20, -10, 'enemy'));
                this.hasFired = true;
                GAME.texts.push(new FloatingText(this.x, this.y - 20, "!", "#f00"));
            }
        }
        
        if(this.x < -150) this.dead = true;
        
        // Player Collision
        if(this.rectIntersect(GAME.player)) {
            GAME.player.hit(1);
            if(this.type === 'tnt') { 
                this.dead = true; // Explode on impact
                GAME.spawnParticle(this.x, this.y, '#f00', 10, 20, 'fire');
            }
        }
    }
    
    takeDamage() {
        this.hp--;
        GAME.spawnParticle(this.x + this.w/2, this.y + this.h/2, '#fff', 3, 5);
        if(this.hp <= 0) {
            this.dead = true;
            GAME.score += (this.type==='dragon'?500 : 100);
            GAME.spawnParticle(this.x, this.y, this.type==='tnt'?'#f00':'#ffcc00', 15, 30, 'fire');
            AudioSys.playTone('explosion');
            GAME.texts.push(new FloatingText(this.x, this.y, "+" + (this.type==='dragon'?500:100), "#ff0"));
        } else {
            GAME.texts.push(new FloatingText(this.x, this.y, "HIT", "#fff"));
        }
    }
    
    rectIntersect(p) {
        return (this.x < p.x + p.w && this.x + this.w > p.x &&
                this.y < p.y + p.h && this.y + this.h > p.y);
    }
    
    draw(ctx) {
        if(this.type === 'dragon') {
            ctx.fillStyle = '#8b0000';
            // Dragon Body
            ctx.beginPath(); ctx.ellipse(this.x+50, this.y+30, 50, 25, 0, 0, Math.PI*2); ctx.fill();
            // Wing
            ctx.fillStyle = '#ff0000';
            ctx.beginPath(); ctx.moveTo(this.x+50, this.y+10); ctx.lineTo(this.x+20, this.y-40); ctx.lineTo(this.x+80, this.y+10); ctx.fill();
            // Head
            ctx.fillStyle = '#000'; ctx.fillRect(this.x, this.y+15, 10, 10);
        }
        else if(this.type === 'ufo') {
            ctx.fillStyle = '#0f0';
            ctx.beginPath(); ctx.arc(this.x+25, this.y+15, 15, Math.PI, 0); ctx.fill();
            ctx.fillStyle = '#888';
            ctx.beginPath(); ctx.ellipse(this.x+25, this.y+20, 25, 8, 0, 0, Math.PI*2); ctx.fill();
        }
        else if(this.type === 'tnt') {
            ctx.fillStyle = '#000';
            ctx.beginPath(); ctx.arc(this.x+15, this.y+15, 15, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#f00'; ctx.font="10px Arial"; ctx.fillText("TNT", this.x+5, this.y+20);
        }
        else if(this.type === 'traitor') {
            ctx.fillStyle = '#444'; ctx.fillRect(this.x, this.y, this.w, this.h);
            ctx.fillStyle = '#ff0'; ctx.fillRect(this.x+10, this.y+10, 20, 20); // Yellow Core
        }
        else {
            ctx.fillStyle = '#c0c'; ctx.fillRect(this.x, this.y, this.w, this.h);
        }
        
        // HP Bar for bosses
        if(this.hp > 1) {
            ctx.fillStyle = 'red';
            ctx.fillRect(this.x, this.y - 10, this.w * (this.hp/6), 4);
        }
    }
}

/* --- MAIN GAME ENGINE --- */
const GAME = {
    canvas: document.getElementById('cvs'),
    ctx: document.getElementById('cvs').getContext('2d'),
    W: 1024, H: 576,
    GroundY: 576 - 80,
    Gravity: 0.6,
    
    active: false,
    level: 1,
    score: 0,
    frames: 0,
    shake: 0,
    
    player: null,
    entities: [],
    bullets: [],
    particles: [],
    texts: [],
    bgLayers: [],
    
    // Themes
    themeIdx: 0,
    themes: [
        { sky:['#87CEEB','#E0F7FA'], ground:'#228B22' }, // Earth
        { sky:['#4a0e0e','#1a0505'], ground:'#8B4513' }, // Mars
        { sky:['#000','#001'], ground:'#333' }           // Space
    ],

    init: function() {
        this.resize();
        window.addEventListener('resize', () => this.resize());
        Input.init();
        AudioSys.init();
        
        // Background Stars
        for(let i=0; i<50; i++) {
            this.bgLayers.push({
                x: Math.random()*this.W, y: Math.random()*this.H,
                size: Math.random()*2, speed: Math.random()*0.5 + 0.1
            });
        }
    },
    
    resize: function() {
        // Fit to container while maintaining aspect ratio approach if needed
        this.canvas.width = this.W;
        this.canvas.height = this.H;
    },
    
    start: function(isMobile) {
        this.active = true;
        this.score = 0;
        this.frames = 0;
        this.player = new Player();
        this.entities = [];
        this.bullets = [];
        this.particles = [];
        this.texts = [];
        this.level = 1;
        
        document.getElementById('menu-overlay').classList.add('hidden');
        if(isMobile) document.getElementById('mobile-controls').style.display = 'block';
        
        AudioSys.init();
        this.loop();
    },
    
    spawnParticle: function(x, y, c, s, l, t) {
        this.particles.push(new Particle(x, y, c, s, l, t));
    },
    
    update: function() {
        this.frames++;
        
        // Spawning Logic
        let spawnRate = Math.max(30, 100 - (this.level * 5));
        if(this.frames % spawnRate === 0) {
            let r = Math.random();
            if(r < 0.15) this.entities.push(new Enemy('dragon'));
            else if(r < 0.3) this.entities.push(new Enemy('ufo'));
            else if(r < 0.5) this.entities.push(new Enemy('traitor'));
            else if(r < 0.7) this.entities.push(new Enemy('tnt'));
            else this.entities.push(new Enemy('basic'));
        }
        
        // Level Up
        if(this.score > this.level * 1000) {
            this.level++;
            this.texts.push(new FloatingText(this.W/2, this.H/2, "LEVEL UP!", "#00f3ff"));
        }
        
        this.player.update();
        
        // Entity Update
        this.entities.forEach(e => e.update());
        this.entities = this.entities.filter(e => !e.dead);
        
        // Bullet Update
        this.bullets.forEach(b => {
            b.update();
            // Bullet Collision
            if(b.owner === 'player') {
                this.entities.forEach(e => {
                    if(!b.dead && !e.dead && e.rectIntersect(b)) {
                        b.dead = true;
                        e.takeDamage();
                    }
                });
            } else if (b.owner === 'enemy') {
                // Rocket hits player
                if(!b.dead && b.x < this.player.x + this.player.w && b.x + b.w > this.player.x &&
                   b.y < this.player.y + this.player.h && b.y + b.h > this.player.y) {
                    b.dead = true;
                    this.player.hit(1);
                }
            }
        });
        this.bullets = this.bullets.filter(b => !b.dead);
        
        // Particles
        this.particles.forEach(p => p.update());
        this.particles = this.particles.filter(p => p.life > 0);
        
        // Texts
        this.texts.forEach(t => t.update());
        this.texts = this.texts.filter(t => t.life > 0);
        
        // Screen Shake Decay
        if(this.shake > 0) this.shake *= 0.9;
        if(this.shake < 0.5) this.shake = 0;
    },
    
    draw: function() {
        // Clear
        this.ctx.fillStyle = '#000';
        this.ctx.fillRect(0, 0, this.W, this.H);
        
        // Shake
        this.ctx.save();
        if(this.shake > 0) {
            let dx = (Math.random()-0.5)*this.shake;
            let dy = (Math.random()-0.5)*this.shake;
            this.ctx.translate(dx, dy);
        }
        
        // Background
        let t = this.themes[this.themeIdx];
        let grad = this.ctx.createLinearGradient(0,0,0,this.H);
        grad.addColorStop(0, t.sky[0]); grad.addColorStop(1, t.sky[1]);
        this.ctx.fillStyle = grad; this.ctx.fillRect(0,0,this.W,this.H);
        
        // Stars
        this.ctx.fillStyle = "#fff";
        this.bgLayers.forEach(star => {
            star.x -= star.speed;
            if(star.x < 0) star.x = this.W;
            this.ctx.fillRect(star.x, star.y, star.size, star.size);
        });
        
        // Mars Moons (Background Decoration)
        if(this.themeIdx === 1) {
             this.ctx.fillStyle = 'rgba(200,100,100,0.5)';
             this.ctx.beginPath(); this.ctx.arc(this.W - (this.frames*0.1)%this.W, 100, 30, 0, Math.PI*2); this.ctx.fill();
        }

        // Ground
        this.ctx.fillStyle = t.ground;
        this.ctx.fillRect(0, this.GroundY, this.W, this.H - this.GroundY);
        
        // Draw Objects
        this.entities.forEach(e => e.draw(this.ctx));
        this.bullets.forEach(b => b.draw(this.ctx));
        this.particles.forEach(p => p.draw(this.ctx));
        this.player.draw(this.ctx);
        this.texts.forEach(t => t.draw(this.ctx));
        
        this.ctx.restore();
    },
    
    loop: function() {
        if(!this.active) return;
        requestAnimationFrame(() => this.loop());
        this.update();
        this.draw();
    },
    
    gameOver: function() {
        this.active = false;
        document.getElementById('menu-overlay').classList.remove('hidden');
        document.querySelector('h1').innerText = "GAME OVER";
        document.querySelector('.menu-panel p').innerText = "SCORE: " + this.score;
        document.getElementById('mobile-controls').style.display = 'none';
    }
};

// Initialize Game logic
GAME.init();

</script>
</body>
</html>
