<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Omniverse: Ultimate Edition</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéÆ</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Orbitron:wght@500;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
    :root { 
        --primary: #00f3ff; 
        --danger: #ff0044; 
        --warn: #ffcc00; 
        --bg: #050505;
        --hud-bg: rgba(0, 20, 40, 0.85);
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
        margin: 0; overflow: hidden; background: var(--bg);
        font-family: 'Orbitron', sans-serif;
        display: flex; justify-content: center; align-items: center; 
        height: 100vh; height: 100svh;
        user-select: none; touch-action: none;
    }

    /* GAME CONTAINER */
    #game-container {
        position: relative; 
        width: 100%; height: 100%; 
        max-width: 1280px; max-height: 720px;
        background: #000; 
        box-shadow: 0 0 100px rgba(0, 243, 255, 0.15);
        overflow: hidden;
    }
    
    canvas { display: block; width: 100%; height: 100%; image-rendering: auto; }

    /* HUD */
    #ui-layer {
        position: absolute; inset: 0; pointer-events: none; padding: 15px;
        display: flex; flex-direction: column; justify-content: space-between; z-index: 10;
    }
    .hud-top { display: flex; justify-content: space-between; width: 100%; }
    .stat-panel {
        background: var(--hud-bg); 
        border: 1px solid rgba(255,255,255,0.2);
        padding: 10px 15px; border-radius: 6px;
        backdrop-filter: blur(4px); min-width: 140px;
    }
    .hp-container { font-size: 1.5rem; letter-spacing: 2px; color: var(--danger); text-shadow: 0 0 10px var(--danger); margin-bottom: 5px; }
    .score-txt { font-size: 1rem; color: #fff; font-family: 'Share Tech Mono'; }
    .bar-label { font-size: 0.7rem; color: #aaa; margin-top: 5px; display: flex; justify-content: space-between; }
    .progress-track { width: 100%; height: 6px; background: #222; border: 1px solid #444; margin-top: 2px; border-radius: 2px; overflow: hidden; }
    .progress-fill { height: 100%; width: 100%; transition: width 0.1s linear; }

    /* MOBILE CONTROLS */
    #mobile-controls {
        position: absolute; inset: 0; pointer-events: auto; z-index: 20; display: none;
    }
    
    /* Swipe Area */
    #swipe-zone {
        position: absolute; left: 0; top: 0; width: 50%; height: 100%;
        /* background: rgba(255,0,0,0.1); Debugging */
    }
    #swipe-hint {
        position: absolute; bottom: 50px; left: 50px; 
        color: rgba(255,255,255,0.3); font-size: 14px; pointer-events: none;
    }

    /* Buttons (Only Fire and Jump) */
    .control-cluster { position: absolute; bottom: 40px; right: 40px; display: flex; gap: 20px; align-items: flex-end; pointer-events: auto; }
    
    .btn {
        width: 80px; height: 80px; border-radius: 50%;
        background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255,255,255,0.3);
        color: white; font-size: 30px; display: flex; justify-content: center; align-items: center;
        backdrop-filter: blur(5px); box-shadow: 0 4px 15px rgba(0,0,0,0.6);
        transition: transform 0.1s; touch-action: none;
    }
    .btn:active { transform: scale(0.9); background: rgba(0, 243, 255, 0.3); border-color: var(--primary); }
    .btn-fire { border-color: var(--danger); color: var(--danger); width: 85px; height: 85px; margin-bottom: 10px; }
    .btn-jump { border-color: var(--primary); color: var(--primary); width: 100px; height: 100px; font-size: 40px; }

    /* MENUS */
    #menu-overlay {
        position: absolute; inset: 0; background: rgba(0,0,0,0.95);
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        z-index: 100; text-align: center;
    }
    h1 {
        font-family: 'Black Ops One'; font-size: 3.5rem; margin: 0;
        background: linear-gradient(180deg, #fff, #888);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        filter: drop-shadow(0 0 20px var(--primary));
    }
    .menu-panel {
        border: 1px solid var(--primary); padding: 30px;
        background: rgba(0, 20, 20, 0.8);
        box-shadow: 0 0 50px rgba(0,243,255,0.1); max-width: 90%;
    }
    .start-btn {
        display: block; width: 100%; margin: 10px 0;
        padding: 15px; font-family: 'Orbitron'; font-size: 1.2rem; font-weight: 900;
        background: var(--danger); border: none; color: white;
        cursor: pointer; clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
    }
    .btn-mobile { background: var(--warn); color: #000; }
    .hidden { display: none !important; }
    
    @media (orientation: portrait) {
        #menu-overlay::before { content: "‚ö†Ô∏è ROTATE DEVICE"; display: block; margin-bottom: 20px; color: var(--warn); }
    }
</style>
</head>
<body>

<div id="game-container">
    <canvas id="cvs"></canvas>

    <div id="ui-layer">
        <div class="hud-top">
            <div class="stat-panel">
                <div class="hp-container" id="hud-hp">‚ù§‚ù§‚ù§</div>
                <div class="score-txt">SCORE: <span style="color:var(--primary)" id="hud-score">0</span></div>
            </div>
            <div class="stat-panel" style="text-align: right;">
                <div class="bar-label"><span>PLASMA</span> <span id="hud-ammo-txt">12</span></div>
                <div class="progress-track"><div class="progress-fill" id="hud-ammo-bar" style="background:var(--warn)"></div></div>
                <div class="bar-label"><span>JET FUEL</span></div>
                <div class="progress-track"><div class="progress-fill" id="hud-fuel-bar" style="background:var(--primary)"></div></div>
            </div>
        </div>
    </div>

    <div id="mobile-controls">
        <div id="swipe-zone"></div>
        <div id="swipe-hint">SWIPE TO MOVE ‚Üî</div>
        <div class="control-cluster">
            <div class="btn btn-fire" id="btn-fire">üî•</div>
            <div class="btn btn-jump" id="btn-jump">üöÄ</div>
        </div>
    </div>

    <div id="menu-overlay">
        <div class="menu-panel">
            <h1>OMNIVERSE</h1>
            <p style="color:var(--primary); font-size: 0.9rem; letter-spacing: 4px; margin-bottom: 30px;">ULTIMATE EDITION</p>
            <button class="start-btn" onclick="GAME.start(false)">PLAY PC</button>
            <button class="start-btn btn-mobile" onclick="GAME.start(true)">PLAY MOBILE</button>
            <div style="color:#666; font-size: 0.8rem; margin-top:15px;">
                PC: ARROWS + SPACE + F<br>
                MOBILE: SWIPE LEFT/RIGHT + BUTTONS
            </div>
        </div>
    </div>
</div>

<script>
/** SYSTEM: AUDIO */
const AudioSys = {
    ctx: null,
    init: function() {
        if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        if(this.ctx.state === 'suspended') this.ctx.resume();
    },
    play: function(type) {
        if(!this.ctx) return;
        const t = this.ctx.currentTime;
        const o = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        o.connect(g); g.connect(this.ctx.destination);
        
        if(type==='shoot') {
            o.type='square'; o.frequency.setValueAtTime(400,t); o.frequency.exponentialRampToValueAtTime(100,t+0.1);
            g.gain.setValueAtTime(0.05,t); g.gain.linearRampToValueAtTime(0,t+0.1);
            o.start(t); o.stop(t+0.1);
        } else if(type==='jump') {
            o.type='sine'; o.frequency.setValueAtTime(200,t); o.frequency.linearRampToValueAtTime(400,t+0.15);
            g.gain.setValueAtTime(0.1,t); g.gain.linearRampToValueAtTime(0,t+0.15);
            o.start(t); o.stop(t+0.15);
        } else if(type==='explosion') {
            o.type='sawtooth'; o.frequency.setValueAtTime(100,t); o.frequency.exponentialRampToValueAtTime(10,t+0.3);
            g.gain.setValueAtTime(0.2,t); g.gain.linearRampToValueAtTime(0,t+0.3);
            o.start(t); o.stop(t+0.3);
        }
    }
};

/** SYSTEM: INPUT (Keyboard + Swipe + Buttons) */
const Input = {
    keys: { Left: false, Right: false, Jump: false, Fire: false },
    touchStartX: 0,
    
    init: function() {
        window.addEventListener('keydown', e => this.key(e.code, true));
        window.addEventListener('keyup', e => this.key(e.code, false));
        
        // Buttons
        this.bindBtn('btn-fire', 'Fire');
        this.bindBtn('btn-jump', 'Jump');
        
        // Swipe Logic
        const zone = document.getElementById('swipe-zone');
        zone.addEventListener('touchstart', e => {
            e.preventDefault();
            this.touchStartX = e.touches[0].clientX;
        }, {passive:false});
        
        zone.addEventListener('touchmove', e => {
            e.preventDefault();
            const diff = e.touches[0].clientX - this.touchStartX;
            if(diff < -20) { this.keys.Left = true; this.keys.Right = false; }
            else if(diff > 20) { this.keys.Right = true; this.keys.Left = false; }
            else { this.keys.Left = false; this.keys.Right = false; }
        }, {passive:false});
        
        zone.addEventListener('touchend', e => {
            e.preventDefault();
            this.keys.Left = false; this.keys.Right = false;
        }, {passive:false});
    },
    
    key: function(c, s) {
        if(c==='ArrowLeft') this.keys.Left = s;
        if(c==='ArrowRight') this.keys.Right = s;
        if(c==='Space' || c==='ArrowUp') this.keys.Jump = s; // Map Space/Up to Jump logic
        if(c==='KeyF') { if(s && !this.keys.Fire) GAME.player.shoot(); this.keys.Fire = s; }
    },
    
    bindBtn: function(id, k) {
        const el = document.getElementById(id);
        el.addEventListener('touchstart', e => { 
            e.preventDefault(); 
            this.keys[k] = true; 
            if(k==='Jump') GAME.player.tapJump(); // Tap logic
            if(k==='Fire') GAME.player.shoot();
        }, {passive:false});
        el.addEventListener('touchend', e => { e.preventDefault(); this.keys[k] = false; }, {passive:false});
    }
};

/** ENTITIES */
class Particle {
    constructor(x,y,c,s,l) { this.x=x;this.y=y;this.c=c;this.vx=(Math.random()-.5)*s;this.vy=(Math.random()-.5)*s;this.l=l;this.ml=l; }
    update() { this.x+=this.vx; this.y+=this.vy; this.l--; }
    draw(ctx) { ctx.globalAlpha=this.l/this.ml; ctx.fillStyle=this.c; ctx.fillRect(this.x,this.y,3,3); ctx.globalAlpha=1; }
}

class FloatingText {
    constructor(x,y,t,c) { this.x=x;this.y=y;this.t=t;this.c=c;this.l=60; }
    update() { this.y-=1; this.l--; }
    draw(ctx) { ctx.globalAlpha=this.l/60; ctx.fillStyle=this.c; ctx.font="bold 16px 'Orbitron'"; ctx.fillText(this.t,this.x,this.y); ctx.globalAlpha=1; }
}

class ParallaxObject {
    constructor(type, y) {
        this.type = type;
        this.x = GAME.W + 100;
        this.y = y;
        this.dead = false;
    }
    update() {
        this.x -= 2; // Slower than ground
        if(this.x < -400) this.dead = true;
    }
    draw(ctx) {
        ctx.save(); ctx.translate(this.x, this.y);
        if(this.type === 'hollywood') {
            // Earth Theme: Hollywood Sign
            ctx.fillStyle = "#fff"; ctx.font = "900 60px Arial"; 
            ctx.shadowColor="black"; ctx.shadowBlur=10;
            ctx.fillText("ABHIK DUTTA", 0, 0);
            ctx.fillStyle="#555"; ctx.fillRect(0, 10, 450, 10); // Base
        } else if (this.type === 'rocket') {
            // Mars Theme: Rocket
            ctx.rotate(-0.5);
            ctx.fillStyle = "#ccc"; ctx.fillRect(0,0,100,30); // Body
            ctx.fillStyle = "red"; ctx.beginPath(); ctx.moveTo(100,0); ctx.lineTo(130,15); ctx.lineTo(100,30); ctx.fill(); // Nose
            ctx.fillStyle = "#00f3ff"; ctx.fillText("ABHIK", 10, 22);
            // Flames
            ctx.fillStyle = "orange"; ctx.beginPath(); ctx.moveTo(0,5); ctx.lineTo(-40,15); ctx.lineTo(0,25); ctx.fill();
        } else if (this.type === 'shuttle') {
            // Space/Matrix Theme
            ctx.fillStyle = "#222"; ctx.fillRect(0,0,120,40);
            ctx.fillStyle = "#0f0"; ctx.font="20px monospace"; ctx.fillText("ALIEN_SHIP_01", 5, 25);
            ctx.strokeStyle = "#0f0"; ctx.strokeRect(0,0,120,40);
        } else if (this.type === 'billboard') {
            // Neon Theme
            ctx.fillStyle = "#000"; ctx.fillRect(0,0,300,80);
            ctx.strokeStyle = "#f0f"; ctx.lineWidth=4; ctx.strokeRect(0,0,300,80);
            ctx.fillStyle = "#0ff"; ctx.font="30px Orbitron"; ctx.fillText("ABHIK DUTTA", 20, 50);
        }
        ctx.restore();
    }
}

class Bullet {
    constructor(x,y,vx,o) { this.x=x;this.y=y;this.vx=vx;this.o=o;this.dead=false; this.w=15; this.h=5; }
    update() { 
        this.x+=this.vx; if(this.x<-50||this.x>GAME.W+50) this.dead=true; 
        if(this.o==='enemy') GAME.spawnPart(this.x+20,this.y+5,'#f00',1,5);
    }
    draw(ctx) { 
        ctx.fillStyle = this.o==='player'?'#0ff':'#f00'; 
        if(this.o==='enemy') { ctx.beginPath(); ctx.moveTo(this.x,this.y); ctx.lineTo(this.x+20,this.y+5); ctx.lineTo(this.x,this.y+10); ctx.fill(); }
        else ctx.fillRect(this.x,this.y,this.w,this.h); 
    }
}

class Player {
    constructor() {
        this.x=100; this.y=0; this.w=40; this.h=50; this.vx=0; this.vy=0;
        this.hp=3; this.fuel=100; this.ammo=12; this.jumpCount=0; this.grounded=false; this.invuln=0;
        this.reloadTimer=0;
    }
    update() {
        // Move
        if(Input.keys.Left) this.vx = -6; else if(Input.keys.Right) this.vx = 6; else this.vx *= 0.8;
        this.x = Math.max(0, Math.min(GAME.W-this.w, this.x+this.vx));
        
        // Jetpack (Hold Jump)
        // If holding Jump AND in air AND fuel > 0 -> Jetpack
        // (Assuming jump key is held)
        if(Input.keys.Jump && !this.grounded && this.fuel>0) {
            this.vy -= 0.8; this.fuel -= 1.5;
            GAME.spawnPart(this.x+10, this.y+45, '#0ff', 2, 10);
        } else if(this.grounded && this.fuel<100) this.fuel += 0.8;

        // Gravity
        this.vy += GAME.Gravity; this.y += this.vy;
        if(this.y+this.h > GAME.GroundY) { this.y=GAME.GroundY-this.h; this.vy=0; this.grounded=true; this.jumpCount=0; } 
        else this.grounded=false;

        // Auto Reload
        if(this.ammo < 12) {
            this.reloadTimer++;
            if(this.reloadTimer > 45) { this.ammo++; this.reloadTimer=0; }
        }
        if(this.invuln>0) this.invuln--;
        this.hud();
    }
    
    // Triggered on KeyDown/TouchStart
    tapJump() {
        // Double Jump Logic (No fuel cost for impulse)
        if(this.grounded || this.jumpCount < 2) {
            this.vy = -13; 
            this.jumpCount++;
            this.grounded = false;
            AudioSys.play('jump');
            GAME.spawnPart(this.x+20, this.y+50, '#fff', 5, 20);
        }
    }

    shoot() {
        if(this.ammo>0) {
            this.ammo--; this.reloadTimer=0;
            GAME.bullets.push(new Bullet(this.x+40, this.y+15, 15, 'player'));
            AudioSys.play('shoot');
        }
    }
    
    hit(d) {
        if(this.invuln>0) return;
        this.hp-=d; this.invuln=60; GAME.shake=10; AudioSys.play('explosion');
        if(this.hp<=0) GAME.over();
    }
    
    hud() {
        document.getElementById('hud-hp').innerText="‚ù§".repeat(Math.max(0,this.hp));
        document.getElementById('hud-score').innerText=GAME.score;
        document.getElementById('hud-ammo-bar').style.width=(this.ammo/12*100)+"%";
        document.getElementById('hud-fuel-bar').style.width=this.fuel+"%";
        document.getElementById('hud-ammo-txt').innerText=this.ammo;
    }
    
    draw(ctx) {
        if(this.invuln>0 && Math.floor(GAME.frames/5)%2) return;
        ctx.fillStyle='#fff'; ctx.fillRect(this.x, this.y, this.w, this.h); // Body
        ctx.fillStyle='#333'; ctx.fillRect(this.x+20, this.y+10, 20, 10); // Visor
        // LEGS (Fix 2: clearly visible)
        ctx.fillStyle='#999'; 
        let ly = this.grounded ? 0 : 5;
        ctx.fillRect(this.x+5, this.y+40, 10, 10+ly); 
        ctx.fillRect(this.x+25, this.y+40, 10, 10-ly);
    }
}

class Enemy {
    constructor(t) {
        this.t=t; this.dead=false; this.x=GAME.W+50; this.w=40; this.h=40; this.hp=1; this.tm=0;
        if(t==='dragon') { this.y=50+Math.random()*150; this.w=100; this.h=60; this.hp=6; }
        else if(t==='traitor') { this.y=GAME.GroundY-50; this.h=50; this.hp=2; this.fired=false; }
        else if(t==='ufo') { this.y=100; this.w=50; this.h=30; }
        else if(t==='tnt') { this.y=GAME.GroundY-30; this.w=30; this.h=30; }
        else this.y=GAME.GroundY-40;
    }
    update() {
        this.x -= (3 + GAME.level*0.5); this.tm++;
        if(this.t==='dragon') this.y += Math.sin(this.tm*0.05)*2;
        if(this.t==='ufo') this.y += Math.sin(this.tm*0.1)*4;
        
        // Traitor Logic
        if(this.t==='traitor' && !this.fired && this.x < GAME.W-150) {
            GAME.bullets.push(new Bullet(this.x, this.y+20, -9, 'enemy')); this.fired=true;
            GAME.texts.push(new FloatingText(this.x,this.y-20,"!", "#f00"));
        }
        
        if(this.x<-150) this.dead=true;
        
        // Player Collision
        if(!this.dead && this.hit(GAME.player)) {
            GAME.player.hit(1);
            if(this.t==='tnt') { this.dead=true; GAME.spawnPart(this.x,this.y,'#f00',20,30); }
        }
    }
    
    // TNT FIX: "Burst from distance" means bullet destroys it safely
    takeDmg() {
        this.hp--; GAME.spawnPart(this.x+20,this.y+20,'#fff',3,5);
        if(this.hp<=0) {
            this.dead=true; GAME.score += (this.t==='dragon'?500:100);
            GAME.spawnPart(this.x,this.y,this.t==='tnt'?'#f00':'#fc0', 20, 20);
            AudioSys.play('explosion');
        }
    }
    
    hit(p) { return this.x < p.x+p.w && this.x+this.w > p.x && this.y < p.y+p.h && this.y+this.h > p.y; }
    
    draw(ctx) {
        if(this.t==='dragon') { // FIX 4: Wings
            ctx.fillStyle='#800'; ctx.beginPath(); ctx.ellipse(this.x+50,this.y+30,50,25,0,0,Math.PI*2); ctx.fill();
            ctx.fillStyle='#f00'; ctx.beginPath(); ctx.moveTo(this.x+50,this.y+10); ctx.lineTo(this.x+30,this.y-50); ctx.lineTo(this.x+90,this.y+10); ctx.fill();
            ctx.fillStyle='#000'; ctx.fillRect(this.x,this.y+20,10,10);
        } else if(this.t==='tnt') {
            ctx.fillStyle='#000'; ctx.beginPath(); ctx.arc(this.x+15,this.y+15,15,0,Math.PI*2); ctx.fill();
            ctx.fillStyle='#f00'; ctx.font="10px Arial"; ctx.fillText("TNT",this.x+5,this.y+20);
        } else if(this.t==='ufo') {
            ctx.fillStyle='#0f0'; ctx.beginPath(); ctx.arc(this.x+25,this.y+15,15,Math.PI,0); ctx.fill();
            ctx.fillStyle='#555'; ctx.beginPath(); ctx.ellipse(this.x+25,this.y+20,25,8,0,0,Math.PI*2); ctx.fill();
        } else if(this.t==='traitor') {
            ctx.fillStyle='#444'; ctx.fillRect(this.x,this.y,this.w,this.h);
            ctx.fillStyle='#ff0'; ctx.fillRect(this.x+10,this.y+10,20,20);
        } else {
            ctx.fillStyle='#c0c'; ctx.fillRect(this.x,this.y,this.w,this.h);
        }
        if(this.hp>1) { ctx.fillStyle='red'; ctx.fillRect(this.x,this.y-10,this.w*(this.hp/6),4); }
    }
}

/** ENGINE */
const GAME = {
    cvs: document.getElementById('cvs'), ctx: document.getElementById('cvs').getContext('2d'),
    W: 1024, H: 576, GroundY: 576-80, Gravity: 0.6,
    active: false, frames: 0, score: 0, level: 1, shake: 0,
    player: null, ents: [], bulls: [], parts: [], txts: [], bg: [], parallax: [],
    
    // FIX 5: 4 Themes with Branding Objects
    themes: [
        {id:'earth', sky:['#87CEEB','#E0F7FA'], g:'#228B22', obj:'hollywood'},
        {id:'mars',  sky:['#4a0e0e','#1a0505'], g:'#8B4513', obj:'rocket'},
        {id:'matrix',sky:['#000','#001'],       g:'#003300', obj:'shuttle'},
        {id:'neon',  sky:['#2c003e','#000'],    g:'#ff00ff', obj:'billboard'}
    ],
    themeIdx: 0,

    init: function() {
        this.resize(); window.addEventListener('resize', ()=>this.resize());
        Input.init(); 
        // Logic for Jump Key:
        // KeyDown -> Input.keys.Jump=true -> Tap logic handled in Player.update via key state? 
        // No, we need distinct tap vs hold. 
        // Input.key maps Space to keys.Jump.
        // We add a listener for immediate jump
        window.addEventListener('keydown', e => { if(e.code==='Space'||e.code==='ArrowUp') this.player.tapJump(); });
    },
    resize: function() { this.cvs.width=this.W; this.cvs.height=this.H; },
    
    start: function(m) {
        this.active=true; this.score=0; this.frames=0; this.level=1;
        this.player = new Player(); this.ents=[]; this.bulls=[]; this.parts=[]; this.txts=[]; this.parallax=[];
        this.bg = Array(50).fill().map(()=>({x:Math.random()*this.W, y:Math.random()*this.H, s:Math.random()*2}));
        document.getElementById('menu-overlay').classList.add('hidden');
        if(m) document.getElementById('mobile-controls').style.display='block';
        AudioSys.init(); this.loop();
    },
    
    spawnPart: function(x,y,c,s,l) { this.parts.push(new Particle(x,y,c,s,l)); },
    
    update: function() {
        this.frames++;
        
        // Theme Cycle (20s @ 60fps = 1200 frames)
        if(this.frames % 1200 === 0) {
            this.themeIdx = (this.themeIdx + 1) % 4;
            this.txts.push(new FloatingText(this.W/2, 200, "THEME SHIFT", "#fff"));
        }
        // Parallax Spawn (Branding)
        if(this.frames % 1200 === 100) {
            this.parallax.push(new ParallaxObject(this.themes[this.themeIdx].obj, 200));
        }
        
        // Spawning
        if(this.frames % Math.max(30, 100-this.level*5) === 0) {
            let r=Math.random();
            if(r<0.15) this.ents.push(new Enemy('dragon'));
            else if(r<0.3) this.ents.push(new Enemy('ufo'));
            else if(r<0.5) this.ents.push(new Enemy('traitor'));
            else if(r<0.7) this.ents.push(new Enemy('tnt'));
            else this.ents.push(new Enemy('basic'));
        }
        if(this.score > this.level*1000) { this.level++; this.txts.push(new FloatingText(this.W/2,300,"LEVEL UP!","#0ff")); }

        this.player.update();
        
        this.ents.forEach(e=>e.update()); this.ents=this.ents.filter(e=>!e.dead);
        this.parallax.forEach(p=>p.update()); this.parallax=this.parallax.filter(p=>!p.dead);
        
        this.bulls.forEach(b => {
            b.update();
            if(b.o==='player') {
                this.ents.forEach(e => { if(!b.dead && !e.dead && e.hit(b)) { b.dead=true; e.takeDmg(); } });
            } else {
                if(!b.dead && this.player.hit(b)) { b.dead=true; this.player.hit(1); }
            }
        });
        this.bulls=this.bulls.filter(b=>!b.dead);
        
        this.parts.forEach(p=>p.update()); this.parts=this.parts.filter(p=>p.l>0);
        this.txts.forEach(t=>t.update()); this.txts=this.txts.filter(t=>t.l>0);
        if(this.shake>0) this.shake*=0.9; if(this.shake<0.5) this.shake=0;
    },
    
    draw: function() {
        this.ctx.fillStyle='#000'; this.ctx.fillRect(0,0,this.W,this.H);
        this.ctx.save();
        if(this.shake>0) this.ctx.translate((Math.random()-.5)*this.shake, (Math.random()-.5)*this.shake);
        
        let t = this.themes[this.themeIdx];
        let g = this.ctx.createLinearGradient(0,0,0,this.H); g.addColorStop(0,t.sky[0]); g.addColorStop(1,t.sky[1]);
        this.ctx.fillStyle=g; this.ctx.fillRect(0,0,this.W,this.H);
        
        this.ctx.fillStyle='#fff'; this.bg.forEach(s=>{ s.x-=0.5; if(s.x<0)s.x=this.W; this.ctx.fillRect(s.x,s.y,s.s,s.s); });
        
        this.parallax.forEach(p=>p.draw(this.ctx));
        
        this.ctx.fillStyle=t.g; this.ctx.fillRect(0,this.GroundY,this.W,this.H-this.GroundY);
        
        this.ents.forEach(e=>e.draw(this.ctx));
        this.bulls.forEach(b=>b.draw(this.ctx));
        this.player.draw(this.ctx);
        this.parts.forEach(p=>p.draw(this.ctx));
        this.txts.forEach(t=>t.draw(this.ctx));
        
        this.ctx.restore();
    },
    
    loop: function() {
        if(!this.active) return;
        requestAnimationFrame(()=>this.loop());
        this.update(); this.draw();
    },
    
    over: function() {
        this.active=false;
        document.getElementById('menu-overlay').classList.remove('hidden');
        document.querySelector('h1').innerText="GAME OVER";
        document.getElementById('mobile-controls').style.display='none';
    }
};
GAME.init();
</script>
</body>
</html>
